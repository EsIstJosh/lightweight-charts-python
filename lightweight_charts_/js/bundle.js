var Lib=function(e,t){"use strict";function i(e){if(void 0===e)throw new Error("Value is undefined");return e}class o{_chart=void 0;_series=void 0;requestUpdate(){this._requestUpdate&&this._requestUpdate()}_requestUpdate;attached({chart:e,series:t,requestUpdate:i}){this._chart=e,this._series=t,this._series.subscribeDataChanged(this._fireDataUpdated),this._requestUpdate=i,this.requestUpdate()}detached(){this._chart=void 0,this._series=void 0,this._requestUpdate=void 0}get chart(){return i(this._chart)}get series(){return i(this._series)}_fireDataUpdated(e){this.dataUpdated&&this.dataUpdated(e)}toJSON(){return{}}fromJSON(e){}}function n(e,t){if(e.startsWith("#"))return function(e,t){if(e=e.replace(/^#/,""),!/^([0-9A-F]{3}){1,2}$/i.test(e))throw new Error("Invalid hex color format.");const[i,o,n]=3===(s=e).length?[parseInt(s[0]+s[0],16),parseInt(s[1]+s[1],16),parseInt(s[2]+s[2],16)]:[parseInt(s.slice(0,2),16),parseInt(s.slice(2,4),16),parseInt(s.slice(4,6),16)];var s;return`rgba(${i}, ${o}, ${n}, ${t})`}(e,t);{const i=/^rgb(a)?\(\s*([\d.]+)\s*,\s*([\d.]+)\s*,\s*([\d.]+)(?:,\s*([\d.]+))?\)/i,o=e.match(i);if(o){const e=o[2],i=o[3],n=o[4],s=o[1]?o[5]??"1":"1";return`rgba(${e}, ${i}, ${n}, ${t??s})`}throw new Error("Unsupported color format. Use hex, rgb, or rgba.")}}function s(e,t=.2){let[i,o,n,s=1]=e.startsWith("#")?[...(a=e,3===(a=a.replace(/^#/,"")).length?[parseInt(a[0]+a[0],16),parseInt(a[1]+a[1],16),parseInt(a[2]+a[2],16)]:[parseInt(a.slice(0,2),16),parseInt(a.slice(2,4),16),parseInt(a.slice(4,6),16)]),1]:e.match(/\d+(\.\d+)?/g).map(Number);var a;return i=Math.max(0,Math.min(255,i*(1-t))),o=Math.max(0,Math.min(255,o*(1-t))),n=Math.max(0,Math.min(255,n*(1-t))),e.startsWith("#")?`#${((1<<24)+(Math.round(i)<<16)+(Math.round(o)<<8)+Math.round(n)).toString(16).slice(1)}`:`rgba(${Math.round(i)}, ${Math.round(o)}, ${Math.round(n)}, ${s})`}class a{numbers;cache;constructor(e){this.numbers=e,this.cache=new Map}findClosestIndex(e,t){const i=`${e}:${t}`;if(this.cache.has(i))return this.cache.get(i);const o=this._performSearch(e,t);return this.cache.set(i,o),o}_performSearch(e,t){let i=0,o=this.numbers.length-1;if(e<=this.numbers[0].time)return 0;if(e>=this.numbers[o].time)return o;for(;i<=o;){const t=Math.floor((i+o)/2),n=this.numbers[t].time;if(n===e)return t;n>e?o=t-1:i=t+1}return"left"===t?i:o}}var r;function l(e){switch(e.trim().toLowerCase()){case"rectangle":return r.Rectangle;case"rounded":return r.Rounded;case"ellipse":return r.Ellipse;case"arrow":return r.Arrow;case"3d":return r.Cube;case"polygon":return r.Polygon;case"bar":return r.Bar;default:return console.warn(`Unknown CandleShape: ${e}`),r.Rectangle}}function c(e){return e.type===t.ColorType.Solid}function h(e){return e.type===t.ColorType.VerticalGradient}function d(e){return"value"in e}function p(e){return"close"in e&&"open"in e&&"high"in e&&"low"in e}function u(e){return!(!e||"object"!=typeof e)&&("time"in e&&!("value"in e||"open"in e||"close"in e||"high"in e||"low"in e))}function m(e){const t=e.options();return"lineColor"in t||"color"in t}function g(e){return"object"==typeof e&&null!==e&&"function"==typeof e.data&&"function"==typeof e.options}!function(e){e.Rectangle="Rectangle",e.Rounded="Rounded",e.Ellipse="Ellipse",e.Arrow="Arrow",e.Cube="3d",e.Polygon="Polygon",e.Bar="Bar"}(r||(r={}));class y extends o{static type="Fill Area";_paneViews;_originSeries;_destinationSeries;_bandsData=[];options;_timeIndices;constructor(e,t,i){super();const o=n("#0000FF",.25),s=n("#FF0000",.25),r=m(e)?n(e.options().lineColor||o,.3):n(o,.3),l=m(t)?n(t.options().lineColor||s,.3):n(s,.3);this.options={...v,...i,originColor:i.originColor??r,destinationColor:i.destinationColor??l},this._paneViews=[new _(this)],this._timeIndices=new a([]),this._originSeries=e,this._destinationSeries=t,this._originSeries.subscribeDataChanged((()=>{console.log("Origin series data has changed. Recalculating bands."),this.dataUpdated("full"),this.updateAllViews()})),this._destinationSeries.subscribeDataChanged((()=>{console.log("Destination series data has changed. Recalculating bands."),this.dataUpdated("full"),this.updateAllViews()}))}updateAllViews(){this._paneViews.forEach((e=>e.update()))}applyOptions(e){this.options={...this.options,...e},this.calculateBands(),this.updateAllViews(),super.requestUpdate(),console.log("FillArea options updated:",this.options)}paneViews(){return this._paneViews}attached(e){super.attached(e),this.dataUpdated("full")}dataUpdated(e){if(this.calculateBands(),"full"===e){const e=this._originSeries.data();this._timeIndices=new a([...e])}}calculateBands(){const e=this._originSeries.data(),t=this._destinationSeries.data(),i=this._alignDataLengths([...e],[...t]),o=[];for(let e=0;e<i.origin.length;e++){let t=b(i.origin[e],i.destination[e]);if(void 0===t?.originValue||void 0===t?.destinationValue)continue;const n=Math.max(t?.originValue,t?.destinationValue),s=Math.min(t?.originValue,t?.destinationValue);o.push({time:i.origin[e].time,origin:t?.originValue,destination:t?.destinationValue,upper:n,lower:s})}this._bandsData=o}_alignDataLengths(e,t){const i=e.length,o=t.length;if(i>o){const e=t[o-1];for(;t.length<i;)t.push({...e})}else if(o>i){const t=e[i-1];for(;e.length<o;)e.push({...t})}return{origin:e,destination:t}}autoscaleInfo(e,t){const i=this.chart.timeScale(),o=i.coordinateToTime(i.logicalToCoordinate(e)??0)??0,n=i.coordinateToTime(i.logicalToCoordinate(t)??5e9)??5e9,s=this._timeIndices.findClosestIndex(o,"left"),a=this._timeIndices.findClosestIndex(n,"right"),r={minValue:Math.min(...this._bandsData.map((e=>e.lower)).slice(s,a+1)),maxValue:Math.max(...this._bandsData.map((e=>e.upper)).slice(s,a+1))};return{priceRange:{minValue:r.minValue,maxValue:r.maxValue}}}}class f{_viewData;_options;constructor(e){this._viewData=e,this._options=e.options}draw(){}drawBackground(e){const t=this._viewData.data,i=this._options;t.length<2||e.useBitmapCoordinateSpace((e=>{const o=e.context;o.scale(e.horizontalPixelRatio,e.verticalPixelRatio);let n=!1,s=0;for(let e=0;e<t.length-1;e++){const a=t[e],r=t[e+1];if(!n||a.isOriginAbove!==t[e-1]?.isOriginAbove){if(n){for(let i=e-1;i>=s;i--)o.lineTo(t[i].x,t[i].destination);o.closePath(),o.fill()}o.beginPath(),o.moveTo(a.x,a.origin),o.fillStyle=a.isOriginAbove?i.originColor||"rgba(0, 0, 0, 0)":i.destinationColor||"rgba(0, 0, 0, 0)",s=e,n=!0}if(o.lineTo(r.x,r.origin),e===t.length-2||r.isOriginAbove!==a.isOriginAbove){for(let i=e+1;i>=s;i--)o.lineTo(t[i].x,t[i].destination);o.closePath(),o.fill(),n=!1}}i.lineWidth&&(o.lineWidth=i.lineWidth,o.strokeStyle=i.originColor||"rgba(0, 0, 0, 0)",o.stroke())}))}}class _{_source;_data;constructor(e){this._source=e,this._data={data:[],options:this._source.options}}update(){const e=this._source.chart.timeScale();this._data.data=this._source._bandsData.map((t=>({x:e.timeToCoordinate(t.time),origin:this._source._originSeries.priceToCoordinate(t.origin),destination:this._source._destinationSeries.priceToCoordinate(t.destination),isOriginAbove:t.origin>t.destination}))),this._data.options=this._source.options}renderer(){return new f(this._data)}zOrder(){return"bottom"}}const v={originColor:null,destinationColor:null,lineWidth:null};function b(e,t){let i,o;if(void 0!==e.close){i=e.close}else void 0!==e.value&&(i=e.value);if(void 0!==t.close){o=t.close}else void 0!==t.value&&(o=t.value);if(void 0!==i&&void 0!==o){if(i<o){return{originValue:void 0!==e.close?Math.min(e.open,e.close):i,destinationValue:void 0!==t.close?Math.max(t.open,t.close):o}}return{originValue:void 0!==e.close?Math.max(e.open,e.close):i,destinationValue:void 0!==t.close?Math.min(t.open,t.close):o}}}const w={backgroundColor:"#0c0d0f",hoverBackgroundColor:"#3c434c",clickBackgroundColor:"#50565E",activeBackgroundColor:"rgba(0, 122, 255, 0.7)",mutedBackgroundColor:"rgba(0, 122, 255, 0.3)",borderColor:"#3C434C",color:"#d8d9db",activeColor:"#ececed"};function x(){window.pane={...w},window.containerDiv=document.getElementById("container")||document.createElement("div"),window.setCursor=e=>{e&&(window.cursor=e),document.body.style.cursor=window.cursor},window.cursor="default",window.textBoxFocused=!1}const C='\n<svg xmlns="http://www.w3.org/2000/svg" width="22" height="16" viewBox="0 0 24 24">\n    <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 21.998437 12 C 21.998437 12 18.998437 18 12 18 \n             C 5.001562 18 2.001562 12 2.001562 12 \n             C 2.001562 12 5.001562 6 12 6 \n             C 18.998437 6 21.998437 12 21.998437 12 Z" />\n    <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 15 12 \n             C 15 13.654687 13.654687 15 12 15 \n             C 10.345312 15 9 13.654687 9 12 \n             C 9 10.345312 10.345312 9 12 9 \n             C 13.654687 9 15 10.345312 15 12 Z" />\n</svg>\n',M='\n<svg xmlns="http://www.w3.org/2000/svg" width="22" height="16" viewBox="0 0 24 24">\n <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 3 3 L 21 21" />\n    <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 21.998437 12 \n             C 21.998437 12 18.998437 18 12 18 \n             C 5.001562 18 2.001562 12 2.001562 12 \n             C 2.001562 12 5.001562 6 12 6 \n             C 14.211 6 16.106 6.897 17.7 8.1" />\n    <path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:#FFF;stroke-opacity:1;stroke-miterlimit:4;" \n          d="M 9.9 9.9 \n             C 9.367 10.434 9 11.178 9 12 \n             C 9 13.654687 10.345312 15 12 15 \n             C 12.822 15 13.566 14.633 14.1 14.1" />\n</svg>\n';class S{contextMenu;handler;constructor(e){this.contextMenu=e.contextMenu,this.handler=e.handler}populateLegendMenu(e,t){this.contextMenu.clearMenu();void 0!==e.seriesList?this.populateGroupMenu(e,t):this.populateSeriesMenu(e,t),this.contextMenu.separator(),this.contextMenu.addMenuItem("Close Menu",(()=>this.contextMenu.hideMenu())),this.contextMenu.showMenu(t)}populateGroupMenu(e,t){if(this.contextMenu.addMenuItem("Rename",(()=>{const t=prompt("Enter new group name:",e.name);t&&""!==t.trim()&&this.renameGroup(e,t.trim())}),!1),this.contextMenu.addMenuItem("Remove",(()=>{confirm(`Are you sure you want to remove the group "${e.name}"? This will also remove all contained series.`)&&(e.seriesList.forEach((e=>{this.handler.legend.removeLegendSeries(e.series),this.handler.removeSeries(e.series)})),this.removeGroup(e))})),this.contextMenu.addMenuItem("Ungroup",(()=>{this.ungroupSeries(e)})),e.seriesList&&e.seriesList.length>0){const t=e.seriesList[0].series.getPane().paneIndex(),i=this.handler.chart.panes(),o=`Pane ${t}`,n=()=>{0===t?i.length>1?(e.seriesList.forEach((e=>{e.series.moveToPane(1)})),console.log(`Default: Moved group "${e.name}" series from pane ${t} to pane 1.`)):(e.seriesList.forEach((e=>{e.series.moveToPane(i.length)})),console.log(`Default: Moved group "${e.name}" series from pane ${t} to a new pane at index ${i.length}.`)):(e.seriesList.forEach((e=>{e.series.moveToPane(0)})),console.log(`Default: Moved group "${e.name}" series from pane ${t} back to main pane (0).`))},s=[];for(let t=0;t<i.length;t++)s.push({name:`Pane ${t}`,action:()=>{e.seriesList.forEach((e=>{e.series.moveToPane(t)})),console.log(`Moved group "${e.name}" series to existing pane ${t}.`)}});s.push({name:"New Pane",action:()=>{e.seriesList.forEach((e=>{e.series.moveToPane(i.length)})),console.log(`Moved group "${e.name}" series to a new pane at index ${i.length}.`)}}),this.contextMenu.addMenuInput(this.contextMenu.div,{type:"hybrid",label:"Move to",sublabel:o,value:o,onChange:e=>{const t=s.find((t=>t.name===e));t&&t.action()},hybridConfig:{defaultAction:n,options:s.map((e=>({name:e.name,action:e.action})))}})}this.contextMenu.separator(),this.contextMenu.addMenuItem("Close Menu",(()=>this.contextMenu.hideMenu())),this.contextMenu.showMenu(t)}populateSeriesMenu(e,t){this.contextMenu.addMenuItem("Open Series Menu",(()=>{this.contextMenu.populateSeriesMenu(e.series,t)}),!1),this.contextMenu.addMenuItem("Move to Group ▸",(()=>{this.populateMoveToGroupMenu(e)}),!1),this.contextMenu.addMenuItem("Remove Series",(()=>{confirm(`Are you sure you want to remove the series "${e.name}"?`)&&(this.handler.legend.removeLegendSeries(e.series),this.handler.removeSeries(e.series))})),e.primitives&&this.contextMenu.addMenuItem("Remove Primitives",(()=>{this.removePrimitivesFromSeries(e)})),e.group&&this.contextMenu.addMenuItem("Ungroup",(()=>{this.ungroupSeriesFromGroup(e)})),this.contextMenu.showMenu(t)}populateMoveToGroupMenu(e){this.contextMenu.clearMenu();this.handler.legend._groups.forEach((t=>{this.contextMenu.addMenuItem(t.name,(()=>{this.handler.legend.moveSeriesToGroup(e,t)}))})),this.contextMenu.addMenuItem("Create New Group...",(()=>{const t=prompt("Enter new group name:","New Group");t&&""!==t.trim()&&this.createNewGroup(e,t.trim())})),e.group&&this.contextMenu.addMenuItem("Ungroup",(()=>{this.ungroupSeriesFromGroup(e)}))}renameGroup(e,t){e.name=t,e.seriesList.forEach((e=>{e.group=t}));const i=e.row.querySelector(".group-header span");i&&(i.textContent=t),console.log(`Group renamed to: ${t}`)}removeGroup(e){this.handler.legend.removeLegendGroup(e),this.handler.legend._groups=this.handler.legend._groups.filter((t=>t!==e)),console.log(`Group "${e.name}" removed along with its series.`)}createNewGroup(e,t){this.handler.legend.deleteLegendEntry(e),e.group=t,this.handler.legend.addLegendItem(e)}ungroupSeriesFromGroup(e){this.handler.legend.getGroupOfSeries(e.series)&&(this.handler.legend.deleteLegendEntry(e),e.group=void 0,this.handler.legend.addLegendItem(e)),console.log(`Series "${e.name}" removed from its group and is now standalone.`)}removePrimitivesFromSeries(e){e.series.primitives&&(Object.values(e.series.primitives).forEach((t=>{e.series.detachPrimitive(t),console.log(`Primitive removed from series "${e.name}".`)})),e.primitives=void 0),console.log(`All primitives removed from series "${e.name}".`)}ungroupSeries(e){e.seriesList.forEach((e=>{this.handler.legend.deleteLegendEntry(e),e.group=void 0,this.handler.legend.addLegendItem(e)})),this.removeGroup(e),console.log(`All series in group "${e.name}" have been ungrouped and are now standalone.`)}}function k(e){return e.data()[e.data().length-1]}class P{handler;div;seriesContainer;legendMenu;ohlcEnabled=!1;percentEnabled=!1;linesEnabled=!1;colorBasedOnCandle=!1;contextMenu;text;_items=[];_lines=[];_groups=[];constructor(e){this.handler=e,this.div=document.createElement("div"),this.div.classList.add("legend"),this.seriesContainer=document.createElement("div"),this.text=document.createElement("span"),this.contextMenu=this.handler.ContextMenu,this.legendMenu=new S({contextMenu:this.contextMenu,handler:e}),this.setupLegend(),this.legendHandler=this.legendHandler.bind(this),e.chart.subscribeCrosshairMove(this.legendHandler)}setupLegend(){this.div.style.maxWidth=100*this.handler.scale.width-8+"vw",this.div.style.display="none";const e=document.createElement("div");e.style.display="flex",e.style.flexDirection="row",this.seriesContainer.classList.add("series-container"),this.text.style.lineHeight="1.8",e.appendChild(this.seriesContainer),this.div.appendChild(this.text),this.div.appendChild(e),this.handler.div.appendChild(this.div)}legendItemFormat(e,t){return"number"!=typeof e||isNaN(e)?"-":e.toFixed(t).toString().padStart(8," ")}shorthandFormat(e){const t=Math.abs(e);return t>=1e6?(e/1e6).toFixed(1)+"M":t>=1e3?(e/1e3).toFixed(1)+"K":e.toString().padStart(8," ")}createSvgIcon(e){const t=document.createElement("div");t.innerHTML=e.trim();return t.querySelector("svg")}addLegendItem(e){const t=this.mapToSeries(e);if(t.group)return this.addItemToGroup(t,t.group);{const e=this.makeSeriesRow(t,this.seriesContainer);return this._lines.push(t),this._items.push(t),e}}addLegendPrimitive(e,t,i){const o=i||t.constructor.name,n=this._lines.find((t=>t.series===e));if(!n)return void console.warn(`Parent series not found in legend for primitive: ${o}`);n.primitives||(n.primitives=[]);let s=this.seriesContainer.querySelector(`[data-series-id="${n.name}"] .primitives-container`);s||(s=document.createElement("div"),s.classList.add("primitives-container"),s.style.display="none",s.style.marginLeft="20px",s.style.flexDirection="column",n.row.insertAdjacentElement("afterend",s));const a=Array.from(s.children).find((e=>e.getAttribute("data-primitive-type")===o));if(a)return console.warn(`Primitive "${o}" already exists under the parent series.`),a;const r=document.createElement("div");r.classList.add("legend-primitive-row"),r.setAttribute("data-primitive-type",o),r.style.display="flex",r.style.justifyContent="space-between",r.style.marginTop="4px";const l=document.createElement("span");l.innerText=o;const c=document.createElement("div");c.style.cursor="pointer",c.style.display="flex",c.style.alignItems="center";const h=this.createSvgIcon(C),d=this.createSvgIcon(M);c.appendChild(h.cloneNode(!0));let p=!0;c.addEventListener("click",(()=>{p=!p,c.innerHTML="",c.appendChild(p?h.cloneNode(!0):d.cloneNode(!0)),this.togglePrimitive(t,p)})),r.appendChild(l),r.appendChild(c),s.appendChild(r),s.children.length>0&&(s.style.display="block");const u={name:o,primitive:t,row:r};return this._items.push(u),n.primitives.push(u),r}togglePrimitive(e,t){const i=e.options||e._options;if(!i)return void console.warn("Primitive has no options to update.");const o={};if("visible"in i)return o.visible=t,console.log(`Toggling visible option for primitive: ${e.constructor.name} to ${t}`),void e.applyOptions(o);const n="_originalColors";e[n]||(e[n]={});const s=e[n];for(const e of Object.keys(i))e.toLowerCase().includes("color")&&(t?o[e]=s[e]||i[e]:(s[e]||(s[e]=i[e]),o[e]="rgba(0,0,0,0)"));Object.keys(o).length>0&&(console.log(`Updating visibility for primitive: ${e.constructor.name}`),e.applyOptions(o),t&&delete e[n])}findLegendPrimitive(e,t){const i=this._lines.find((t=>t.series===e));if(!i||!i.primitives)return null;return i.primitives.find((e=>e.primitive===t))||null}mapToSeries(e){return{name:e.name,series:e.series,group:e.group||void 0,legendSymbol:e.legendSymbol||[],colors:e.colors||["#000"],seriesType:e.seriesType||"Line",div:document.createElement("div"),row:document.createElement("div"),toggle:document.createElement("div"),extraData:e.extraData||null}}addItemToGroup(e,t){let i=this._groups.find((e=>e.name===t));return i?(i.seriesList.push(e),this.makeSeriesRow(e,i.div),i.row):this.makeSeriesGroup(t,[e])}makeSeriesGroup(e,t){let i=this._groups.find((t=>t.name===e));if(i)return i.seriesList.push(...t),t.forEach((e=>this.makeSeriesRow(e,i.div))),i.row;{const i={name:e,seriesList:t,subGroups:[],div:document.createElement("div"),row:document.createElement("div"),toggle:document.createElement("div")};return this._groups.push(i),this.renderGroup(i,this.seriesContainer),i.row}}makeSeriesRow(e,t){const i=document.createElement("div");i.classList.add("legend-series-row"),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.marginBottom="4px";const o=document.createElement("button");o.classList.add("legend-action-button"),o.innerHTML="◇",o.title="Series Actions",o.style.marginRight="0px",o.style.fontSize="1em",o.style.border="none",o.style.background="none",o.style.cursor="pointer",e.colors[0],o.style.color="#ffffff",o.addEventListener("click",(t=>{t.stopPropagation(),t.preventDefault(),"◇"===o.innerHTML?o.innerHTML="◈":o.innerHTML="◇",this.legendMenu.populateLegendMenu(e,t)}));const n=document.createElement("div");n.classList.add("series-info"),n.style.flex="1";if(["Bar","Candlestick","Ohlc"].includes(e.seriesType||"")){const t="-",i="-",o=e.legendSymbol[0]||"▨",s=e.legendSymbol[1]||o,a=e.colors[0]||"#00FF00",r=e.colors[1]||"#FF0000";n.innerHTML=`\n            <span style="color: ${a};">${o}</span>\n            <span style="color: ${r};">${s}</span>\n            ${e.name}: <span style="color: ${r};">O ${t}</span>, \n            <span style="color: ${a};">C ${i}</span>\n        `}else n.innerHTML=e.legendSymbol.map(((t,i)=>`<span style="color: ${e.colors[i]||e.colors[0]};">${t}</span>`)).join(" ")+` ${e.name}`;const s=document.createElement("div");s.classList.add("legend-toggle-switch"),s.style.cursor="pointer",s.style.display="flex",s.style.alignItems="center";const a=this.createSvgIcon(C),r=this.createSvgIcon(M);s.appendChild(a.cloneNode(!0));let l=!0;s.addEventListener("click",(t=>{l=!l,e.series.applyOptions({visible:l}),s.innerHTML="",s.appendChild(l?a.cloneNode(!0):r.cloneNode(!0)),s.setAttribute("aria-pressed",l.toString()),s.classList.toggle("inactive",!l),t.stopPropagation()})),s.setAttribute("role","button"),s.setAttribute("aria-label",`Toggle visibility for ${e.name}`),s.setAttribute("aria-pressed",l.toString()),i.appendChild(o),i.appendChild(n),i.appendChild(s),t.appendChild(i),i.addEventListener("contextmenu",(t=>{t.preventDefault(),this.legendMenu.populateLegendMenu(e,t)}));const c={...e,div:n,row:i,toggle:s};return this._lines.push(c),this._items.push(c),i}isLegendGroup(e){return void 0!==e.seriesList}isLegendSeries(e){return void 0!==e.series||void 0!==e.primitives}isLegendPrimitive(e){return void 0!==e.primitive&&void 0!==e.row}deleteLegendEntry(e,t){if(t&&!e){const e=this._groups.findIndex((e=>e.name===t));if(-1!==e){const i=this._groups[e];this.seriesContainer.removeChild(i.row),this._groups.splice(e,1),this._items=this._items.filter((e=>e!==i)),console.log(`Group "${t}" removed.`)}else console.warn(`Legend group with name "${t}" not found.`)}else if(e){let i=!1;if(t){const o=this._groups.find((e=>e.name===t));if(o){const n=o.seriesList.findIndex((t=>t.name===e));-1!==n&&(o.seriesList.splice(n,1),0===o.seriesList.length?(this.seriesContainer.removeChild(o.row),this._groups=this._groups.filter((e=>e!==o)),this._items=this._items.filter((e=>e!==o)),console.log(`Group "${t}" is empty and has been removed.`)):this.renderGroup(o,this.seriesContainer),i=!0,console.log(`Series "${e}" removed from group "${t}".`))}else console.warn(`Legend group with name "${t}" not found.`)}if(!i){const t=this._lines.findIndex((t=>t.name===e));if(-1!==t){const o=this._lines[t];this.seriesContainer.removeChild(o.row),this._lines.splice(t,1),this._items=this._items.filter((e=>e!==o)),i=!0,console.log(`Series "${e}" removed.`)}}i||console.warn(`Legend item with name "${e}" not found.`)}else console.warn("No seriesName or groupName provided for deletion.")}removeLegendGroup(e){this.seriesContainer.contains(e.row)&&this.seriesContainer.removeChild(e.row);const t=this._groups.indexOf(e);-1!==t&&this._groups.splice(t,1),this._items=this._items.filter((t=>t!==e)),console.log(`Group "${e.name}" removed from legend.`)}findSeriesAnywhere(e){const t=this._lines.find((t=>t.series===e));if(t)return t;for(const t of this._groups){const i=this.findSeriesInGroup(t,e);if(i)return i}}findSeriesInGroup(e,t){const i=e.seriesList.find((e=>e.series===t));if(i)return i;for(const i of e.subGroups){const e=this.findSeriesInGroup(i,t);if(e)return e}}removeSeriesFromGroupDOM(e,t){if(!e.div||!t.row)return console.warn(`⚠️ Cannot remove series "${t.name}" – missing group div or series row.`),!1;if(e.div.contains(t.row))try{return e.div.removeChild(t.row),console.log(`✅ Removed series "${t.name}" from group "${e.name}".`),!0}catch(i){return console.warn(`⚠️ Error removing series "${t.name}" from group "${e.name}":`,i),!1}return e.subGroups.some((e=>this.removeSeriesFromGroupDOM(e,t)))}removeLegendSeries(e){let t;if(t=g(e)?this.findSeriesAnywhere(e):e,t){if(this._lines=this._lines.filter((e=>e!==t)),this._items=this._items.filter((e=>e!==t)),t.group){const e=this.findGroup(t.group);if(e){if(e.seriesList=e.seriesList.filter((e=>e!==t)),t.row&&e.div.contains(t.row))try{e.div.removeChild(t.row),console.log(`✅ Removed "${t.name}" from group "${e.name}".`)}catch(i){console.warn(`⚠️ Error removing "${t.name}" from group "${e.name}":`,i)}0===e.seriesList.length&&this.removeGroupCompletely(e)}}else if(t.row?.parentElement)try{t.row.parentElement.removeChild(t.row),console.log(`✅ Removed row for standalone series: ${t.name}`)}catch(e){console.warn("⚠️ Error removing standalone series row:",e)}}else console.warn("⚠️ LegendSeries not found in legend.")}removeGroupCompletely(e){if(e.row.parentElement)try{e.row.parentElement.removeChild(e.row)}catch(t){console.warn(`Error removing group "${e.name}":`,t)}this._groups=this._groups.filter((t=>t!==e)),this._items=this._items.filter((t=>t!==e)),console.log(`Group "${e.name}" removed as it became empty.`)}removeLegendPrimitive(e){let t;if(t=this.isLegendPrimitive(e)?e:this._items.find((t=>this.isLegendPrimitive(t)&&t.primitive===e)),!t)return void console.warn("❌ LegendPrimitive not found in legend.");t.row&&t.row.parentElement?t.row.parentElement.removeChild(t.row):console.warn("❌ LegendPrimitive row not found in the DOM.");const i=this._lines.find((e=>e.primitives?.includes(t)));if(i&&(i.primitives=i.primitives.filter((e=>e!==t)),console.log(`✅ Removed primitive "${t.name}" from series "${i.name}".`)),this._items=this._items.filter((e=>e!==t)),t.primitive)try{console.log(`Detaching underlying chart primitive for "${t.name}".`),i?.series.detachPrimitive(t.primitive)}catch(e){console.warn(`⚠️ Failed to detach primitive "${t.name}":`,e)}console.log(`✅ LegendPrimitive "${t.name}" removed from legend.`)}getGroupOfSeries(e){for(const t of this._groups){const i=this.findGroupOfSeriesRecursive(t,e);if(i)return i}}findGroupOfSeriesRecursive(e,t){for(const i of e.seriesList)if(i.series===t)return e.name;for(const i of e.subGroups){const e=this.findGroupOfSeriesRecursive(i,t);if(e)return e}}moveSeriesToGroup(e,t){let i=this._lines.findIndex((t=>t.name===e)),o=null;if(-1!==i)o=this._lines[i];else for(const t of this._groups){const i=t.seriesList.findIndex((t=>t.name===e));if(-1!==i){o=t.seriesList[i],t.seriesList.splice(i,1),0===t.seriesList.length?(this.seriesContainer.removeChild(t.row),this._groups=this._groups.filter((e=>e!==t)),this._items=this._items.filter((e=>e!==t)),console.log(`Group "${t.name}" is empty and has been removed.`)):this.renderGroup(t,this.seriesContainer);break}}if(!o)return void console.warn(`Series "${e}" not found in legend.`);-1!==i?(this.seriesContainer.removeChild(o.row),this._lines.splice(i,1),this._items=this._items.filter((e=>e!==o))):this._items=this._items.filter((e=>e!==o));let n=this.findGroup(t);n?(n.seriesList.push(o),this.makeSeriesRow(o,n.div)):(n={name:t,seriesList:[o],subGroups:[],div:document.createElement("div"),row:document.createElement("div"),toggle:document.createElement("div")},this._groups.push(n),this.renderGroup(n,this.seriesContainer)),this._items.push(o),console.log(`Series "${e}" moved to group "${t}".`)}renderGroup(e,t){e.row.innerHTML="",e.row.style.display="flex",e.row.style.flexDirection="column",e.row.style.width="100%";const i=document.createElement("div");i.classList.add("group-header"),i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="space-between",i.style.cursor="pointer";const o=document.createElement("button");o.classList.add("legend-action-button"),o.innerHTML="◇",o.title="Group Actions",o.style.marginRight="0px",o.style.fontSize="1em",o.style.border="none",o.style.background="none",o.style.cursor="pointer",e.seriesList[0]?.colors[0],o.style.color="#ffffff",o.addEventListener("click",(t=>{t.stopPropagation(),t.preventDefault(),"◇"===o.innerHTML?o.innerHTML="◈":o.innerHTML="◇",this.legendMenu.populateLegendMenu(e,t)}));const n=document.createElement("span");n.style.fontWeight="bold",n.innerHTML=e.seriesList.map((e=>e.legendSymbol.map(((t,i)=>`<span style="color: ${e.colors[i]||e.colors[0]};">${t}</span>`)).join(" "))).join(" ")+` ${e.name}`;const s=document.createElement("span");s.classList.add("toggle-button"),s.style.marginLeft="auto",s.style.fontSize="1.2em",s.style.cursor="pointer",s.innerHTML="⌲",s.setAttribute("aria-expanded","true"),s.addEventListener("click",(t=>{t.stopPropagation(),"none"===e.div.style.display?(e.div.style.display="block",s.innerHTML="⌲",s.setAttribute("aria-expanded","true")):(e.div.style.display="none",s.innerHTML="☰",s.setAttribute("aria-expanded","false"))})),i.appendChild(o),i.appendChild(n),i.appendChild(s),i.addEventListener("contextmenu",(t=>{t.preventDefault(),this.legendMenu.populateLegendMenu(e,t)})),e.row.appendChild(i),e.div=document.createElement("div"),e.div.style.display="block",e.div.style.marginLeft="10px";for(const t of e.seriesList)this.makeSeriesRow(t,e.div);for(const t of e.subGroups){const i=document.createElement("div");i.style.display="flex",i.style.flexDirection="column",i.style.paddingLeft="5px",this.renderGroup(t,i),e.div.appendChild(i)}e.row.appendChild(e.div),t.contains(e.row)||t.appendChild(e.row),e.row.oncontextmenu=e=>{e.preventDefault()}}legendHandler(e,t=!1){this.updateGroupDisplay(e,null,t),this.updateSeriesDisplay(e,null,t)}updateSeriesDisplay(e,t,i){this._lines&&this._lines.length?this._lines.forEach((t=>{const i=e.seriesData.get(t.series)||k(t.series);if(!i)return;const o=t.seriesType||"Line",n=t.series.options().priceFormat;if("Line"===o||"Area"===o){const e=i;if(null==e.value)return;const o=this.legendItemFormat(e.value,n.precision);t.div.innerHTML=`\n                    <span style="color: ${t.colors[0]};">${t.legendSymbol[0]||"▨"}</span> \n                    ${t.name}: ${o}`}else if("Bar"===o||"Candlestick"===o||"Ohlc"===o){const{open:e,close:o}=i;if(null==e||null==o)return;const s=this.legendItemFormat(e,n.precision),a=this.legendItemFormat(o,n.precision),r=o>e,l=r?t.colors[0]:t.colors[1],c=r?t.legendSymbol[0]:t.legendSymbol[1];t.div.innerHTML=`\n                    <span style="color: ${l};">${c||"▨"}</span>\n                    ${t.name}: \n                    <span style="color: ${l};">O ${s}</span>, \n                    <span style="color: ${l};">C ${a}</span>`}})):console.error("No lines available to update legend.")}updateGroupDisplay(e,t,i){this._groups.forEach((t=>{this.linesEnabled?(t.row.style.display="flex",t.seriesList.forEach((t=>{const i=e.seriesData.get(t.series)||k(t.series);if(!i)return;const o=t.seriesType||"Line",n=t.name,s=t.series.options().priceFormat;if(["Bar","Candlestick","Ohlc"].includes(o)){const{open:e,close:o,high:a,low:r}=i;if(null==e||null==o||null==a||null==r)return;const l=this.legendItemFormat(e,s.precision),c=this.legendItemFormat(o,s.precision),h=o>e,d=h?t.colors[0]:t.colors[1],p=h?t.legendSymbol[0]:t.legendSymbol[1];t.div.innerHTML=`\n                        <span style="color: ${d};">${p||"▨"}</span>\n                        ${n}: \n                        <span style="color: ${d};">O ${l}</span>, \n                        <span style="color: ${d};">C ${c}</span>\n                    `}else{const e="value"in i?i.value:void 0;if(null==e)return;const o=this.legendItemFormat(e,s.precision),a=t.colors[0],r=t.legendSymbol[0]||"▨";t.div.innerHTML=`\n                        <span style="color: ${a};">${r}</span>\n                        ${n}: ${o}\n                    `}}))):t.row.style.display="none"}))}findGroup(e,t=this._groups){for(const i of t){if(i.name===e)return i;const t=this.findGroup(e,i.subGroups);if(t)return t}}}const T={lineColor:"#1E80F0",lineStyle:t.LineStyle.Solid,width:4};var D;!function(e){e[e.NONE=0]="NONE",e[e.HOVERING=1]="HOVERING",e[e.DRAGGING=2]="DRAGGING",e[e.DRAGGINGP1=3]="DRAGGINGP1",e[e.DRAGGINGP2=4]="DRAGGINGP2",e[e.DRAGGINGP3=5]="DRAGGINGP3",e[e.DRAGGINGP4=6]="DRAGGINGP4"}(D||(D={}));class L extends o{_paneViews=[];_options;_points=[];_state=D.NONE;_startDragPoint=null;_latestHoverPoint=null;static _mouseIsDown=!1;static hoveredObject=null;static lastHoveredObject=null;_listeners=[];constructor(e){super(),this._options={...T,...e}}updateAllViews(){this._paneViews.forEach((e=>e.update()))}paneViews(){return this._paneViews}applyOptions(e){this._options={...this._options,...e},this.requestUpdate()}updatePoints(...e){for(let t=0;t<this.points.length;t++)null!=e[t]&&(this.points[t]=e[t]);this.requestUpdate()}detach(){this._options.lineColor="transparent",this.requestUpdate(),this.series.detachPrimitive(this);for(const e of this._listeners)document.body.removeEventListener(e.name,e.listener)}get points(){return this._points}_subscribe(e,t){document.body.addEventListener(e,t),this._listeners.push({name:e,listener:t})}_unsubscribe(e,t){document.body.removeEventListener(e,t);const i=this._listeners.find((i=>i.name===e&&i.listener===t));this._listeners.splice(this._listeners.indexOf(i),1)}_handleHoverInteraction(e){if(this._latestHoverPoint=e.point,L._mouseIsDown)this._handleDragInteraction(e);else if(this._mouseIsOverDrawing(e)){if(this._state!=D.NONE)return;this._moveToState(D.HOVERING),L.hoveredObject=L.lastHoveredObject=this}else{if(this._state==D.NONE)return;this._moveToState(D.NONE),L.hoveredObject===this&&(L.hoveredObject=null)}}static _eventToPoint(e,t){if(!t||!e.point||!e.logical)return null;const i=t.coordinateToPrice(e.point.y);return null==i?null:{time:e.time||null,logical:e.logical,price:i.valueOf()}}static _getDiff(e,t){return{logical:e.logical-t.logical,price:e.price-t.price}}_addDiffToPoint(e,t,i){e&&(e.logical=e.logical+t,e.price=e.price+i,e.time=this.series.dataByIndex(e.logical)?.time||null)}_handleMouseDownInteraction=()=>{L._mouseIsDown=!0,this._onMouseDown()};_handleMouseUpInteraction=()=>{L._mouseIsDown=!1,this._moveToState(D.HOVERING)};_handleDragInteraction(e){if(this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP1&&this._state!=D.DRAGGINGP2&&this._state!=D.DRAGGINGP3&&this._state!=D.DRAGGINGP4)return;const t=L._eventToPoint(e,this.series);if(!t)return;this._startDragPoint=this._startDragPoint||t;const i=L._getDiff(t,this._startDragPoint);this._onDrag(i),this.requestUpdate(),this._startDragPoint=t}}function E(e,t){const i=e.split("."),o={};let n=o;for(let e=0;e<i.length;e++){const o=i[e];e===i.length-1?n[o]=t:(n[o]={},n=n[o])}return o}function I(e){return e.replace(/([A-Z])/g," $1").replace(/^./,(e=>e.toUpperCase()))}function O(e,i,o){const n=i.timeScale(),s=o??i.addSeries(t.LineSeries);if(!s)return console.warn("No series found. Cannot perform y-axis conversions."),null;if("logical"in e){const t=e,i=n.logicalToCoordinate(t.logical),o=s.priceToCoordinate(t.price);return null===i||null===o?null:{x:i,y:o}}{const t=e,i=n.coordinateToLogical(t.x),o=n.coordinateToTime(t.x),a=s.coordinateToPrice(t.y);return null===i||null===a?null:{time:o,logical:i,price:a}}}function N(e,t,i,o,n){const s=o-n/2,a=o+n/2;e.beginPath(),e.moveTo(t,s),e.lineTo(t,a),e.lineTo(i,a),e.lineTo(i,s),e.closePath(),e.fill(),e.stroke()}function A(e,t,i,o,n,s){const a=i-t,r=s*Math.min(Math.abs(a),Math.abs(n)),l=Math.abs(Math.min(r,a/2,n/2)),c=o-n/2;e.beginPath(),"function"==typeof e.roundRect?e.roundRect(t,c,a,n,l):(e.moveTo(t+l,c),e.lineTo(i-l,c),e.quadraticCurveTo(i,c,i,c+l),e.lineTo(i,c+n-l),e.quadraticCurveTo(i,c+n,i-l,c+n),e.lineTo(t+l,c+n),e.quadraticCurveTo(t,c+n,t,c+n-l),e.lineTo(t,c+l),e.quadraticCurveTo(t,c,t+l,c)),e.closePath(),e.fill(),e.stroke()}function V(e,t,i,o,n,s){const a=t+(i-t)/2,r=i-t;e.beginPath(),e.ellipse(a,n,Math.abs(r/2),Math.abs(s/2),0,0,2*Math.PI),e.fill(),e.stroke()}function $(e,t,i,o,n,a,r,l,c,h,d,p){const u=-Math.max(l,1)*(1-p),m=s(c,.666),g=s(c,.333),y=s(c,.2),f=t-r/2,_=f+l+u,v=f-u,b=_-u;let w,x,C,M;d?(w=n,x=o,C=i,M=a):(w=n,x=i,C=o,M=a),e.fillStyle=g,e.strokeStyle=h,e.beginPath(),e.rect(v,C,l+u-r/2,M-C),e.fill(),e.stroke(),e.fillStyle=y,d?(e.fillStyle=m,e.beginPath(),e.moveTo(f,x),e.lineTo(v,M),e.lineTo(b,M),e.lineTo(_,x),e.closePath(),e.fill(),e.stroke(),e.fillStyle=m,e.beginPath(),e.moveTo(f,w),e.lineTo(v,C),e.lineTo(v,M),e.lineTo(f,x),e.closePath(),e.fill(),e.stroke(),e.fillStyle=m,e.beginPath(),e.moveTo(_,w),e.lineTo(b,C),e.lineTo(b,M),e.lineTo(_,x),e.closePath(),e.fill(),e.stroke(),e.fillStyle=y,e.beginPath(),e.moveTo(f,w),e.lineTo(v,C),e.lineTo(b,C),e.lineTo(_,w),e.closePath(),e.fill(),e.stroke()):(e.fillStyle=y,e.beginPath(),e.moveTo(f,w),e.lineTo(v,C),e.lineTo(b,C),e.lineTo(_,w),e.closePath(),e.fill(),e.stroke(),e.fillStyle=g,e.beginPath(),e.moveTo(_,w),e.lineTo(b,C),e.lineTo(b,M),e.lineTo(_,x),e.closePath(),e.fill(),e.stroke(),e.fillStyle=g,e.beginPath(),e.moveTo(f,w),e.lineTo(v,C),e.lineTo(v,M),e.lineTo(f,x),e.closePath(),e.fill(),e.stroke(),e.fillStyle=g,e.beginPath(),e.moveTo(f,x),e.lineTo(v,M),e.lineTo(b,M),e.lineTo(_,x),e.closePath(),e.fill(),e.stroke())}function R(e,t,i,o,n,s,a,r){const l=o+n/2,c=o-n/2;e.save(),e.beginPath(),r?(e.moveTo(t,l),e.lineTo(i,s),e.lineTo(i,c),e.lineTo(t,a)):(e.moveTo(t,s),e.lineTo(i,l),e.lineTo(i,a),e.lineTo(t,c)),e.closePath(),e.stroke(),e.fill(),e.restore()}function G(e,t,i,o,n,s,a,r,l){e.save(),e.beginPath(),l?(e.moveTo(t,r),e.lineTo(t,n+s/2),e.lineTo(o,a),e.lineTo(i,n+s/2),e.lineTo(i,r),e.lineTo(o,n-s/2),e.lineTo(t,r)):(e.moveTo(t,a),e.lineTo(t,n-s/2),e.lineTo(o,r),e.lineTo(i,n-s/2),e.lineTo(i,a),e.lineTo(o,n+s/2),e.lineTo(t,a)),e.closePath(),e.fill(),e.stroke(),e.restore()}function B(e,t,i,o,n,s,a){const r=(t+i)/2;e.beginPath(),e.moveTo(r,o),e.lineTo(r,n),e.stroke(),e.beginPath(),e.moveTo(t,s),e.lineTo(r,s),e.stroke(),e.beginPath(),e.moveTo(r,a),e.lineTo(i,a),e.stroke()}class F{_options;constructor(e){this._options=e}}class U extends F{_p1;_p2;_hovered;constructor(e,t,i,o){super(i),this._p1=e,this._p2=t,this._hovered=o}_getScaledCoordinates(e){return null===this._p1.x||null===this._p1.y||null===this._p2.x||null===this._p2.y?null:{x1:Math.round(this._p1.x*e.horizontalPixelRatio),y1:Math.round(this._p1.y*e.verticalPixelRatio),x2:Math.round(this._p2.x*e.horizontalPixelRatio),y2:Math.round(this._p2.y*e.verticalPixelRatio)}}_drawEndCircle(e,t,i){e.context.fillStyle="#000",e.context.beginPath(),e.context.arc(t,i,9,0,2*Math.PI),e.context.stroke(),e.context.fill()}}class H extends F{_p1;_p2;_p3;_hovered;constructor(e,t,i,o,n){super(o),this._p1=e,this._p2=t,this._p3=i,this._hovered=n}_getScaledCoordinates(e){return null===this._p1.x||null===this._p1.y||null===this._p2.x||null===this._p2.y||null===this._p3.x||null===this._p3.y?null:{x1:Math.round(this._p1.x*e.horizontalPixelRatio),y1:Math.round(this._p1.y*e.verticalPixelRatio),x2:Math.round(this._p2.x*e.horizontalPixelRatio),y2:Math.round(this._p2.y*e.verticalPixelRatio),x3:Math.round(this._p3.x*e.horizontalPixelRatio),y3:Math.round(this._p3.y*e.verticalPixelRatio)}}_drawEndCircle(e,t,i){e.context.fillStyle="#000",e.context.beginPath(),e.context.arc(t,i,9,0,2*Math.PI),e.context.stroke(),e.context.fill()}}const W={...t.customSeriesDefaultOptions,side:"long",mode:"relative",auto:!1,entryColor:"#FFFF00",stopColor:"#FF0000",targetColor:"#00FF00",backgroundColorStop:"rgba(255,0,0,0.25)",backgroundColorTarget:"rgba(0,255,0,0.25)",lineWidth:1,lineStyle:3,partialClosureLineColor:"#FFFFFF",partialClosureLineWidth:1,partialClosureLineDash:[4,2],infoTextColor:"#FFFFFF",infoFont:"12px Arial",positionChangeColor:"#FFFFFF"};class z{_renderer;constructor(){this._renderer=new q}priceValueBuilder(e){return[Math.max(e.entry??NaN,e.stop??NaN,e.target??NaN),Math.min(e.entry??NaN,e.stop??NaN,e.target??NaN),e.entry??NaN]}renderer(){return this._renderer}isWhitespace(e){return void 0===e.entry}update(e,t){this._renderer.update(e,t)}defaultOptions(){return W}}class j{_options;constructor(e){this._options=e}aggregate(e,t){const i=[];let o=0;for(;o<e.length;){const n=e[o];if("increase"===n.action||"entry"===n.action){const n=o,s=this._findEndIndexByCross(e,n),a=null===s,r=this._aggregateSegment(e.slice(n,(s??e.length-1)+1),n,s??e.length-1,t,a);e[n].displayInfo&&(r.displayInfo=e[n].displayInfo),i.push(r);const l=this._findStartIndex(e,s??e.length-1);o=null!==l&&l>o?l:(s??e.length-1)+1}else o++}return i}_aggregateSegment(e,t,i,o,n){if(0===e.length)throw new Error("Segment cannot be empty in _aggregateSegment method.");return{entry:e[0].entry??NaN,stop:e.reduce(((e,t)=>Math.max(e,t.stop??0)),0),target:e.reduce(((e,t)=>Math.min(e,t.target??1/0)),1/0),startIndex:t,endIndex:i,isInProgress:n,displayInfo:e[0].displayInfo??void 0}}_findEndIndex(e,t){for(let i=t+1;i<e.length;i++)if("close"===e[i].action)return i;return null}_findStartIndex(e,t){for(let i=t+1;i<e.length;i++){const t=e[i].action;if("entry"===t)return i;if("increase"===t){if(this._isNewTrade(e,i))return i}}return null}_isNewTrade(e,t){if(0===t)return!0;const i=e[t-1].action;return"close"===i||void 0===i}_findEndIndexByCross(e,t){const i=this._options?.baseSeries?.data()??[];if(!i.length)return null;const o=e[t],n=o.stop,s=o.target;if(null==n&&null==s)return null;const a=this._options?.side??"long",r=i.findIndex((e=>e.time>=o.time));if(r<0)return null;for(let e=r;e<i.length;e++){const t=i[e],o="close"in t?t.close:"value"in t?t.value:void 0;if(null!=o)if("long"===a){if(null!=s&&o>=s)return e;if(null!=n&&o<=n)return e}else{if(null!=s&&o<=s)return e;if(null!=n&&o>=n)return e}}return null}}class q{_data=null;_options=null;_aggregator=null;update(e,t){this._data=e,this._options=t,this._aggregator=new j(t)}draw(e,t){this._data&&this._data.bars.length&&this._data.visibleRange&&this._aggregator&&e.useBitmapCoordinateSpace((e=>this._drawImpl(e,t)))}_drawImpl(e,t){if(!(this._data&&this._options&&this._aggregator&&this._data.visibleRange))return;const{context:i,horizontalPixelRatio:o,verticalPixelRatio:n}=e,{from:s,to:a}=this._data.visibleRange,r=this._data.bars,l=this._aggregator.aggregate(r.map((e=>e.originalData)).filter(Boolean),t);i.save(),l.forEach((e=>{if(e.endIndex<s||e.startIndex>a)return;const l=r[e.startIndex].x*o,c=r[e.endIndex].x*o,h=(t(e.entry)??0)*n,d=(t(e.stop)??0)*n,p=(t(e.target)??0)*n;this._fillArea(i,l,c,h,d,this._options?.backgroundColorStop??"rgba(255,0,0,0.25)"),this._fillArea(i,l,c,h,p,this._options?.backgroundColorTarget??"rgba(0,255,0,0.25)")})),i.restore()}_calculatePosition(e,t,i){let o=0,n=null;for(let s=e.startIndex;s<=e.endIndex&&s<i.length;s++){const e=i[s];"increase"===e.action?(o="relative"===t?o+o*(e.amount??1):o+(e.amount??1),null===n&&(n=o)):"decrease"===e.action?o="relative"===t?o-o*(e.amount??1):o-(e.amount??1):"close"===e.action&&(o=0)}return console.log(`Trade from index ${e.startIndex} to ${e.endIndex}: Initial Position: ${n}, Final Position: ${o}`),o}_fillArea(e,t,i,o,n,s){const a=Math.min(o,n),r=Math.max(o,n),l=e.createLinearGradient(0,a,0,r);o===a?(l.addColorStop(0,"rgba(0,0,0,0)"),l.addColorStop(1,s)):(l.addColorStop(0,s),l.addColorStop(1,"rgba(0,0,0,0)")),e.fillStyle=l,e.beginPath(),e.rect(t,a,i-t,r-a),e.fill()}_findEndIndexByCross(e,t){const i=this._options?.baseSeries?.data()??[];if(!i.length)return null;const o=e[t],n=o.stop,s=o.target;if(null==n&&null==s)return null;const a=i.findIndex((e=>e.time>=o.time));if(a<0)return null;for(let e=a;e<i.length;e++){const t=i[e];let o="close"in t?t.close:t.value;if(null!=o){if(null!=s&&o>=s)return e;if(null!=n&&o<=n)return e}}return null}}function J(e,t){if(e._isDecorated)return console.warn("Series is already decorated. Skipping decoration."),e;e._isDecorated=!0;const i=e.setData.bind(e),o=[];let n=null;const s=e.detachPrimitive?.bind(e),a=e.attachPrimitive?.bind(e),r=e.data?.bind(e),l=e.seriesType(),c=e.options().title;function h(e){const i=o.indexOf(e);-1!==i&&(o.splice(i,1),n===e&&(n=null),s&&s(e),t&&(t.removeLegendPrimitive(e),console.log(`Removed primitive of type "${e.constructor.name}" from legend.`)))}function d(){for(console.log("Detaching all primitives.");o.length>0;){h(o.pop())}console.log("All primitives detached.")}return Object.assign(e,{setData:function(e){i(e)},primitives:o,sync:function(e){const t=e.options().seriesType??"Line",i=r();if(!i)return void console.warn("Source data is missing for synchronization.");const o=[...e.data()];for(let n=o.length;n<i.length;n++){const i=Y(e,t,n);i&&(i&&"time"in i&&"value"in i?o.push(i):console.warn("Invalid data item:",i))}e.setData(o),console.log(`Synchronized series of type ${e.seriesType}`),e.subscribeDataChanged((()=>{const i=[...r()];if(!i||0===i.length)return void console.warn("Source data is missing for synchronization.");const o=e.data().slice(-1)[0],n=i.length-1;if(!o||i[n].time>=o.time){const i=Y(e,t,n);i&&(e.update(i),console.log(`Updated/added bar via "update()" for series type ${e.seriesType}`))}}))},attachPrimitive:function(i,s,r=!0,l=!1){const c=i.constructor.type||i.constructor.name;if(r)d();else{const e=o.findIndex((e=>e.constructor.type===c));-1!==e&&h(o[e])}a&&a(i),o.push(i),n=i,console.log(`Primitive of type "${c}" attached.`),t&&l&&t.addLegendPrimitive(e,i,s)},detachPrimitive:h,detachPrimitives:d,decorated:!0,_type:l,title:c,get primitive(){return n},toJSON:()=>({options:e.options(),data:r()}),fromJSON(t){if(t.data&&i(t.data),t.options){const i=t.options;for(const t in i)if(Object.prototype.hasOwnProperty.call(i,t)){const o=t;e.applyOptions({[o]:i[o]})}}}})}function X(e){const t={};switch(e){case"Line":return{...t,title:e,color:"#195200",lineWidth:2,crosshairMarkerVisible:!0};case"Histogram":return{...t,title:e,color:"#9ACF01",base:0};case"Area":return{...t,title:e,lineColor:"#021698",topColor:"rgba(9, 32, 210, 0.4)",bottomColor:"rgba(0, 0, 0, 0.5)"};case"Bar":return{...t,title:e,upColor:"#006721",downColor:"#6E0000",borderUpColor:"#006721",borderDownColor:"#6E0000"};case"Candlestick":return{...t,title:e,upColor:"rgba(0, 103, 33, 0.33)",downColor:"rgba(110, 0, 0, 0.33)",borderUpColor:"#006721",borderDownColor:"#6E0000",wickUpColor:"#006721",wickDownColor:"#6E0000"};case"Ohlc":return{...t,title:e,upColor:"rgba(0, 103, 33, 0.33)",downColor:"rgba(110, 0, 0, 0.33)",borderUpColor:"#006721",borderDownColor:"#6E0000",wickUpColor:"#006721",wickDownColor:"#6E0000",shape:"Rounded",chandelierSize:1,barSpacing:.777,lineStyle:0,lineWidth:1};case"Trade":return{...t,...W};default:throw new Error(`Unsupported series type: ${e}`)}}function Y(e,t,i){const o=e.data();if(!o||0===o.length)return console.warn("No data available in the source series."),null;const n=o[i];switch(t){case"Line":case"Histogram":case"Area":if(p(n))return{time:n.time,value:n.close};if(d(n))return{time:n.time,value:n.value};if(u(n))return{time:n.time};break;case"Bar":case"Candlestick":case"Ohlc":if(p(n))return{time:n.time,open:n.open,high:n.high,low:n.low,close:n.close};if(u(n))return{time:n.time};break;case"Trade":return{time:n.time,action:n.action??void 0};default:return console.error(`Unsupported target type: ${t}`),null}return console.warn("Could not convert data to the target type."),null}var K;function Z(e,t){return(e=>void 0!==e.primitives)(e)?e:(console.log("Decorating the series dynamically."),J(e,t))}function Q(e,t){const i={...e.paramMap,...t},o=[...e.sourceSeries.data()];if(!o||!Array.isArray(o)||0===o.length)return;let n;n=o.every(p)?o:o.map(ee);e.indicator.calc(n,i).forEach((t=>{const i=e.figures.get(t.key);if(i&&(i.setData(t.data),i.applyOptions({title:t.title}),t.pane&&i.getPane()===e.sourceSeries.getPane())){const e=i.getPane().paneIndex();i.moveToPane(e+t.pane)}})),e.paramMap=i}function ee(e){return{time:e.time,open:e.value,high:e.value,low:e.value,close:e.value}}function te(e,i){const o={[t.LineStyle.Solid]:[],[t.LineStyle.Dotted]:[e.lineWidth,e.lineWidth],[t.LineStyle.Dashed]:[2*e.lineWidth,2*e.lineWidth],[t.LineStyle.LargeDashed]:[6*e.lineWidth,6*e.lineWidth],[t.LineStyle.SparseDotted]:[e.lineWidth,4*e.lineWidth]}[i];e.setLineDash(o)}!function(e){e.Line="Line",e.Histogram="Histogram",e.Area="Area",e.Bar="Bar",e.Candlestick="Candlestick",e.Ohlc="Ohlc",e.Trade="Trade"}(K||(K={}));const ie={visible:!0,autoScale:!1,xScaleLock:!1,yScaleLock:!1,color:"#737375",lineWidth:1,upColor:"rgba(0,255,0,.25)",downColor:"rgba(255,0,0,.25)",wickVisible:!0,borderVisible:!0,borderColor:"#737375",borderUpColor:"#1c9d1c",borderDownColor:"#d5160c",wickColor:"#737375",wickUpColor:"#1c9d1c",wickDownColor:"#d5160c",radius:100,shape:"Rounded",chandelierSize:1,barSpacing:.7,lineStyle:0,lineColor:"#ffffff",width:1};class oe{handler;get data(){return this.convertAndAggregateDataPoints()}get sourceData(){return this._originalData}_originalP1;_originalP2;_barWidth=.8;p1;p2;_options;series;_originalData=[];_originalSlice=[];offset;onComplete;get spatial(){return this.recalculateSpatial()}transform={scale:{x:1,y:1},shift:{x:0,y:0}};constructor(e,t,i,o,n,s){let a,r;this.handler=e,this._options={...n,...ie},Math.min(i.logical,o.logical)===i.logical?(a=i,r=o):(a=o,r=i),this._originalP1={...a},this._originalP2={...r},this.offset=s??0,this.p1=i,this.p2=o,g(t)?(this.series=t,this._originalData=this.series.data().map(((e,t)=>({...e,x1:t,x2:t})))):(this.series=this.handler.series||this.handler._seriesList[0],this._originalData=t._originalData);const l=Math.min(this._originalP1.logical,this._originalP2.logical),c=Math.max(this._originalP1.logical,this._originalP2.logical);s&&s>0?(this._originalSlice=this._originalData.slice(c,Math.min(this.series.data().length-1,c+1+s)),console.log("Data Sliced with Offset",l,c,s,"Offset Point:",Math.min(this.series.data().length-1,c+1+s))):(this._originalSlice=this._originalData.slice(l,c+1),console.log("Data Sliced:",l,c)),s&&s>0&&(this._originalSlice=this._originalSlice.map((e=>({...e,x1:e.x1+s,x2:e.x2+s}))),console.log("Adjusted originalSlice with pOffset:",s)),this.transform=this.recalculateSpatial(),this.p1&&this.p2&&this.setPoints(this.p1,this.p2)}setData(e){this._originalSlice=e}setPoints(e,t){let i,o;Math.min(e.logical,t.logical)===e.logical?(i=e,o=t):(i=t,o=e),null===this._originalP1?(this._originalP1={...i},console.log("First point (p1) set:",this._originalP1)):null===this._originalP2&&(this._originalP2={...o},console.log("Second point (p2) set:",this._originalP2)),this.p1=i,this.p2=o,this.recalculateSpatial(),this.processSequence()}updatePoint(e,t){1===e?this.p1=t:2===e&&(this._originalP2||(this._originalP2=t),this.p2=t),this.recalculateSpatial(),this.processSequence()}recalculateSpatial(){if(!(this.p1&&this.p2&&this._originalP1&&this._originalP2))return console.warn("Cannot recalc spatial without valid p1/p2."),{scale:{x:1,y:1},shift:{x:0,y:0}};const e=Math.abs(this._originalP1.logical-this._originalP2.logical),t=Math.abs(this._originalP1.price-this._originalP2.price);if(0===e||0===t)return console.warn("Cannot recalc scale if original points are zero difference."),{scale:{x:1,y:1},shift:{x:0,y:0}};const i=Math.abs(this.p1.logical-this.p2.logical)/e,o=((this._originalP2.price>this._originalP1.price?this.p2.price:this.p1.price)-(this._originalP2.price>this._originalP1.price?this.p1.price:this.p2.price))/t;this._options.xScaleLock||(this.transform.scale.x=i),this._options.yScaleLock||(this.transform.scale.y=o),this._options.autoScale&&i>-1&&i<1&&(this._options.chandelierSize=Math.abs(Math.ceil(1/i)));const n={scale:{x:0!==i?Math.round(100*i)/100:1,y:0!==o?Math.round(100*o)/100:1},shift:{x:this._originalP1.logical-this.p1.logical,y:this._originalP1.price-this.p1.price}};return this._barWidth=Math.abs(this.p1.logical-this.p2.logical)/this._originalData.length,console.log("Spatial recalculated:","scaleX=",n.scale.x,"scaleY=",n.scale.y,"shiftX=",n.shift.x,"shiftY=",n.shift.y),0===n.scale.x||0===n.scale.y?(console.warn("Scale factors cannot be zero."),{scale:{x:1,y:1},shift:{x:0,y:0}}):n}processSequence(){this.p1&&this.p2?(this.convertAndAggregateDataPoints(),this.onComplete&&this.onComplete()):console.warn("Cannot process sequence without valid p1/p2.")}convertAndAggregateDataPoints(){let e=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY;const i={...this.spatial};this._originalSlice.forEach((i=>{const o=[];void 0!==i.open&&o.push(i.open),void 0!==i.high&&o.push(i.high),void 0!==i.low&&o.push(i.low),void 0!==i.close&&o.push(i.close),void 0!==i.value&&o.push(i.value);for(const i of o)i<e&&(e=i),i>t&&(t=i)}));const o=t===e?1:t-e,s=this.p1.logical,a=this._originalSlice.map(((t,a)=>{const r=s+a;function l(t,i){if(void 0===t)return;const n=(t-e)/o;return e-i.shift.y+n*i.scale.y*o}const c=l(t.open,i),h=l(t.close,i),d=l(t.high,i),p=l(t.low,i),u=l(t.value,i);if(void 0!==c||void 0!==h||void 0!==d||void 0!==p){const e=(h??0)>(c??0),i=e?this._options.upColor||"rgba(0,255,0,0.333)":this._options.downColor||"rgba(255,0,0,0.333)",o=e?this._options.borderUpColor||n(i,1):this._options.borderDownColor||n(i,1),s=e?this._options.wickUpColor||o:this._options.wickDownColor||o;return{open:c,close:h,high:d,low:p,isUp:e,x1:r+this.offset,x2:r+this.offset,isInProgress:!1,originalData:{...t,x1:a},barSpacing:this._barWidth,color:i,borderColor:o,wickColor:s,lineStyle:this._options.lineStyle,lineWidth:this._options.lineWidth,shape:this._options.shape??"Rounded"}}return{value:u,isUp:void 0,x1:r+this.offset,x2:r+this.offset,isInProgress:!1,originalData:t,barSpacing:this._options.barSpacing??.8}})),r=this._options.chandelierSize??1;if(r<=1)return a;const l=[];for(let e=0;e<a.length;e+=r){const t=a.slice(e,e+r);if(0===t.length)continue;const i=t.length<r&&e+t.length===a.length,o=this._chandelier(t,i,r);l.push(o)}return l}_chandelier(e,t=!1,i){if(0===e.length)throw new Error("Bucket cannot be empty in _chandelier method.");const o=e[0].x1,s=e[e.length-1].x2;if(void 0!==e[0].originalData?.open){const i=e[0].open??0,a=e[e.length-1].close??0,r=e.reduce(((e,t)=>Math.max(e,t.high||0)),0),l=e.reduce(((e,t)=>Math.min(e,t.low||1/0)),1/0),c=a>i,h=c?this._options.upColor||"rgba(0,255,0,0.333)":this._options.downColor||"rgba(255,0,0,0.333)",d=c?this._options.borderUpColor||n(h,1):this._options.borderDownColor||n(h,1),p=c?this._options.wickUpColor||d:this._options.wickDownColor||d,u=e.reduce(((e,t)=>t.lineStyle??t.originalData?.lineStyle??e),this._options.lineStyle),m=e.reduce(((e,t)=>t.lineWidth??t.originalData?.lineWidth??e),this._options.lineWidth??1);return{open:i,high:r,low:l,close:a,isUp:c,x1:o,x2:s,isInProgress:t,color:h,borderColor:d,wickColor:p,shape:this._options.shape??"Rounded",lineStyle:u,lineWidth:m}}{const t=e[0].value??0,i=(e[e.length-1].value??0)>t,a=i?this._options.upColor||"rgba(0,255,0,0.333)":this._options.downColor||"rgba(255,0,0,0.333)";i?this._options.borderUpColor||n(a,1):this._options.borderDownColor||n(a,1);i?this._options.wickUpColor:this._options.wickDownColor;const r=e.reduce(((e,t)=>t.lineStyle??t.originalData?.lineStyle??e),this._options.lineStyle),l=e.reduce(((e,t)=>t.lineWidth??t.originalData?.lineWidth??e),this._options.lineWidth??1);return this._options.shape,{value:t,isUp:i,x1:o,x2:s,color:a,lineStyle:r,lineWidth:l}}}applyOptions(e){this._options={...this._options,...e},this.processSequence()}}class ne extends o{_type="TrendTrace";_paneViews;_sequence;_options;_state=D.NONE;_handler;_source;_originalP1=null;_originalP2=null;p1=null;p2=null;_points=[];title="";static _type="Trend-Trace";_startDragPoint=null;_latestHoverPoint=null;static _mouseIsDown=!1;static hoveredObject=null;static lastHoveredObject=null;_listeners=[];_hovered=!1;constructor(e,t,i,o,n,s){super(),this._handler=e,this._source=t,this._originalP1={...i},this._originalP2={...o};const a=this._source.options(),r=function(e,t){const i={};for(const o in e)Object.prototype.hasOwnProperty.call(t,o)&&(i[o]=t[o]);return i}(ie,a);this._options={...r,...n},this._sequence=this._createSequence({p1:i,p2:o},this._options,s),this.p1=this._sequence.p1,this.p2=this._sequence.p2,this._subscribeEvents(),this._paneViews=[new se(this)]}toJSON(){return{data:this._sequence.data,p1:this._sequence._originalP1,p2:this._sequence._originalP2,options:this._sequence._options}}fromJSON(e){if(e.data&&this._sequence.setData(e.data),e.options){const t=e.options;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){const i=e;this.applyOptions({[i]:t[i]})}}e.p1&&(this.p1=e.p1),e.p2&&(this.p2=e.p2)}attached(e){super.attached(e),this._originalP1&&this._originalP2&&this._createSequence({p1:this._originalP1,p2:this._originalP2}),this._source=Z(e.series,this._handler.legend),this.title=e.series.options().title;const i=new(t.defaultHorzScaleBehavior());return{chart:e.chart,series:e.series,requestUpdate:e.requestUpdate,horzScaleBehavior:i}}paneViews(){return this._paneViews}detached(){super.detached(),this._listeners.forEach((({name:e,listener:t})=>{document.body.removeEventListener(e,t)})),this._listeners=[],this._handler?.chart&&(this._handler.chart.unsubscribeCrosshairMove(this._handleMouseMove),this._handler.chart.unsubscribeClick(this._handleMouseDownOrUp)),this._paneViews=[],this._sequence=null,this._options=null,this._source=null,this._originalP1=null,this._originalP2=null,this.p1=null,this.p2=null,console.log("✅ All listeners and references successfully detached.")}_createSequence(e,t,i){let o;return"p1"in e&&"p2"in e?(o=new oe(this._handler,this._source,e.p1,e.p2,t??this._options,i),o.onComplete=()=>this.updateViewFromSequence(),this.updateViewFromSequence(),o):(o=new oe(this._handler,e.data,e.data._originalP1,e.data._originalP2,t??this._options,i),o.onComplete=()=>this.updateViewFromSequence(),this.updateViewFromSequence(),o)}applyOptions(e){this._options={...this._options,...e},this._sequence&&this._sequence.applyOptions(this._options),this.requestUpdate()}_pendingUpdate=!1;updateViewFromSequence(){this._pendingUpdate||(this._pendingUpdate=!0,requestAnimationFrame((()=>{super.requestUpdate(),console.log("Updating view with sequence data:",this._sequence?.data),this._pendingUpdate=!1})))}getOptions(){return this._options}_subscribeEvents(){this._handler.chart.subscribeCrosshairMove(this._handleMouseMove),this._handler.chart.subscribeClick(this._handleMouseDownOrUp)}_subscribe(e,t){document.body.addEventListener(e,t),this._listeners.push({name:e,listener:t})}_unsubscribe(e,t){document.body.removeEventListener(e,t);const i=this._listeners.find((i=>i.name===e&&i.listener===t));this._listeners.splice(this._listeners.indexOf(i),1)}_handleHoverInteraction(e){if(this._latestHoverPoint=e.point,ne._mouseIsDown)this._handleDragInteraction(e);else if(this._mouseIsOverSequence(e)){if(this._state!=D.NONE)return;this._moveToState(D.HOVERING),ne.hoveredObject=ne.lastHoveredObject=this}else{if(this._state==D.NONE)return;this._moveToState(D.NONE),ne.hoveredObject===this&&(ne.hoveredObject=null)}}_handleMouseDownOrUp=()=>{this._latestHoverPoint&&(ne._mouseIsDown=!ne._mouseIsDown,ne._mouseIsDown?this._onMouseDown():this._onMouseUp())};_handleMouseMove=e=>{const t=this._eventToPoint(e,this._source);this._latestHoverPoint=t,ne._mouseIsDown?this._handleDragInteraction(e):this._mouseIsOverPoint(e,1)||this._mouseIsOverPoint(e,2)||this._mouseIsOverSequence(e)?this._state===D.NONE&&this._moveToState(D.HOVERING):this._state!==D.NONE&&this._moveToState(D.NONE)};_onMouseUp(){ne._mouseIsDown=!1,this.chart.applyOptions({handleScroll:!0}),this._moveToState(D.HOVERING),this._startDragPoint=null}_handleDragInteraction(e){if(this._state!==D.DRAGGING&&this._state!==D.DRAGGINGP1&&this._state!==D.DRAGGINGP2)return;const t=this._eventToPoint(e,this.series);if(!t||!this._startDragPoint)return;const i=this._getDiff(t,this._startDragPoint);this._onDrag(i),this._startDragPoint=t,this.requestUpdate()}_mouseIsOverPoint(e,t){const i=1===t?{x:this._paneViews[0]._p1.x,y:this._paneViews[0]._p1.y}:{x:this._paneViews[0]._p2.x,y:this._paneViews[0]._p2.y};return!!this.chart&&function(e,t,i,o){const n=function(e){if(!e)return null;const t=e.paneSize();return{width:t.width,height:t.height}}(o);if(!n)return!1;const s=n.width,a=n.height,r=s*i,l=a*i,c=function(e){if(e instanceof MouseEvent)return(t=e)?{x:t.x,y:t.y}:null;var t;if("point"in e&&e.point)return e.point;return null}(e);if(!c||null==c.x||null==c.y||null==t.x||null==t.y)return!1;const h=Math.abs(t.x-c.x),d=Math.abs(t.y-c.y);return h<=r&&d<=l}(e,i,.05,this.chart)}_mouseIsOverSequence(e){if(!e.logical||!e.point)return console.warn("Invalid MouseEventParams: Missing logical or point."),!1;const t=this._source.coordinateToPrice?.(e.point.y);if(null==t)return console.warn("Mouse price could not be determined."),!1;let i=e.time?this._sequence.data.find((t=>t.time===e.time)):void 0;if(i||(i=this._sequence.data.find((t=>Math.round(t.x1)===Math.round(e.logical)))),!i)return console.warn("No matching bar found for the given parameters."),!1;if(null!=i.low&&null!=i.high){const e=.05*(i.high-i.low);return t>=i.low-e&&t<=i.high+e}if(null!=i.value){const e=.05*i.value;return t>=i.value-e&&t<=i.value+e}return console.warn("Bar lacks price information."),!1}_moveToState(e){switch(e){case D.NONE:document.body.style.cursor="default",this._hovered=!1,this.requestUpdate(),this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case D.HOVERING:document.body.style.cursor="pointer",this._hovered=!0,this.requestUpdate(),this._subscribe("mousedown",this._handleMouseDownInteraction),this._unsubscribe("mouseup",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case D.DRAGGINGP1:case D.DRAGGINGP2:case D.DRAGGING:document.body.style.cursor="grabbing",this._subscribe("mouseup",this._handleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_addDiffToPoint(e,t,i){e&&(e.logical=e.logical+t,e.price=e.price+i,e.time=this.series.dataByIndex(e.logical)?.time||null)}_onDrag(e){this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP1||this._addDiffToPoint(this._sequence.p1,this._options.xScaleLock&&this._state==D.DRAGGINGP1?0:e.logical,this._options.yScaleLock&&this._state==D.DRAGGINGP1?0:e.price),this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP2||this._addDiffToPoint(this._sequence.p2,this._options.xScaleLock&&this._state==D.DRAGGINGP2?0:e.logical,this._options.yScaleLock&&this._state==D.DRAGGINGP2?0:e.price)}_onMouseDown(){this._startDragPoint=null;const e=this._latestHoverPoint;if(!e)return;const t=this._paneViews[0]._p1,i=this._paneViews[0]._p2;if(!(t.x&&i.x&&t.y&&i.y))return this._moveToState(D.DRAGGING);Math.abs(e.x-t.x)<20&&Math.abs(e.y-t.y)<20?(this.chart.applyOptions({handleScroll:!1}),this._moveToState(D.DRAGGINGP1)):Math.abs(e.x-i.x)<20&&Math.abs(e.y-i.y)<20?(this.chart.applyOptions({handleScroll:!1}),this._moveToState(D.DRAGGINGP2)):(this.chart.applyOptions({handleScroll:!1}),this._moveToState(D.DRAGGING))}_handleMouseDownInteraction=()=>{this._onMouseDown()};_handleMouseUpInteraction=()=>{this._onMouseUp()};_getDiff(e,t){return{logical:e.logical-t.logical,price:e.price-t.price}}_eventToPoint(e,t){if(!t||!e.point||!e.logical)return null;const i=t.coordinateToPrice(e.point.y);return null==i?null:{time:e.time||null,logical:e.logical,price:i.valueOf()}}}class se{_p1={x:null,y:null};_p2={x:null,y:null};_plugin;constructor(e){this._plugin=e}renderer(){if(!this._plugin._sequence)throw new Error("No sequence available for rendering.");return new ae(this._plugin,this._plugin._options,!1)}}class ae extends U{_source;_options;constructor(e,t,i){super(O(e._sequence.p1,e.chart,e._source),O(e._sequence.p2,e.chart,e._source),t,i),this._source=e,this._options=t}draw(e){e.useBitmapCoordinateSpace((e=>{const t=e.context,{chart:i}=this._source;t.save();const{horizontalPixelRatio:o}=e,n=this._source._sequence.data,s=this._source.chart.timeScale(),a=this._source._source,r=i.timeScale().getVisibleLogicalRange(),l=i.options().width/((r?.to??n.length)-(r?.from??0));if(console.log("barSpace:",l),!a||!s||0===n.length)return void t.restore();const c=n[0].x1,h=n[n.length-1].x1,d=i.timeScale().logicalToCoordinate(c)??0,p=i.timeScale().logicalToCoordinate(h)??d,u=d*o,m=p*o,g=this._source._sequence._originalP2.logical>this._source._sequence._originalP1.logical&&this._source._sequence.p2.logical>this._source._sequence.p1.logical||this._source._sequence._originalP2.logical<this._source._sequence._originalP1.logical&&this._source._sequence.p2.logical<this._source._sequence.p1.logical,y=n.map(((e,t)=>{const i=u+(g?1:-1)*(t*((m-u)/n.length)*this._source._sequence.spatial.scale.x),o=u+(g?1:-1)*((t+1)*((m-u)/n.length)*this._source._sequence.spatial.scale.x),s=e.isUp?g?this._options.upColor:this._options.downColor:g?this._options.downColor:this._options.upColor,a=e.isUp?g?this._options.borderUpColor:this._options.borderDownColor:g?this._options.borderDownColor:this._options.borderUpColor,r=e.isUp?g?this._options.wickUpColor:this._options.wickDownColor:g?this._options.wickDownColor:this._options.wickUpColor;return{...e,scaledX1:g?i:o,scaledX2:g?o:i,color:s,borderColor:a,wickColor:r}})).filter((e=>null!==e));console.log("Scaled bars:",y),this.isOHLCData(n)?(this._options.wickVisible&&this._drawWicks(e,y,l),this._drawCandles(e,y,l)):this.isSingleValueData(n)&&this._drawSingleValueData(e,y),t.restore()}))}_drawSingleValueData(e,t){const{context:i,horizontalPixelRatio:o,verticalPixelRatio:n}=e;i.lineWidth=this._options.lineWidth??1,te(i,this._options.lineStyle??1),i.strokeStyle=this._options.visible?this._options.lineColor??"#ffffff":"rgba(0,0,0,0)",i.beginPath(),t.forEach((e=>{if(null===e.x1||void 0===e.x1)return;const t=e.scaledX1*o,s=(this._source._source?.priceToCoordinate(e.value??0)??0)*n;i.lineTo(t,s),i.stroke()}))}_drawWicks(e,t,i){const{context:o,verticalPixelRatio:n}=e,s=this._source._sequence._originalP2.price>this._source._sequence._originalP1.price&&this._source._sequence.p2.price>this._source._sequence.p1.price||this._source._sequence._originalP2.price<this._source._sequence._originalP1.price&&this._source._sequence.p2.price<this._source._sequence.p1.price;t.forEach((e=>{const t=(this._options.barSpacing??.8)*(e.scaledX2-e.scaledX1),i=e.scaledX1,a=(i+(i+t))/2,r=(this._source.series.priceToCoordinate(e.high??0)??0)*n,l=(this._source.series.priceToCoordinate(e.low??0)??0)*n,c=(this._source.series.priceToCoordinate(e.open??0)??0)*n,h=(this._source.series.priceToCoordinate(e.close??0)??0)*n,d=s?Math.min(c,h):Math.max(c,h),p=s?Math.max(c,h):Math.min(c,h);o.strokeStyle=this._options.visible?e.wickColor??"#ffffff":"rgba(0,0,0,0)",o.beginPath(),o.moveTo(a,r),o.lineTo(a,d),o.stroke(),o.beginPath(),o.moveTo(a,p),o.lineTo(a,l),o.stroke()}))}_drawCandles(e,t,i){const{context:o,horizontalPixelRatio:n,verticalPixelRatio:s}=e;o.save(),t.forEach((e=>{const t=(this._options.barSpacing??.8)*(e.scaledX2-e.scaledX1);if(!e)return;const i=(this._source.series.priceToCoordinate(e.open)??0)*s,n=(this._source.series.priceToCoordinate(e.close)??0)*s,a=(this._source.series.priceToCoordinate(e.high)??0)*s,l=(this._source.series.priceToCoordinate(e.low)??0)*s,c=n>=i,h=Math.min(i,n),d=Math.max(i,n),p=h-d,u=(h+d)/2,m=e.scaledX1,g=m+t,y=(m+g)/2;o.fillStyle=this._options.visible?e.color??"#ffffff":"rgba(0,0,0,0)",o.strokeStyle=this._options.visible?(this._options.borderVisible?e.borderColor:e.color)??"#ffffff":"rgba(0,0,0,0)",o.lineWidth=e.lineWidth??1,te(o,e.lineStyle);const f=this._options?.shape||r.Rounded;switch(console.log("Selected candle shape:",f),f){case r.Rectangle:N(o,m,g,u,p);break;case r.Rounded:A(o,m,g,u,p,5);break;case r.Ellipse:V(o,m,g,0,u,p);break;case r.Arrow:G(o,m,g,y,u,p,a,l,c);break;case r.Polygon:R(o,m,g,u,p,a,l,c);break;case r.Bar:B(o,m,g,a,l,i,n);break;default:console.warn(`Unknown shape '${f}', using default Rectangle`),N(o,m,g,u,p)}o.restore()}))}_drawEndCircle(e,t,i){const o=e.context;o.save(),o.beginPath(),o.arc(t,i,5,0,2*Math.PI),o.fillStyle=this._options.visible?this._options?.color??"#FF0000":"rgba(0,0,0,0)",o.fill(),o.strokeStyle=this._source._sequence._options.lineColor??"#000",o.stroke(),o.restore()}isOHLCData(e){return e.every((e=>void 0!==e.open&&void 0!==e.high&&void 0!==e.low&&void 0!==e.close))}isSingleValueData(e){return e.every((e=>void 0!==e.value))}}const re={TrendTrace:ne};class le extends L{_paneViews=[];_hovered=!1;linkedObjects=[];constructor(e,t,i){super(),this.points.push(e),this.points.push(t),this._options={...T,...i}}setFirstPoint(e){this.updatePoints(e)}setSecondPoint(e){this.updatePoints(null,e)}detach(){this.linkedObjects.forEach((e=>{const t=e.series;t&&t.detachPrimitive(e)})),this.linkedObjects=[],super.detach()}get p1(){return this.points[0]}get p2(){return this.points[1]}get hovered(){return this._hovered}toJSON(){return{points:this.points,_options:this._options,linkedObjects:this.linkedObjects.map((e=>"function"==typeof e.toJSON?e.toJSON():{}))}}fromJSON(e){e&&(e.points&&Array.isArray(e.points)&&e.points.length>=2&&this.updatePoints(e.points[0],e.points[1]),e._options&&(this._options={...this._options,...e._options}),e.linkedObjects&&Array.isArray(e.linkedObjects)&&(this.linkedObjects=e.linkedObjects.map((e=>{const t=e._type;if(!t)return console.warn("Linked object JSON missing _type property."),null;const i=re[t];if(!i)return console.warn(`No constructor found in registry for type: ${t}`),null;const o=new i;return"function"==typeof o.fromJSON&&o.fromJSON(e),o})).filter((e=>null!==e))),this.requestUpdate())}}class ce extends L{_paneViews=[];_hovered=!1;linkedObjects=[];detach(){this.linkedObjects.forEach((e=>{const t=e.series;t&&t.detachPrimitive(e)})),this.linkedObjects=[],super.detach()}constructor(e,t,i,o){super(),this.points.push(e),this.points.push(t),this.points.push(i),this._options={...T,...o}}setFirstPoint(e){this.updatePoints(e)}setSecondPoint(e){this.updatePoints(null,e)}setThirdPoint(e){this.updatePoints(null,null,e)}get p1(){return this.points[0]}get p2(){return this.points[1]}get p3(){return this.points[2]}get hovered(){return this._hovered}toJSON(){return{points:this.points,_options:this._options,linkedObjects:this.linkedObjects.map((e=>"function"==typeof e.toJSON?e.toJSON():{}))}}fromJSON(e){e&&(e.points&&Array.isArray(e.points)&&e.points.length>=2&&this.updatePoints(e.points[0],e.points[1]),e._options&&(this._options={...this._options,...e._options}),e.linkedObjects&&Array.isArray(e.linkedObjects)&&(this.linkedObjects=e.linkedObjects.map((e=>{const t=e._type;if(!t)return console.warn("Linked object JSON missing _type property."),null;const i=re[t];if(!i)return console.warn(`No constructor found in registry for type: ${t}`),null;const o=new i;return"function"==typeof o.fromJSON&&o.fromJSON(e),o})).filter((e=>null!==e))),this.requestUpdate())}}class he extends L{_paneViews=[];_hovered=!1;linkedObjects=[];detach(){this.linkedObjects.forEach((e=>{const t=e.series;t&&t.detachPrimitive(e)})),this.linkedObjects=[],super.detach()}constructor(e,t,i,o,n){super(),this.points.push(e),this.points.push(t),this.points.push(i),this.points.push(o),this._options={...T,...n}}setFirstPoint(e){this.updatePoints(e)}setSecondPoint(e){this.updatePoints(null,e)}setThirdPoint(e){this.updatePoints(null,null,e)}setFourthPoint(e){this.updatePoints(null,null,null,e)}get p1(){return this.points[0]}get p2(){return this.points[1]}get p3(){return this.points[2]}get p4(){return this.points[3]}get hovered(){return this._hovered}}class de{_chart;_series;_finishDrawingCallback=null;_drawings=[];_activeDrawing=null;_isDrawing=!1;_drawingType=null;_tempStartPoint=null;_tempSecondPoint=null;_clickCount=0;constructor(e,t,i=null){this._chart=e,this._series=t,this._finishDrawingCallback=i,this._chart.subscribeClick(this._clickHandler),this._chart.subscribeCrosshairMove(this._moveHandler)}_clickHandler=e=>this._onClick(e);_moveHandler=e=>this._onMouseMove(e);beginDrawing(e){this._drawingType=e,this._isDrawing=!0,this._tempStartPoint=null,this._tempSecondPoint=null,this._clickCount=0}stopDrawing(){this._isDrawing=!1,this._activeDrawing=null,this._tempStartPoint=null,this._tempSecondPoint=null,this._clickCount=0}get drawings(){return this._drawings}addNewDrawing(e){this._series.attachPrimitive(e),this._drawings.push(e)}delete(e){if(null==e)return;const t=this._drawings.indexOf(e);-1!=t&&(this._drawings.splice(t,1),e.detach())}clearDrawings(){for(const e of this._drawings)e.detach();this._drawings=[]}repositionOnTime(){for(const e of this.drawings){const t=[];for(const i of e.points){if(!i){t.push(i);continue}const e=i.time?this._chart.timeScale().coordinateToLogical(this._chart.timeScale().timeToCoordinate(i.time)||0):i.logical;t.push({time:i.time,logical:e,price:i.price})}e.updatePoints(...t)}}_onClick(e){if(!this._isDrawing)return;const t=L._eventToPoint(e,this._series);if(!t)return;let i;if(this._drawingType)if(i=this._drawingType.prototype instanceof he?4:this._drawingType.prototype instanceof ce?3:(this._drawingType.prototype,2),3===i){if(null==this._activeDrawing)return null==this._tempStartPoint?(this._tempStartPoint=t,void(this._clickCount=1)):(this._activeDrawing=new this._drawingType(this._tempStartPoint,t,null),this._series.attachPrimitive(this._activeDrawing),this._clickCount=2,void(this._tempStartPoint=null));2===this._clickCount&&(this._activeDrawing.setThirdPoint(t),this._clickCount=3,this._drawings.push(this._activeDrawing),this.stopDrawing(),this._finishDrawingCallback&&this._finishDrawingCallback())}else if(4===i){if(null==this._activeDrawing)return null==this._tempStartPoint?(this._tempStartPoint=t,void(this._clickCount=1)):null==this._tempSecondPoint?(this._tempSecondPoint=t,void(this._clickCount=2)):(this._activeDrawing=new this._drawingType(this._tempStartPoint,this._tempSecondPoint,t,null),this._series.attachPrimitive(this._activeDrawing),this._clickCount=3,this._tempStartPoint=null,void(this._tempSecondPoint=null));3===this._clickCount&&(this._activeDrawing.setFourthPoint(t),this._clickCount=4,this._drawings.push(this._activeDrawing),this.stopDrawing(),this._finishDrawingCallback&&this._finishDrawingCallback())}else null==this._activeDrawing?(this._activeDrawing=new this._drawingType(t,t),this._series.attachPrimitive(this._activeDrawing),this._clickCount=1):(this._activeDrawing.setSecondPoint(t),this._clickCount=2,this._drawings.push(this._activeDrawing),this.stopDrawing(),this._finishDrawingCallback&&this._finishDrawingCallback())}_onMouseMove(e){if(!e)return;for(const t of this._drawings)t._handleHoverInteraction(e);if(!this._isDrawing||!this._activeDrawing)return;const t=L._eventToPoint(e,this._series);if(!t)return;const i=this._drawingType&&this._drawingType.prototype instanceof ce;this._drawingType&&this._drawingType.prototype instanceof he?2===this._clickCount?this._activeDrawing.updatePoints(null,null,t,null):3===this._clickCount&&this._activeDrawing.updatePoints(null,null,null,t):i?2===this._clickCount&&this._activeDrawing.updatePoints(null,null,t):this._activeDrawing.setSecondPoint(t)}}class pe extends U{constructor(e,t,i,o){super(e,t,i,o)}draw(e){e.useBitmapCoordinateSpace((e=>{if(null===this._p1.x||null===this._p1.y||null===this._p2.x||null===this._p2.y)return;const t=e.context,i=this._getScaledCoordinates(e);i&&(t.lineWidth=this._options.width,t.strokeStyle=this._options.lineColor,te(t,this._options.lineStyle),t.beginPath(),t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2),t.stroke(),this._hovered&&(this._drawEndCircle(e,i.x1,i.y1),this._drawEndCircle(e,i.x2,i.y2)))}))}}class ue{_source;constructor(e){this._source=e}}class me extends ue{_p1={x:null,y:null};_p2={x:null,y:null};_source;constructor(e){super(e),this._source=e}update(){if(!this._source.p1||!this._source.p2)return;const e=this._source.series,t=e.priceToCoordinate(this._source.p1.price),i=e.priceToCoordinate(this._source.p2.price),o=this._getX(this._source.p1),n=this._getX(this._source.p2);this._p1={x:o,y:t},this._p2={x:n,y:i}}_getX(e){return this._source.chart.timeScale().logicalToCoordinate(e.logical)}}class ge extends ue{_p1={x:null,y:null};_p2={x:null,y:null};_p3={x:null,y:null};_source;constructor(e){super(e),this._source=e}update(){if(!this._source.p1||!this._source.p2||!this._source.p3)return;const e=this._source.series,t=e.priceToCoordinate(this._source.p1.price),i=e.priceToCoordinate(this._source.p2.price),o=e.priceToCoordinate(this._source.p3.price),n=this._getX(this._source.p1),s=this._getX(this._source.p2),a=this._getX(this._source.p3);this._p1={x:n,y:t},this._p2={x:s,y:i},this._p3={x:a,y:o}}_getX(e){return this._source.chart.timeScale().logicalToCoordinate(e.logical)}}class ye extends me{constructor(e){super(e)}renderer(){return new pe(this._p1,this._p2,this._source._options,this._source.hovered)}}class fe extends le{_type="TrendLine";constructor(e,t,i){super(e,t,i),this._paneViews=[new ye(this)]}_moveToState(e){switch(e){case D.NONE:document.body.style.cursor="default",this._hovered=!1,this.requestUpdate(),this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case D.HOVERING:document.body.style.cursor="pointer",this._hovered=!0,this.requestUpdate(),this._subscribe("mousedown",this._handleMouseDownInteraction),this._unsubscribe("mouseup",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case D.DRAGGINGP1:case D.DRAGGINGP2:case D.DRAGGING:document.body.style.cursor="grabbing",this._subscribe("mouseup",this._handleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_onDrag(e){this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP1||this._addDiffToPoint(this.p1,e.logical,e.price),this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP2||this._addDiffToPoint(this.p2,e.logical,e.price)}_onMouseDown(){this._startDragPoint=null;const e=this._latestHoverPoint;if(!e)return;const t=this._paneViews[0]._p1,i=this._paneViews[0]._p2;if(!(t.x&&i.x&&t.y&&i.y))return this._moveToState(D.DRAGGING);Math.abs(e.x-t.x)<10&&Math.abs(e.y-t.y)<10?this._moveToState(D.DRAGGINGP1):Math.abs(e.x-i.x)<10&&Math.abs(e.y-i.y)<10?this._moveToState(D.DRAGGINGP2):this._moveToState(D.DRAGGING)}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this._paneViews[0]._p1.x,o=this._paneViews[0]._p1.y,n=this._paneViews[0]._p2.x,s=this._paneViews[0]._p2.y;if(!(i&&n&&o&&s))return!1;const a=e.point.x,r=e.point.y;if(a<=Math.min(i,n)-t||a>=Math.max(i,n)+t)return!1;return Math.abs((s-o)*a-(n-i)*r+n*o-s*i)/Math.sqrt((s-o)**2+(n-i)**2)<=t}}class _e extends U{constructor(e,t,i,o){super(e,t,i,o)}draw(e){e.useBitmapCoordinateSpace((e=>{const t=e.context,i=this._getScaledCoordinates(e);if(!i)return;t.lineWidth=this._options.width,t.strokeStyle=this._options.lineColor,te(t,this._options.lineStyle),t.fillStyle=this._options.fillColor;const o=Math.min(i.x1,i.x2),n=Math.min(i.y1,i.y2),s=Math.abs(i.x1-i.x2),a=Math.abs(i.y1-i.y2);t.strokeRect(o,n,s,a),t.fillRect(o,n,s,a),this._hovered&&(this._drawEndCircle(e,o,n),this._drawEndCircle(e,o+s,n),this._drawEndCircle(e,o+s,n+a),this._drawEndCircle(e,o,n+a))}))}}class ve extends me{constructor(e){super(e)}renderer(){return new _e(this._p1,this._p2,this._source._options,this._source.hovered)}}const be={fillEnabled:!0,fillColor:"rgba(255, 255, 255, 0.2)",...T};class we extends le{_type="Box";constructor(e,t,i){super(e,t,i),this._options={...be,...i},this._paneViews=[new ve(this)]}_moveToState(e){switch(e){case D.NONE:document.body.style.cursor="default",this._hovered=!1,this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case D.HOVERING:document.body.style.cursor="pointer",this._hovered=!0,this._unsubscribe("mouseup",this._handleMouseUpInteraction),this._subscribe("mousedown",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case D.DRAGGINGP1:case D.DRAGGINGP2:case D.DRAGGINGP3:case D.DRAGGINGP4:case D.DRAGGING:document.body.style.cursor="grabbing",document.body.addEventListener("mouseup",this._handleMouseUpInteraction),this._subscribe("mouseup",this._handleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_onDrag(e){this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP1||this._addDiffToPoint(this.p1,e.logical,e.price),this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP2||this._addDiffToPoint(this.p2,e.logical,e.price),this._state!=D.DRAGGING&&(this._state==D.DRAGGINGP3&&(this._addDiffToPoint(this.p1,e.logical,0),this._addDiffToPoint(this.p2,0,e.price)),this._state==D.DRAGGINGP4&&(this._addDiffToPoint(this.p1,0,e.price),this._addDiffToPoint(this.p2,e.logical,0)))}_onMouseDown(){this._startDragPoint=null;const e=this._latestHoverPoint,t=this._paneViews[0]._p1,i=this._paneViews[0]._p2;if(!(t.x&&i.x&&t.y&&i.y))return this._moveToState(D.DRAGGING);const o=10;Math.abs(e.x-t.x)<o&&Math.abs(e.y-t.y)<o?this._moveToState(D.DRAGGINGP1):Math.abs(e.x-i.x)<o&&Math.abs(e.y-i.y)<o?this._moveToState(D.DRAGGINGP2):Math.abs(e.x-t.x)<o&&Math.abs(e.y-i.y)<o?this._moveToState(D.DRAGGINGP3):Math.abs(e.x-i.x)<o&&Math.abs(e.y-t.y)<o?this._moveToState(D.DRAGGINGP4):this._moveToState(D.DRAGGING)}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this._paneViews[0]._p1.x,o=this._paneViews[0]._p1.y,n=this._paneViews[0]._p2.x,s=this._paneViews[0]._p2.y;if(!(i&&n&&o&&s))return!1;const a=e.point.x,r=e.point.y,l=Math.min(i,n),c=Math.min(o,s),h=Math.abs(i-n),d=Math.abs(o-s),p=t/2;return a>l-p&&a<l+h+p&&r>c-p&&r<c+d+p}}class xe extends F{_point={x:null,y:null};constructor(e,t){super(t),this._point=e}draw(e){e.useBitmapCoordinateSpace((e=>{if(null==this._point.y)return;const t=e.context,i=Math.round(this._point.y*e.verticalPixelRatio),o=this._point.x?this._point.x*e.horizontalPixelRatio:0;t.lineWidth=this._options.width,t.strokeStyle=this._options.lineColor,te(t,this._options.lineStyle),t.beginPath(),t.moveTo(o,i),t.lineTo(e.bitmapSize.width,i),t.stroke()}))}}class Ce extends ue{_source;_point={x:null,y:null};constructor(e){super(e),this._source=e}update(){const e=this._source._point,t=this._source.chart.timeScale(),i=this._source.series;"RayLine"==this._source._type&&(this._point.x=e.time?t.timeToCoordinate(e.time):t.logicalToCoordinate(e.logical)),this._point.y=i.priceToCoordinate(e.price)}renderer(){return new xe(this._point,this._source._options)}}class Me{_source;_y=null;_price=null;constructor(e){this._source=e}update(){if(!this._source.series||!this._source._point)return;this._y=this._source.series.priceToCoordinate(this._source._point.price);const e=this._source.series.options().priceFormat.precision;this._price=this._source._point.price.toFixed(e).toString()}visible(){return!0}tickVisible(){return!0}coordinate(){return this._y??0}text(){return this._source._options.text||this._price||""}textColor(){return"white"}backColor(){return this._source._options.lineColor}}class Se extends L{_type="HorizontalLine";_paneViews;_point;_callbackName;_priceAxisViews;_startDragPoint=null;constructor(e,t,i=null){super(t),this._point=e,this._point.time=null,this._paneViews=[new Ce(this)],this._priceAxisViews=[new Me(this)],this._callbackName=i}get points(){return[this._point]}updatePoints(...e){for(const t of e)t&&(this._point.price=t.price);this.requestUpdate()}updateAllViews(){this._paneViews.forEach((e=>e.update())),this._priceAxisViews.forEach((e=>e.update()))}priceAxisViews(){return this._priceAxisViews}_moveToState(e){switch(e){case D.NONE:document.body.style.cursor="default",this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case D.HOVERING:document.body.style.cursor="pointer",this._unsubscribe("mouseup",this._childHandleMouseUpInteraction),this._subscribe("mousedown",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case D.DRAGGING:document.body.style.cursor="grabbing",this._subscribe("mouseup",this._childHandleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_onDrag(e){this._addDiffToPoint(this._point,0,e.price),this.requestUpdate()}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this.series.priceToCoordinate(this._point.price);return!!i&&Math.abs(i-e.point.y)<t}_onMouseDown(){this._startDragPoint=null;if(this._latestHoverPoint)return this._moveToState(D.DRAGGING)}_childHandleMouseUpInteraction=()=>{this._handleMouseUpInteraction(),this._callbackName&&window.callbackFunction(`${this._callbackName}_~_${this._point.price.toFixed(8)}`)}}class ke extends Se{_type="RayLine";constructor(e,t){super({...e},t),this._point.time=e.time}updatePoints(...e){for(const t of e)t&&(this._point=t);this.requestUpdate()}_onDrag(e){this._addDiffToPoint(this._point,e.logical,e.price),this.requestUpdate()}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this.series.priceToCoordinate(this._point.price),o=this._point.time?this.chart.timeScale().timeToCoordinate(this._point.time):null;return!(!i||!o)&&(Math.abs(i-e.point.y)<t&&e.point.x>o-t)}}class Pe extends F{_point={x:null,y:null};constructor(e,t){super(t),this._point=e}draw(e){e.useBitmapCoordinateSpace((e=>{if(null==this._point.x)return;const t=e.context,i=this._point.x*e.horizontalPixelRatio;t.lineWidth=this._options.width,t.strokeStyle=this._options.lineColor,te(t,this._options.lineStyle),t.beginPath(),t.moveTo(i,0),t.lineTo(i,e.bitmapSize.height),t.stroke()}))}}class Te extends ue{_source;_point={x:null,y:null};constructor(e){super(e),this._source=e}update(){const e=this._source._point,t=this._source.chart.timeScale(),i=this._source.series;this._point.x=e.time?t.timeToCoordinate(e.time):t.logicalToCoordinate(e.logical),this._point.y=i.priceToCoordinate(e.price)}renderer(){return new Pe(this._point,this._source._options)}}class De{_source;_x=null;constructor(e){this._source=e}update(){if(!this._source.chart||!this._source._point)return;const e=this._source._point,t=this._source.chart.timeScale();this._x=e.time?t.timeToCoordinate(e.time):t.logicalToCoordinate(e.logical)}visible(){return!!this._source._options.text}tickVisible(){return!0}coordinate(){return this._x??0}text(){return this._source._options.text||""}textColor(){return"white"}backColor(){return this._source._options.lineColor}}class Le extends L{_type="VerticalLine";_paneViews;_timeAxisViews;_point;_callbackName;_startDragPoint=null;constructor(e,t,i=null){super(t),this._point=e,this._paneViews=[new Te(this)],this._callbackName=i,this._timeAxisViews=[new De(this)]}updateAllViews(){this._paneViews.forEach((e=>e.update())),this._timeAxisViews.forEach((e=>e.update()))}timeAxisViews(){return this._timeAxisViews}updatePoints(...e){for(const t of e)t&&(!t.time&&t.logical&&(t.time=this.series.dataByIndex(t.logical)?.time||null),this._point=t);this.requestUpdate()}get points(){return[this._point]}_moveToState(e){switch(e){case D.NONE:document.body.style.cursor="default",this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case D.HOVERING:document.body.style.cursor="pointer",this._unsubscribe("mouseup",this._childHandleMouseUpInteraction),this._subscribe("mousedown",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case D.DRAGGING:document.body.style.cursor="grabbing",this._subscribe("mouseup",this._childHandleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_onDrag(e){this._addDiffToPoint(this._point,e.logical,0),this.requestUpdate()}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this.chart.timeScale();let o;return o=this._point.time?i.timeToCoordinate(this._point.time):i.logicalToCoordinate(this._point.logical),!!o&&Math.abs(o-e.point.x)<t}_onMouseDown(){this._startDragPoint=null;if(this._latestHoverPoint)return this._moveToState(D.DRAGGING)}_childHandleMouseUpInteraction=()=>{this._handleMouseUpInteraction(),this._callbackName&&window.callbackFunction(`${this._callbackName}_~_${this._point.price.toFixed(8)}`)}}class Ee extends H{options;variant;constructor(e,t,i,o,n){super(e,t,i,o,n),this.options=o,this.variant=o.variant??"standard"}draw(e){e.useBitmapCoordinateSpace((e=>{if(null===this._p1.x||null===this._p1.y||null===this._p2.x||null===this._p2.y||null===this._p3.x||null===this._p3.y)return;const i=e.context,o=this._getScaledCoordinates(e);if(!o)return;const{x1:n,y1:s,x2:a,y2:r,x3:l,y3:c}=o,h=(a+l)/2,d=(r+c)/2;let p,u,m,g,y,f;const _=(this._options.length??1)*(a-n);if("inside"===this.variant){p=h,u=d;const e=(n+a)/2-l,t=(s+r)/2-c;let i=Math.atan2(t,e);Math.cos(i)<0&&(i+=Math.PI),m=p+_*Math.cos(i),g=u+_*Math.sin(i)}else{const{anchorX:e,anchorY:t}=this._computeAnchorPoint(this.variant,n,s,a,r),i=this._lineIntersection(n,s,a,r,h,d,e,t);i?[p,u]=i:(p=n,u=s);const o=h-p;m=p+_,g=u+(Math.abs(o)>1e-9?(d-u)/o:0)*_}if(y=m-p,f=g-u,i.lineWidth=this.options.width,i.strokeStyle=this.options.lineColor,te(i,this.options.lineStyle),te(i,t.LineStyle.Solid),i.beginPath(),i.moveTo(a,r),i.lineTo(l,c),i.stroke(),te(i,this.options.lineStyle),i.beginPath(),i.moveTo(n,s),i.lineTo(a,r),i.stroke(),i.beginPath(),i.moveTo(p,u),i.lineTo(m,g),i.stroke(),i.beginPath(),i.moveTo(a,r),i.lineTo(a+y,r+f),i.stroke(),i.beginPath(),i.moveTo(l,c),i.lineTo(l+y,c+f),i.stroke(),this.options.forkLines&&this.options.forkLines.length>0){const e=this.options.forkLines;for(let t=0;t<e.length;t++){const o=e[t],n=l+o.value*(a-l),s=c+o.value*(r-c),h=n+y,d=s+f;if(i.lineWidth=o.width,i.strokeStyle=o.color,te(i,o.style),i.beginPath(),i.moveTo(n,s),i.lineTo(h,d),i.stroke(),o.fillColor&&t<e.length-1){const p=e[t+1],u=l+p.value*(a-l),m=c+p.value*(r-c),g=u+y,_=m+f;i.save(),i.fillStyle=o.fillColor,i.beginPath(),i.moveTo(n,s),i.lineTo(h,d),i.lineTo(g,_),i.lineTo(u,m),i.closePath(),i.fill(),i.restore()}}}this._hovered&&(i.lineWidth=this.options.width+1,i.strokeStyle=this.options.lineColor,te(i,t.LineStyle.Solid),this._drawEndCircle(e,n,s),this._drawEndCircle(e,a,r),this._drawEndCircle(e,l,c))}))}_computeAnchorPoint(e,t,i,o,n){switch(e){case"standard":return{anchorX:t,anchorY:i};case"schiff":return{anchorX:t,anchorY:(i+n)/2};case"modifiedSchiff":return{anchorX:(t+o)/2,anchorY:(i+n)/2};case"inside":return{anchorX:t+.5*(o-t),anchorY:i+.5*(n-i)}}}_lineIntersection(e,t,i,o,n,s,a,r){const l=(r-s)*(i-e)-(a-n)*(o-t);if(Math.abs(l)<1e-9)return null;const c=((a-n)*(t-s)-(r-s)*(e-n))/l;return[e+c*(i-e),t+c*(o-t)]}}class Ie extends ge{constructor(e){super(e)}renderer(){return new Ee(this._p1,this._p2,this._p3,this._source._options,this._source.hovered)}}const Oe={lineColor:"#ffffff",lineStyle:t.LineStyle.LargeDashed,width:1,variant:"standard",forkLines:[{value:1,width:2,style:t.LineStyle.Solid,color:"#ff0000",fillColor:void 0},{value:.786,width:1,style:t.LineStyle.SparseDotted,color:"#000fff",fillColor:void 0},{value:.618,width:1,style:t.LineStyle.LargeDashed,color:"#ffffff",fillColor:void 0},{value:.5,width:2,style:t.LineStyle.Solid,color:"#ff0000",fillColor:void 0},{value:.382,width:1,style:t.LineStyle.LargeDashed,color:"#ffffff",fillColor:void 0},{value:.236,width:1,style:t.LineStyle.SparseDotted,color:"#000fff",fillColor:void 0},{value:0,width:2,style:t.LineStyle.Solid,color:"#ff0000",fillColor:void 0}],length:1};class Ne extends ce{_type="PitchFork";variant;constructor(e,t,i,o){super(e,t,i,{...Oe,...o}),this.variant=o?.variant||"standard",this._paneViews=[new Ie(this)]}_moveToState(e){switch(e){case D.NONE:document.body.style.cursor="default",this._hovered=!1,this.requestUpdate(),this._unsubscribe("mousedown",this._handleMouseDownInteraction);break;case D.HOVERING:document.body.style.cursor="pointer",this._hovered=!0,this.requestUpdate(),this._subscribe("mousedown",this._handleMouseDownInteraction),this._unsubscribe("mouseup",this._handleMouseDownInteraction),this.chart.applyOptions({handleScroll:!0});break;case D.DRAGGINGP1:case D.DRAGGINGP2:case D.DRAGGINGP3:case D.DRAGGING:document.body.style.cursor="grabbing",this._subscribe("mouseup",this._handleMouseUpInteraction),this.chart.applyOptions({handleScroll:!1})}this._state=e}_onDrag(e){this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP1||this._addDiffToPoint(this.p1,e.logical,e.price),this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP2||this._addDiffToPoint(this.p2,e.logical,e.price),this._state!=D.DRAGGING&&this._state!=D.DRAGGINGP3||this._addDiffToPoint(this.p3,e.logical,e.price)}_onMouseDown(){this._startDragPoint=null;const e=this._latestHoverPoint;if(!e)return;const t=this._paneViews[0]._p1,i=this._paneViews[0]._p2,o=this._paneViews[0]._p3;if(!(t.x&&i.x&&o.x&&t.y&&i.y&&o.y))return this._moveToState(D.DRAGGING);const n=10;Math.abs(e.x-t.x)<n&&Math.abs(e.y-t.y)<n?this._moveToState(D.DRAGGINGP1):Math.abs(e.x-i.x)<n&&Math.abs(e.y-i.y)<n?this._moveToState(D.DRAGGINGP2):Math.abs(e.x-o.x)<n&&Math.abs(e.y-o.y)<n?this._moveToState(D.DRAGGINGP3):this._moveToState(D.DRAGGING)}_mouseIsOverDrawing(e,t=4){if(!e.point)return!1;const i=this._paneViews[0]._p1.x,o=this._paneViews[0]._p1.y,n=this._paneViews[0]._p2.x,s=this._paneViews[0]._p2.y,a=this._paneViews[0]._p3.x,r=this._paneViews[0]._p3.y;if(null==i||null==o||null==n||null==s||null==a||null==r)return!1;const l=e.point.x,c=e.point.y;if(l<Math.min(i,n,a)-t||l>Math.max(i,n,a)+t)return!1;const h=this._distanceFromSegment(i,o,n,s,l,c),d=this._distanceFromSegment(n,s,a,r,l,c),p=this._distanceFromSegment(i,o,a,r,l,c);return h<=t||d<=t||p<=t}_distanceFromSegment(e,t,i,o,n,s){const a=i-e,r=o-t,l=a*a+r*r;let c,h,d=0!==l?((n-e)*a+(s-t)*r)/l:-1;d<0?(c=e,h=t):d>1?(c=i,h=o):(c=e+d*a,h=t+d*r);const p=n-c,u=s-h;return Math.sqrt(p*p+u*u)}fromJSON(e){if(e.options){const t=e.options;for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)){const i=e;this.applyOptions({[i]:t[i]})}}}toJSON(){return{options:this._options}}title="PitchFork"}class Ae{static TREND_SVG='<rect x="3.84" y="13.67" transform="matrix(0.7071 -0.7071 0.7071 0.7071 -5.9847 14.4482)" width="21.21" height="1.56"/><path d="M23,3.17L20.17,6L23,8.83L25.83,6L23,3.17z M23,7.41L21.59,6L23,4.59L24.41,6L23,7.41z"/><path d="M6,20.17L3.17,23L6,25.83L8.83,23L6,20.17z M6,24.41L4.59,23L6,21.59L7.41,23L6,24.41z"/>';static HORZ_SVG='<rect x="4" y="14" width="9" height="1"/><rect x="16" y="14" width="9" height="1"/><path d="M11.67,14.5l2.83,2.83l2.83-2.83l-2.83-2.83L11.67,14.5z M15.91,14.5l-1.41,1.41l-1.41-1.41l1.41-1.41L15.91,14.5z"/>';static RAY_SVG='<rect x="8" y="14" width="17" height="1"/><path d="M3.67,14.5l2.83,2.83l2.83-2.83L6.5,11.67L3.67,14.5z M7.91,14.5L6.5,15.91L5.09,14.5l1.41-1.41L7.91,14.5z"/>';static BOX_SVG='<rect x="8" y="6" width="12" height="1"/><rect x="9" y="22" width="11" height="1"/><path d="M3.67,6.5L6.5,9.33L9.33,6.5L6.5,3.67L3.67,6.5z M7.91,6.5L6.5,7.91L5.09,6.5L6.5,5.09L7.91,6.5z"/><path d="M19.67,6.5l2.83,2.83l2.83-2.83L22.5,3.67L19.67,6.5z M23.91,6.5L22.5,7.91L21.09,6.5l1.41-1.41L23.91,6.5z"/><path d="M19.67,22.5l2.83,2.83l2.83-2.83l-2.83-2.83L19.67,22.5z M23.91,22.5l-1.41,1.41l-1.41-1.41l1.41-1.41L23.91,22.5z"/><path d="M3.67,22.5l2.83,2.83l2.83-2.83L6.5,19.67L3.67,22.5z M7.91,22.5L6.5,23.91L5.09,22.5l1.41-1.41L7.91,22.5z"/><rect x="22" y="9" width="1" height="11"/><rect x="6" y="9" width="1" height="11"/>';static VERT_SVG=Ae.RAY_SVG;static PITCHFORK_SVG='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><g fill="#ffffff" fill-rule="nonzero"><path d="M7.275 21.432l12.579-12.579-.707-.707-12.579 12.579z"/><path d="M6.69 13.397l7.913 7.913.707-.707-7.913-7.913z"/><path d="M7.149 10.558l7.058-7.058-.707-.707-7.058 7.058z" id="Line"/><path d="M20.149 21.558l7.058-7.058-.707-.707-7.058 7.558z"/><path d="M5.5 23h11v-1h-11z"/><path d="M4.5 24c.828 0 1.5-.672 1.5-1.5s-.672-1.5-1.5-1.5-1.5.672-1.5 1.5.672 1.5 1.5 1.5zm0 1c-1.381 0-2.5-1.119-2.5-2.5s1.119-2.5 2.5-2.5 2.5 1.119 2.5 2.5-1.119 2.5-2.5 2.5z"/></g></svg>';div;activeIcon=null;buttons=[];_commandFunctions;_handlerID;_drawingTool;handler;constructor(e,t,i,o,n){this._handlerID=t,this._commandFunctions=n,this._drawingTool=new de(i,o,(()=>this.removeActiveAndSave())),this.div=this._makeToggleToolBox(),this.handler=e,this.handler.ContextMenu.setupDrawingTools(this.saveDrawings,this._drawingTool),n.push((e=>{if((e.metaKey||e.ctrlKey)&&"KeyZ"===e.code){const e=this._drawingTool.drawings.pop();return e&&this._drawingTool.delete(e),!0}return!1}))}toJSON(){const{...e}=this;return e}_makeToggleToolBox(){const e=document.createElement("div");e.classList.add("flyout-toolbox"),e.style.position="absolute",e.style.top="0",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.zIndex="1000",e.style.overflow="hidden",e.style.transition="height 0.3s ease";const t=document.createElement("div");t.classList.add("toolbox-content"),t.style.display="inline-flex",t.style.flexDirection="row",t.style.justifyContent="center",t.style.alignItems="center",t.style.padding="5px",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.display="none",this.buttons=[],this.buttons.push(this._makeToolBoxElement(fe,"KeyT",Ae.TREND_SVG)),this.buttons.push(this._makeToolBoxElement(Se,"KeyH",Ae.HORZ_SVG)),this.buttons.push(this._makeToolBoxElement(ke,"KeyR",Ae.RAY_SVG)),this.buttons.push(this._makeToolBoxElement(we,"KeyB",Ae.BOX_SVG)),this.buttons.push(this._makeToolBoxElement(Le,"KeyV",Ae.VERT_SVG,!0)),this.buttons.push(this._makeToolBoxElement(Ne,"KeyP",Ae.PITCHFORK_SVG));for(const e of this.buttons)t.appendChild(e);const i=document.createElement("div");i.textContent="▼",i.style.width="15px",i.style.height="10px",i.style.backgroundColor="rgba(0, 0, 0, 0)",i.style.color="#fff",i.style.textAlign="center",i.style.lineHeight="15px",i.style.cursor="pointer",e.appendChild(t),e.appendChild(i);let o=!1;return e.style.height="15px",i.onclick=()=>{if(o=!o,o){t.style.display="inline-flex";const o=t.scrollHeight;e.style.height=`${15+o}px`,i.textContent="▲"}else t.style.display="none",e.style.height="15px",i.textContent="▼"},e}_makeToolBoxElement(e,t,i,o=!1){const n=document.createElement("div");n.classList.add("toolbox-button");const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.setAttribute("width","29"),s.setAttribute("height","29");const a=document.createElementNS("http://www.w3.org/2000/svg","g");a.innerHTML=i,a.setAttribute("fill",window.pane.color),s.appendChild(a),n.appendChild(s);const r={div:n,group:a,type:e};return n.addEventListener("click",(()=>this._onIconClick(r))),this._commandFunctions.push((e=>this._handlerID===window.handlerInFocus&&(!(!e.altKey||e.code!==t)&&(e.preventDefault(),this._onIconClick(r),!0)))),1==o&&(s.style.transform="rotate(90deg)",s.style.transformBox="fill-box",s.style.transformOrigin="center"),n}_onIconClick(e){this.activeIcon&&(this.activeIcon.div.classList.remove("active-toolbox-button"),window.setCursor("crosshair"),this._drawingTool?.stopDrawing(),this.activeIcon===e)?this.activeIcon=null:(this.activeIcon=e,this.activeIcon.div.classList.add("active-toolbox-button"),window.setCursor("crosshair"),this._drawingTool?.beginDrawing(this.activeIcon.type))}removeActiveAndSave=()=>{window.setCursor("default"),this.activeIcon&&this.activeIcon.div.classList.remove("active-toolbox-button"),this.activeIcon=null,this.saveDrawings()};addNewDrawing(e){this._drawingTool.addNewDrawing(e)}clearDrawings(){this._drawingTool.clearDrawings()}saveDrawings=()=>{const e=[];for(const t of this._drawingTool.drawings)e.push({type:t._type,points:t.points,options:t._options});const t=JSON.stringify(e);window.callbackFunction(`save_drawings${this._handlerID}_~_${t}`)};loadDrawings(e){e.forEach((e=>{switch(e.type){case"Box":this._drawingTool.addNewDrawing(new we(e.points[0],e.points[1],e.options));break;case"TrendLine":this._drawingTool.addNewDrawing(new fe(e.points[0],e.points[1],e.options));break;case"HorizontalLine":this._drawingTool.addNewDrawing(new Se(e.points[0],e.options));break;case"RayLine":this._drawingTool.addNewDrawing(new ke(e.points[0],e.options));break;case"VerticalLine":this._drawingTool.addNewDrawing(new Le(e.points[0],e.options));break;case"PitchFork":this._drawingTool.addNewDrawing(new Ne(e.points[0],e.points[1],e.points[2],e.options))}}))}}class Ve{makeButton;callbackName;div;isOpen=!1;widget;constructor(e,t,i,o,n,s){this.makeButton=e,this.callbackName=t,this.div=document.createElement("div"),this.div.classList.add("topbar-menu"),this.widget=this.makeButton(o+" ↓",null,n,!0,s),this.updateMenuItems(i),this.widget.elem.addEventListener("click",(()=>{if(this.isOpen=!this.isOpen,!this.isOpen)return void(this.div.style.display="none");let e=this.widget.elem.getBoundingClientRect();this.div.style.display="flex",this.div.style.flexDirection="column";let t=e.x+e.width/2;this.div.style.left=t-this.div.clientWidth/2+"px",this.div.style.top=e.y+e.height+"px"})),document.body.appendChild(this.div)}updateMenuItems(e){this.div.innerHTML="",e.forEach((e=>{let t=this.makeButton(e,null,!1,!1);t.elem.addEventListener("click",(()=>{this._clickHandler(t.elem.innerText)})),t.elem.style.margin="4px 4px",t.elem.style.padding="2px 2px",this.div.appendChild(t.elem)})),this.widget.elem.innerText=e[0]+" ↓"}_clickHandler(e){this.widget.elem.innerText=e+" ↓",window.callbackFunction(`${this.callbackName}_~_${e}`),this.div.style.display="none",this.isOpen=!1}}class $e{_handler;_div;left;right;constructor(e){this._handler=e,this._div=document.createElement("div"),this._div.classList.add("topbar");const t=e=>{const t=document.createElement("div");return t.classList.add("topbar-container"),t.style.justifyContent=e,this._div.appendChild(t),t};this.left=t("flex-start"),this.right=t("flex-end")}makeSwitcher(e,t,i,o="left"){const n=document.createElement("div");let s;n.style.margin="4px 12px";const a={elem:n,callbackName:i,intervalElements:e.map((e=>{const i=document.createElement("button");i.classList.add("topbar-button"),i.classList.add("switcher-button"),i.style.margin="0px 2px",i.innerText=e,e==t&&(s=i,i.classList.add("active-switcher-button"));const o=$e.getClientWidth(i);return i.style.minWidth=o+1+"px",i.addEventListener("click",(()=>a.onItemClicked(i))),n.appendChild(i),i})),onItemClicked:e=>{e!=s&&(s.classList.remove("active-switcher-button"),e.classList.add("active-switcher-button"),s=e,window.callbackFunction(`${a.callbackName}_~_${e.innerText}`))}};return this.appendWidget(n,o,!0),a}makeTextBoxWidget(e,t="left",i=null){if(i){const o=document.createElement("input");return o.classList.add("topbar-textbox-input"),o.value=e,o.style.width=`${o.value.length+2}ch`,o.addEventListener("focus",(()=>{window.textBoxFocused=!0})),o.addEventListener("input",(e=>{e.preventDefault(),o.style.width=`${o.value.length+2}ch`})),o.addEventListener("keydown",(e=>{"Enter"==e.key&&(e.preventDefault(),o.blur())})),o.addEventListener("blur",(()=>{window.callbackFunction(`${i}_~_${o.value}`),window.textBoxFocused=!1})),this.appendWidget(o,t,!0),o}{const i=document.createElement("div");return i.classList.add("topbar-textbox"),i.innerText=e,this.appendWidget(i,t,!0),i}}makeMenu(e,t,i,o,n){return new Ve(this.makeButton.bind(this),o,e,t,i,n)}makeButton(e,t,i,o=!0,n="left",s=!1){let a=document.createElement("button");a.classList.add("topbar-button"),a.innerText=e,document.body.appendChild(a),a.style.minWidth=a.clientWidth+1+"px",document.body.removeChild(a);let r={elem:a,callbackName:t};if(t){let e;if(s){let t=!1;e=()=>{t=!t,window.callbackFunction(`${r.callbackName}_~_${t}`),a.style.backgroundColor=t?"var(--active-bg-color)":"",a.style.color=t?"var(--active-color)":""}}else e=()=>window.callbackFunction(`${r.callbackName}_~_${a.innerText}`);a.addEventListener("click",e)}return o&&this.appendWidget(a,n,i),r}makeSliderWidget(e,t,i,o,n,s="left"){const a=document.createElement("div");a.classList.add("topbar-slider-container"),a.style.display="flex",a.style.alignItems="center",a.style.margin="4px 12px";const r=document.createElement("span");r.classList.add("topbar-slider-label"),r.style.marginRight="8px",r.innerText=o.toString();const l=document.createElement("input");return l.classList.add("topbar-slider"),l.type="range",l.min=e.toString(),l.max=t.toString(),l.step=i.toString(),l.value=o.toString(),l.style.cursor="pointer",l.addEventListener("input",(()=>{r.innerText=l.value,window.callbackFunction(`${n}_~_${l.value}`)})),a.appendChild(r),a.appendChild(l),this.appendWidget(a,s,!0),a}makeSeparator(e="left"){const t=document.createElement("div");t.classList.add("topbar-seperator");("left"==e?this.left:this.right).appendChild(t)}appendWidget(e,t,i){const o="left"==t?this.left:this.right;i?("left"==t&&o.appendChild(e),this.makeSeparator(t),"right"==t&&o.appendChild(e)):o.appendChild(e),this._handler.reSize()}static getClientWidth(e){document.body.appendChild(e);const t=e.clientWidth;return document.body.removeChild(e),t}}const Re={title:"",followMode:"tracking",horizontalDeadzoneWidth:45,verticalDeadzoneHeight:100,verticalSpacing:20,topOffset:20};class Ge{_chart;_element;_titleElement;_priceElement;_dateElement;_timeElement;_options;_lastTooltipWidth=null;constructor(e,t){this._options={...Re,...t},this._chart=e;const i=document.createElement("div");Fe(i,{display:"flex","flex-direction":"column","align-items":"center",position:"absolute",transform:"translate(calc(0px - 50%), 0px)",opacity:"0",left:"0%",top:"0","z-index":"100","background-color":"white","border-radius":"4px",padding:"5px 10px","font-family":"-apple-system, BlinkMacSystemFont, 'Trebuchet MS', Roboto, Ubuntu, sans-serif","font-size":"12px","font-weight":"400","box-shadow":"0px 2px 4px rgba(0, 0, 0, 0.2)","line-height":"16px","pointer-events":"none",color:"#131722"});const o=document.createElement("div");Fe(o,{"font-size":"12px","line-height":"24px","font-weight":"590"}),Be(o,this._options.title),i.appendChild(o);const n=document.createElement("div");Fe(n,{"font-size":"12px","line-height":"18px","font-weight":"590"}),Be(n,""),i.appendChild(n);const s=document.createElement("div");Fe(s,{color:"#787B86"}),Be(s,""),i.appendChild(s);const a=document.createElement("div");Fe(a,{color:"#787B86"}),Be(a,""),i.appendChild(a),this._element=i,this._titleElement=o,this._priceElement=n,this._dateElement=s,this._timeElement=a;const r=this._chart.chartElement();r.appendChild(this._element);const l=r.parentElement;if(!l)return void console.error("Chart Element is not attached to the page.");const c=getComputedStyle(l).position;"relative"!==c&&"absolute"!==c&&console.error("Chart Element position is expected be `relative` or `absolute`.")}destroy(){this._chart&&this._element&&this._chart.chartElement().removeChild(this._element)}applyOptions(e){this._options={...this._options,...e}}options(){return this._options}updateTooltipContent(e){if(!this._element)return void console.warn("Tooltip element not found.");const t=this._element.getBoundingClientRect();this._lastTooltipWidth=t.width,void 0!==e.title&&this._titleElement?(console.log(`Setting title: ${e.title}`),Be(this._titleElement,e.title)):console.warn("Title element is missing or title data is undefined."),Be(this._priceElement,e.price),Be(this._dateElement,e.date),Be(this._timeElement,e.time)}updatePosition(e){if(!this._chart||!this._element)return;if(this._element.style.opacity=e.visible?"1":"0",!e.visible)return;const t=this._calculateXPosition(e,this._chart),i=this._calculateYPosition(e);this._element.style.transform=`translate(${t}, ${i})`}_calculateXPosition(e,t){const i=e.paneX+t.priceScale("left").width(),o=this._lastTooltipWidth?Math.ceil(this._lastTooltipWidth/2):this._options.horizontalDeadzoneWidth;return`calc(${Math.min(Math.max(o,i),t.timeScale().width()-o)}px - 50%)`}_calculateYPosition(e){if("top"==this._options.followMode)return`${this._options.topOffset}px`;const t=e.paneY,i=t<=this._options.verticalSpacing+this._options.verticalDeadzoneHeight;return`calc(${t+(i?1:-1)*this._options.verticalSpacing}px${i?"":" - 100%"})`}}function Be(e,t){e&&t!==e.innerText&&(e.innerText=t,e.style.display=t?"block":"none")}function Fe(e,t){for(const[i,o]of Object.entries(t))e.style.setProperty(i,o)}function Ue(e,t,i=1,o){const n=Math.round(t*e),s=Math.round(i*t),a=function(e){return Math.floor(.5*e)}(s);return{position:n-a,length:s}}class He{_data;constructor(e){this._data=e}draw(e){this._data.visible&&e.useBitmapCoordinateSpace((e=>{const t=e.context,i=Ue(this._data.x,e.horizontalPixelRatio,1);t.fillStyle=this._data.color,t.fillRect(i.position,this._data.topMargin*e.verticalPixelRatio,i.length,e.bitmapSize.height)}))}}class We{_data;constructor(e){this._data=e}update(e){this._data=e}renderer(){return new He(this._data)}zOrder(){return"bottom"}}const ze={lineColor:"rgba(0, 0, 0, 0.2)",priceExtractor:e=>void 0!==e.value?e.value.toFixed(2):void 0!==e.close?e.close.toFixed(2):""};class je{_options;_tooltip=void 0;_paneViews;_data={x:0,visible:!1,color:"rgba(0, 0, 0, 0.2)",topMargin:0};_attachedParams;constructor(e){this._options={...ze,...e},this._data.color=this._options.lineColor,this._paneViews=[new We(this._data)]}attached(e){this._attachedParams=e;const t=this.series();if(t){const e=t.options(),i=e.lineColor||e.color||"rgba(0,0,0,0.2)";this._options.autoColor&&this.applyOptions({lineColor:i})}this._setCrosshairMode(),e.chart.subscribeCrosshairMove(this._moveHandler),this._createTooltipElement()}detached(){const e=this.chart();e&&e.unsubscribeCrosshairMove(this._moveHandler),this._hideCrosshair(),this._hideTooltip()}paneViews(){return this._paneViews}updateAllViews(){this._paneViews.forEach((e=>e.update(this._data)))}setData(e){this._data=e,this.updateAllViews(),this._attachedParams?.requestUpdate()}currentColor(){return this._options.lineColor}chart(){return this._attachedParams?.chart}series(){return this._attachedParams?.series}applyOptions(e){this._options={...this._options,...e},e.lineColor&&this.setData({...this._data,color:e.lineColor}),this._tooltip&&this._tooltip.applyOptions({...this._options.tooltip}),this._attachedParams?.requestUpdate()}_setCrosshairMode(){const e=this.chart();if(!e)throw new Error("Unable to change crosshair mode because the chart instance is undefined");e.applyOptions({crosshair:{mode:t.CrosshairMode.Magnet,vertLine:{visible:!1,labelVisible:!1},horzLine:{visible:!1,labelVisible:!1}}})}_moveHandler=e=>this._onMouseMove(e);switch(e){if(this.series()===e)return void console.log("Tooltip is already attached to this series.");this._hideCrosshair(),e.attachPrimitive(this,"Tooltip",!0,!1);const t=e.options(),i=t.lineColor||t.color||"rgba(0,0,0,0.2)";this._options.autoColor&&this.applyOptions({lineColor:i}),console.log("Switched tooltip to the new series.")}_hideCrosshair(){this._hideTooltip(),this.setData({x:0,visible:!1,color:this._options.lineColor,topMargin:0})}_hideTooltip(){this._tooltip&&(this._tooltip.updateTooltipContent({title:"",price:"",date:"",time:""}),this._tooltip.updatePosition({paneX:0,paneY:0,visible:!1}))}_onMouseMove(e){const i=this.chart(),o=this.series(),n=e.logical;if(!n||!i||!o)return void this._hideCrosshair();const s=e.seriesData.get(o);if(!s)return void this._hideCrosshair();const a=this._options.priceExtractor(s),r=i.timeScale().logicalToCoordinate(n),[l,c]=function(e){if(!e)return["",""];const t=new Date(e),i=t.getFullYear(),o=t.toLocaleString("default",{month:"short"});return[`${t.getDate().toString().padStart(2,"0")} ${o} ${i}`,`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`]}(e.time?function(e){if(t.isUTCTimestamp(e))return 1e3*e;if(t.isBusinessDay(e))return new Date(e.year,e.month,e.day).valueOf();const[i,o,n]=e.split("-").map(parseInt);return new Date(i,o,n).valueOf()}(e.time):void 0);if(this._tooltip){const t=o.options()?.title||"Unknown Series",i=this._tooltip.options(),n="top"===i.followMode?i.topOffset+10:0;this.setData({x:r??0,visible:null!==r,color:this._options.lineColor,topMargin:n}),this._tooltip.updateTooltipContent({title:t,price:a,date:l,time:c}),this._tooltip.updatePosition({paneX:e.point?.x??0,paneY:e.point?.y??0,visible:!0})}}_createTooltipElement(){const e=this.chart();if(!e)throw new Error("Unable to create Tooltip element. Chart not attached");this._tooltip=new Ge(e,{...this._options.tooltip})}}let qe=class e{colorOption;static colors=["#EBB0B0","#E9CEA1","#E5DF80","#ADEB97","#A3C3EA","#D8BDED","#E15F5D","#E1B45F","#E2D947","#4BE940","#639AE1","#D7A0E8","#E42C2A","#E49D30","#E7D827","#3CFF0A","#3275E4","#B06CE3","#F3000D","#EE9A14","#F1DA13","#2DFC0F","#1562EE","#BB00EF","#B50911","#E3860E","#D2BD11","#48DE0E","#1455B4","#6E009F","#7C1713","#B76B12","#8D7A13","#479C12","#165579","#51007E"];_div;saveDrawings;opacity=0;_opacitySlider;_opacityLabel;rgba;constructor(t,i){this.colorOption=i,this.saveDrawings=t,this._div=document.createElement("div"),this._div.classList.add("color-picker");let o=document.createElement("div");o.style.margin="10px",o.style.display="flex",o.style.flexWrap="wrap",e.colors.forEach((e=>o.appendChild(this.makeColorBox(e))));let n=document.createElement("div");n.style.backgroundColor=window.pane.borderColor,n.style.height="1px",n.style.width="130px";let s=document.createElement("div");s.style.margin="10px";let a=document.createElement("div");a.style.color="lightgray",a.style.fontSize="12px",a.innerText="Opacity",this._opacityLabel=document.createElement("div"),this._opacityLabel.style.color="lightgray",this._opacityLabel.style.fontSize="12px",this._opacitySlider=document.createElement("input"),this._opacitySlider.type="range",this._opacitySlider.value=(100*this.opacity).toString(),this._opacityLabel.innerText=this._opacitySlider.value+"%",this._opacitySlider.oninput=()=>{this._opacityLabel.innerText=this._opacitySlider.value+"%",this.opacity=parseInt(this._opacitySlider.value)/100,this.updateColor()},s.appendChild(a),s.appendChild(this._opacitySlider),s.appendChild(this._opacityLabel),this._div.appendChild(o),this._div.appendChild(n),this._div.appendChild(s),window.containerDiv.appendChild(this._div)}_updateOpacitySlider(){this._opacitySlider.value=(100*this.opacity).toString(),this._opacityLabel.innerText=this._opacitySlider.value+"%"}makeColorBox(t){const i=document.createElement("div");i.style.width="18px",i.style.height="18px",i.style.borderRadius="3px",i.style.margin="3px",i.style.boxSizing="border-box",i.style.backgroundColor=t,i.addEventListener("mouseover",(()=>i.style.border="2px solid lightgray")),i.addEventListener("mouseout",(()=>i.style.border="none"));const o=e.extractRGBA(t);return i.addEventListener("click",(()=>{this.rgba=o,this.updateColor()})),i}static extractRGBA(e){const t=document.createElement("div");t.style.color=e,document.body.appendChild(t);const i=getComputedStyle(t).color;document.body.removeChild(t);const o=i.match(/\d+/g)?.map(Number);if(!o)return[];let n=i.includes("rgba")?parseFloat(i.split(",")[3]):1;return[o[0],o[1],o[2],n]}updateColor(){if(!L.lastHoveredObject||!this.rgba)return;const e=`rgba(${this.rgba[0]}, ${this.rgba[1]}, ${this.rgba[2]}, ${this.opacity})`;L.lastHoveredObject.applyOptions({[this.colorOption]:e}),this.saveDrawings()}openMenu(t){L.lastHoveredObject&&(this.rgba=e.extractRGBA(L.lastHoveredObject._options[this.colorOption]),this.opacity=this.rgba[3],this._updateOpacitySlider(),this._div.style.top=t.top-30+"px",this._div.style.left=t.right+"px",this._div.style.display="flex",setTimeout((()=>document.addEventListener("mousedown",(e=>{this._div.contains(e.target)||this.closeMenu()}))),10))}closeMenu(){document.body.removeEventListener("click",this.closeMenu),this._div.style.display="none"}};class Je{container;_opacitySlider;_opacity_label;exitButton;color="#ff0000";rgba;opacity;applySelection;constructor(e,t){this.applySelection=t,this.rgba=Je.extractRGBA(e),this.opacity=this.rgba[3],this.container=document.createElement("div"),this.container.classList.add("color-picker"),this.container.style.display="flex",this.container.style.flexDirection="column",this.container.style.width="150px",this.container.style.height="300px",this.container.style.position="relative";const i=this.createColorGrid(),o=this.createOpacityUI();this.exitButton=this.createExitButton(),this.container.appendChild(i),this.container.appendChild(this.createSeparator()),this.container.appendChild(this.createSeparator()),this.container.appendChild(o),this.container.appendChild(this.exitButton)}createExitButton(){const e=document.createElement("div");return e.innerText="✕",e.title="Close",e.style.position="absolute",e.style.bottom="5px",e.style.right="5px",e.style.width="20px",e.style.height="20px",e.style.cursor="pointer",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.fontSize="16px",e.style.backgroundColor="#ccc",e.style.borderRadius="50%",e.style.color="#000",e.style.boxShadow="0 1px 3px rgba(0,0,0,0.3)",e.addEventListener("mouseover",(()=>{e.style.backgroundColor="#e74c3c",e.style.color="#fff"})),e.addEventListener("mouseout",(()=>{e.style.backgroundColor="#ccc",e.style.color="#000"})),e.addEventListener("click",(()=>{this.closeMenu()})),e}createColorGrid(){const e=document.createElement("div");e.style.display="grid",e.style.gridTemplateColumns="repeat(7, 1fr)",e.style.gap="5px",e.style.overflowY="auto",e.style.flex="1";return Je.generateFullSpectrumColors(9).forEach((t=>{const i=this.createColorBox(t);e.appendChild(i)})),e}createColorBox(e){const t=document.createElement("div");return t.style.aspectRatio="1",t.style.borderRadius="6px",t.style.backgroundColor=e,t.style.cursor="pointer",t.addEventListener("click",(()=>{this.rgba=Je.extractRGBA(e),this.updateTargetColor()})),t}static generateFullSpectrumColors(e){const t=[];for(let i=0;i<=255;i+=Math.floor(255/e))t.push(`rgba(255, ${i}, 0, 1)`);for(let i=255;i>=0;i-=Math.floor(255/e))t.push(`rgba(${i}, 255, 0, 1)`);for(let i=0;i<=255;i+=Math.floor(255/e))t.push(`rgba(0, 255, ${i}, 1)`);for(let i=255;i>=0;i-=Math.floor(255/e))t.push(`rgba(0, ${i}, 255, 1)`);for(let i=0;i<=255;i+=Math.floor(255/e))t.push(`rgba(${i}, 0, 255, 1)`);for(let i=255;i>=0;i-=Math.floor(255/e))t.push(`rgba(255, 0, ${i}, 1)`);for(let i=255;i>=0;i-=Math.floor(255/e))t.push(`rgba(${i}, ${i}, ${i}, 1)`);return t}createOpacityUI(){const e=document.createElement("div");e.style.margin="10px",e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center";const t=document.createElement("div");return t.style.color="lightgray",t.style.fontSize="12px",t.innerText="Opacity",this._opacitySlider=document.createElement("input"),this._opacitySlider.type="range",this._opacitySlider.min="0",this._opacitySlider.max="100",this._opacitySlider.value=(100*this.opacity).toString(),this._opacitySlider.style.width="80%",this._opacity_label=document.createElement("div"),this._opacity_label.style.color="lightgray",this._opacity_label.style.fontSize="12px",this._opacity_label.innerText=`${this._opacitySlider.value}%`,this._opacitySlider.oninput=()=>{this._opacity_label.innerText=`${this._opacitySlider.value}%`,this.opacity=parseInt(this._opacitySlider.value)/100,this.updateTargetColor()},e.appendChild(t),e.appendChild(this._opacitySlider),e.appendChild(this._opacity_label),e}createSeparator(){const e=document.createElement("div");return e.style.height="1px",e.style.width="100%",e.style.backgroundColor="#ccc",e.style.margin="5px 0",e}openMenu(e,t,i){this.applySelection=i,this.container.style.display="block",document.body.appendChild(this.container),console.log("Menu attached:",this.container);const o=this.container.offsetWidth||150,n=this.container.offsetHeight||250;console.log("Submenu dimensions:",{submenuWidth:o,submenuHeight:n});const s=e.clientX,a=e.clientY;console.log("Mouse position:",{cursorX:s,cursorY:a});const r=window.innerWidth,l=window.innerHeight;let c=s+t,h=a;const d=c+o>r?s-o:c,p=h+n>l?l-n-10:h;console.log({left:c,top:h,adjustedLeft:d,adjustedTop:p}),this.container.style.left=`${d}px`,this.container.style.top=`${p}px`,this.container.style.display="flex",this.container.style.position="absolute",this.exitButton.style.bottom="5px",this.exitButton.style.right="5px",document.addEventListener("mousedown",this._handleOutsideClick.bind(this),{once:!0})}closeMenu(){this.container.style.display="none",document.removeEventListener("mousedown",this._handleOutsideClick)}_handleOutsideClick(e){this.container.contains(e.target)||this.closeMenu()}static extractRGBA(e){const t=document.createElement("div");t.style.color=e,document.body.appendChild(t);const i=getComputedStyle(t).color;document.body.removeChild(t);const o=i.match(/\d+/g)?.map(Number)||[0,0,0],n=i.includes("rgba")?parseFloat(i.split(",")[3]):1;return[o[0],o[1],o[2],n]}getElement(){return this.container}update(e,t){this.rgba=Je.extractRGBA(e),this.opacity=this.rgba[3],this.applySelection=t,this.updateTargetColor()}updateTargetColor(){this.color=`rgba(${this.rgba[0]}, ${this.rgba[1]}, ${this.rgba[2]}, ${this.opacity})`,this.applySelection(this.color)}}class Xe{static _styles=[{name:"Solid",var:t.LineStyle.Solid},{name:"Dotted",var:t.LineStyle.Dotted},{name:"Dashed",var:t.LineStyle.Dashed},{name:"Large Dashed",var:t.LineStyle.LargeDashed},{name:"Sparse Dotted",var:t.LineStyle.SparseDotted}];_div;_saveDrawings;constructor(e){this._saveDrawings=e,this._div=document.createElement("div"),this._div.classList.add("context-menu"),Xe._styles.forEach((e=>{this._div.appendChild(this._makeTextBox(e.name,e.var))})),window.containerDiv.appendChild(this._div)}_makeTextBox(e,t){const i=document.createElement("span");return i.classList.add("context-menu-item"),i.innerText=e,i.addEventListener("click",(()=>{L.lastHoveredObject?.applyOptions({lineStyle:t}),this._saveDrawings()})),i}openMenu(e){this._div.style.top=e.top-30+"px",this._div.style.left=e.right+"px",this._div.style.display="block",setTimeout((()=>document.addEventListener("mousedown",(e=>{this._div.contains(e.target)||this.closeMenu()}))),10)}closeMenu(){document.removeEventListener("click",this.closeMenu),this._div.style.display="none"}}const Ye={visible:!0,sections:0,upColor:void 0,downColor:void 0,borderUpColor:void 0,borderDownColor:void 0,rightSide:!0,width:0,lineColor:"#ffffff",lineStyle:t.LineStyle.Solid,drawGrid:!0,gridWidth:1,gridColor:"rgba(255, 255, 255, 0.125)",gridLineStyle:t.LineStyle.SparseDotted};class Ke extends o{p1;p2;_listeners=[];visibleRange=null;_originalData;_currentSlice=null;_vpData;_paneViews;_options;_pendingUpdate=!1;_state=D.NONE;_latestHoverPoint=null;_startDragPoint=null;static _mouseIsDown=!1;_hovered=!1;chart_;series_;constructor(e,t=Ye,i,o){super(),this.chart_=e.chart,this.series_=e.series;const n=this.series_.data(),s=e.volumeSeries.data(),a=this.chart_.timeScale();this.visibleRange=a.getVisibleLogicalRange(),i&&o?(this.p1=i,this.p2=o):(this.p1={time:null,logical:this.visibleRange?.from??0,price:0},this.p2={time:null,logical:this.visibleRange?.to??this.series.data().length-1,price:0}),this._options={...Ye,...t},s.length>0&&s.every((e=>"value"in e))?this._originalData=n.map(((e,t)=>({...e,x1:t,x2:t,volume:s[t]?.value||0}))):(console.warn('[ProfileProcessor] volumeData is empty or missing "value" property.'),this._originalData=n.map(((e,t)=>({...e,x1:t,x2:t,volume:0})))),this.sliceData(),this._vpData=this.calculateVolumeProfile(),this._paneViews=[new Ze(this)],this._subscribeEvents(),this.update()}_handleDomMouseDown=()=>{};_handleDomMouseUp=()=>{this._onMouseUp()};_subscribe(e,t){document.addEventListener(e,t),this._listeners.push({name:e,listener:t})}_unsubscribe(e,t){document.removeEventListener(e,t);const i=this._listeners.findIndex((i=>i.name===e&&i.listener===t));-1!==i&&this._listeners.splice(i,1)}_subscribeEvents(){this.p1&&this.p2&&this.p1.time&&this.p2.time?(this.chart_.subscribeCrosshairMove(this._handleMouseMove),this.chart_.subscribeClick(this._handleMouseDownOrUp),this._listeners.push({name:"crosshairMove",listener:this._handleMouseMove},{name:"click",listener:this._handleMouseDownOrUp})):(this.chart_.timeScale().subscribeVisibleLogicalRangeChange(this._handleVisibleLogicalRangeChange),this._listeners.push({name:"visibleLogicalRangeChange",listener:this._handleVisibleLogicalRangeChange}))}_handleVisibleLogicalRangeChange=()=>{const e=this.chart_.timeScale();if(this.visibleRange=e.getVisibleLogicalRange(),!this.visibleRange||!this.series_)return void console.warn("[VolumeProfile] Visible range or source series is undefined.");this.p1={time:null,logical:this.visibleRange.from??0,price:0},this.p2={time:null,logical:this.visibleRange.to??this.series_.data().length-1,price:0},this.sliceData();const t=this.calculateVolumeProfile();t?(this._vpData=t,this.updateAllViews(),this.requestUpdate()):console.warn("[VolumeProfile] Failed to process Volume Profile data on visible range change.")};_handleMouseMove=e=>{const t=this._eventToPoint(e);this._latestHoverPoint=t,Ke._mouseIsDown?this._handleDragInteraction(e):this._mouseIsOverPointCanvas(e,1)||this._mouseIsOverPointCanvas(e,2)?this._state===D.NONE&&this._moveToState(D.HOVERING):this._state!==D.NONE&&this._moveToState(D.NONE)};_handleMouseDownOrUp=()=>{Ke._mouseIsDown=!Ke._mouseIsDown,Ke._mouseIsDown?this._onMouseDown():this._onMouseUp(),this.sliceData(),this._vpData=this.calculateVolumeProfile(),this.update()};_onMouseDown(){if(this._startDragPoint=this._latestHoverPoint,!this._startDragPoint||!this.p1||!this.p2)return;const e=this._mouseIsOverPointRaw(this._startDragPoint,this.p1),t=this._mouseIsOverPointRaw(this._startDragPoint,this.p2);e?this._moveToState(D.DRAGGINGP1):t?this._moveToState(D.DRAGGINGP2):this._moveToState(D.DRAGGING)}_onMouseUp(){Ke._mouseIsDown=!1,this._startDragPoint=null,this._moveToState(D.HOVERING),this.sliceData(),this._vpData=this.calculateVolumeProfile(),this.update()}_handleDragInteraction(e){if(this._state!==D.DRAGGING&&this._state!==D.DRAGGINGP1&&this._state!==D.DRAGGINGP2)return;const t=this._eventToPoint(e);if(!t||!this._startDragPoint)return;const i={logical:t.logical-this._startDragPoint.logical,price:t.price-this._startDragPoint.price};this._onDrag(i),this.sliceData(),this._vpData=this.calculateVolumeProfile(),this.update(),this._startDragPoint=t}_onDrag(e){this.p1&&this.p2&&(this._state===D.DRAGGING?(this._addDiffToPoint(this.p1,e.logical,e.price),this._addDiffToPoint(this.p2,e.logical,e.price)):this._state===D.DRAGGINGP1?this._addDiffToPoint(this.p1,e.logical,e.price):this._state===D.DRAGGINGP2&&this._addDiffToPoint(this.p2,e.logical,e.price),this.sliceData(),this._vpData=this.calculateVolumeProfile(),this.update())}_addDiffToPoint(e,t,i){e.logical=e.logical+t,e.price=e.price+i}_mouseIsOverPointRaw(e,t){if(!e)return!1;return Math.abs(e.logical-t.logical)<1&&Math.abs(e.price-t.price)<1}_mouseIsOverPointCanvas(e,t){if(!e.point||!this.p1||!this.p2)return!1;const i=O(1===t?this.p1:this.p2,this.chart_,this.series_),o=e.point.x-i.x,n=e.point.y-i.y;return o*o+n*n<100}_moveToState(e){switch(e){case D.NONE:document.body.style.cursor="default",this._hovered=!1,this._unsubscribe("mousedown",this._handleDomMouseDown),this._unsubscribe("mouseup",this._handleDomMouseUp);break;case D.HOVERING:document.body.style.cursor="pointer",this._hovered=!0,this._subscribe("mousedown",this._handleDomMouseDown),this._unsubscribe("mouseup",this._handleDomMouseUp);break;case D.DRAGGING:case D.DRAGGINGP1:case D.DRAGGINGP2:document.body.style.cursor="grabbing",this._hovered=!1,this._unsubscribe("mousedown",this._handleDomMouseDown),this._subscribe("mouseup",this._handleDomMouseUp)}this._state=e,this.sliceData(),this._vpData=this.calculateVolumeProfile(),this.update()}_eventToPoint(e){if(!e.point||null==e.logical)return null;const t=this.series_.coordinateToPrice(e.point.y);return null==t?null:{time:e.time??null,logical:e.logical,price:t.valueOf()}}sliceData(){if(!this.p1||!this.p2)return;const e=Math.min(this.p1.logical,this.p2.logical),t=Math.max(this.p1.logical,this.p2.logical);this._currentSlice=this._originalData.slice(Math.max(0,e),Math.min(t+1,this._originalData.length-1))}calculateDynamicSections(e,t,i){if(e<=0||i<=t)return 10;const o=e/20,n=(i-t)/5,s=2*Math.max(1,Math.floor(Math.max(o,n)));return Math.max(5,s)}calculateVolumeProfile(){const e=Math.min(this.visibleRange.to,this._originalData.length-1)-Math.max(this.visibleRange.from,0);let t=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;const o=[];let s;if(this._currentSlice&&this._currentSlice.length>0){for(const e of this._currentSlice){const o=e.close??e.open;void 0!==o&&(t=Math.min(t,o),i=Math.max(i,o))}t!==Number.POSITIVE_INFINITY&&i!==Number.NEGATIVE_INFINITY||(t=0,i=1);let a=void 0!==this._options.sections&&this._options.sections>0?this._options.sections:this.calculateDynamicSections(e,t,i);const r=(i===t?1:i-t)/a;for(let e=0;e<a;e++){const i=t+e*r,s=t+(e+1)*r;let a=0,l=0;for(const e of this._currentSlice){const t=e.close??e.open;if(void 0!==t&&t>=i&&t<s){const t=(e.close??0)>=(e.open??0),i=e.volume||0;t?a+=i:l+=i}}const c=a>=l,h=c?this._options.upColor??n(this.series_.options().upColor,.1)??"rgba(0,128,0,0.1)":this._options.downColor??n(this.series_.options().downColor,.1)??"rgba(128,0,0,0.1)",d=c?this._options.borderUpColor??n(this.series_.options().upColor,.5)??"rgba(0,128,0,0.66)":this._options.borderDownColor??n(this.series_.options().downColor,.5)??"rgba(128,0,0,0.66)";o.push({price:i,upData:a,downData:l,color:this._options.visible?h:"rgba(0,0,0,0)",borderColor:this._options.visible?d:"rgba(0,0,0,0)",minPrice:i,maxPrice:s})}s=this._options.rightSide?this._currentSlice[this._currentSlice.length-1].time:this._currentSlice[0].time}else s=Date.now().toString();return this.update(),{time:s,profile:o,width:this._options.width??20,visibleRange:this.visibleRange}}update(){this._pendingUpdate||(this._pendingUpdate=!0,requestAnimationFrame((()=>{super.requestUpdate(),this.updateAllViews(),console.log("VolumeProfile updated p1=",this.p1,"p2=",this.p2),this._pendingUpdate=!1})))}updateAllViews(){this._paneViews.forEach((e=>e.update()))}paneViews(){return this._paneViews}autoscaleInfo(){return this._vpData.profile.length?{priceRange:{minValue:this._vpData.profile[0].minPrice,maxValue:this._vpData.profile[this._vpData.profile.length-1].maxPrice}}:null}applyOptions(e){this._options={...this._options,...e},this.sliceData(),this._vpData=this.calculateVolumeProfile(),this.update()}}class Ze{_source;_x=null;_width=0;_items=[];_maxVolume;visibleRange=null;_p1={x:null,y:null};_p2={x:null,y:null};constructor(e){this._source=e,this._maxVolume=this._source._vpData.profile.reduce(((e,t)=>Math.max(e,t.upData+t.downData)),0)}update(){if(!this._source.p1||!this._source.p2)return;const e=this._source._vpData,t=this._source.chart_,i=this._source.series_,o=t.timeScale();this._x=o.timeToCoordinate(e.time)??null;const n=o.options().barSpacing??1,s=Math.max(0,Math.min(this._source.p1.logical,this._source.p2.logical)),a=Math.min(Math.max(this._source.p1.logical,this._source.p2.logical),this._source._originalData.length-1);if(this._width=(e.width&&0!==e.width?e.width:(a-s)/3)*n,this._p1=O(this._source.p1,t,i),this._p2=O(this._source.p2,t,i),this._items=[],e.profile.length){this._maxVolume=e.profile.reduce(((e,t)=>Math.max(e,t.upData+t.downData)),0);for(const t of e.profile){const e=i.priceToCoordinate(t.maxPrice),o=i.priceToCoordinate(t.minPrice);if(null==e||null==o){this._items.push({y1:null,y2:null,combinedWidth:0,upWidth:0,downWidth:0,color:t.color,borderColor:t.borderColor});continue}const n=t.upData+t.downData,s=this._maxVolume>0?this._width*(n/this._maxVolume):0;let a=0,r=0;n>0&&(a=t.upData/n*s,r=t.downData/n*s),this._items.push({y1:e,y2:o,combinedWidth:s,upWidth:a,downWidth:r,color:t.color,borderColor:t.borderColor})}}}renderer(){return new Qe({x:this._x,width:this._width,items:this._items,visibleRange:{from:this._source.chart.timeScale().logicalToCoordinate(Math.max(0,this._source.visibleRange.from)),to:this._source.chart.timeScale().logicalToCoordinate(Math.min(this._source.series.data().length-1,this._source.visibleRange.to))},maxVolume:this._maxVolume,maxBars:this._source.series.data().length},this._p1,this._p2,this._source._options,!1)}zOrder(){return"bottom"}}class Qe extends U{_data;options;p1;p2;constructor(e,t,i,o,n){super(t,i,o,n),this._data=e,this.options=o,this.p1=t,this.p2=i}draw(){}drawBackground(e){console.log(`[VolumeProfileRenderer] draw() called with rightSide: ${this.options.rightSide}`),e.useBitmapCoordinateSpace((e=>{let t=e.context;this._drawGrid(t,e),te(t,this.options.lineStyle),this._data.items.forEach((i=>{if(null===i.y1||null===i.y2)return;if(null===this._data.x)return;const o=Math.min(i.y1,i.y2)*e.verticalPixelRatio,n=Math.abs(i.y2-i.y1)*e.verticalPixelRatio,s=i.upWidth+i.downWidth,a=s*e.horizontalPixelRatio;let r;r=this.options.rightSide?(this._data.x-s)*e.horizontalPixelRatio:this._data.x*e.horizontalPixelRatio;const l=Math.min(Math.max(.25*n,2),25);if(n>0){t.beginPath(),this._drawRoundedRect(t,r,o,a,n,l),t.strokeStyle=i.borderColor,t.lineWidth=1,t.stroke();const c=Math.max(i.upWidth,i.downWidth)*e.horizontalPixelRatio;let h;h=this.options.rightSide?r+(s-c):r,t.beginPath(),this._drawRoundedRect(t,h,o,c,n,l),t.fillStyle=i.color,t.fill()}}))}))}_drawGrid(e,i){const{items:o,x:n}=this._data;if(!o||0===o.length||null===n)return;if(!this.options.drawGrid)return;let s;s=void 0!==this.options.gridWidth&&1!==this.options.gridWidth?this.options.gridWidth*i.horizontalPixelRatio:(this._data.visibleRange.to-this._data.visibleRange.from)*i.horizontalPixelRatio,e.strokeStyle=this.options.visible?this.options.gridColor||"rgba(255, 255, 255, 0.2)":"rgba(0,0,0,0)",te(e,this.options.gridLineStyle||t.LineStyle.Solid),o.forEach((t=>{if(null===t.y1||null===t.y2)return;const o=(t.upWidth+t.downWidth)*i.horizontalPixelRatio;let a,r;this.options.rightSide?(a=n-s,r=n-o):(a=n+o,r=n+s);const l=t.y1*i.verticalPixelRatio,c=t.y2*i.verticalPixelRatio;e.beginPath(),e.moveTo(a,l),e.lineTo(r,l),e.stroke(),e.beginPath(),e.moveTo(a,c),e.lineTo(r,c),e.stroke()}))}_drawRoundedRect(e,t,i,o,n,s){const a=Math.abs(Math.min(s,o/2,n/2));e.beginPath(),o>0&&s>0&&(this.options.rightSide?(e.moveTo(t+a,i),e.lineTo(t+o,i),e.lineTo(t+o,i+n),e.lineTo(t+a,i+n),e.arcTo(t,i+n,t,i+n-a,a),e.lineTo(t,i+a),e.arcTo(t,i,t+a,i,a)):(e.moveTo(t,i),e.lineTo(t+o-a,i),e.arcTo(t+o,i,t+o,i+a,a),e.lineTo(t+o,i+n-a),e.arcTo(t+o,i+n,t+o-a,i+n,a),e.lineTo(t,i+n),e.lineTo(t,i)),e.closePath())}}function et(e,t,i){for(let o=0;o<e.length;o++)if(0===o)e[o].color=t;else{const n=e[o].value,s=e[o-1].value;isNaN(n)||isNaN(s)?e[o].color=t:e[o].color=n>=s?t:i}}function tt(e,t,i){const o=e&&t in e?e[t]:i;return Array.isArray(o)?o.map((e=>Number(e))):[Number(o)]}function it(e,t){return t<e.length?e[t]:e[e.length-1]}const ot={name:"Arnaud Legoux Moving Average",shortName:"ALMA",shouldOhlc:!1,paramMap:{length:{defaultValue:[9],type:"numberArray"},offset:{defaultValue:[.85],type:"numberArray"},sigma:{defaultValue:[6],type:"numberArray"}},calc(e,t){const i=this.paramMap.length.defaultValue,o=this.paramMap.offset.defaultValue,n=this.paramMap.sigma.defaultValue,s=tt(t,"length",i),a=tt(t,"offset",o),r=tt(t,"sigma",n),l=Math.max(s.length,a.length,r.length),c=[];for(let t=0;t<l;t++){const i=it(s,t),o=it(a,t),n=it(r,t),h=[];e.forEach(((t,s)=>{if(s<i-1)return void h.push({time:t.time,value:NaN});let a=0,r=0;const l=o*(i-1),c=i/n;for(let t=0;t<i;t++){const o=Math.exp(-Math.pow(t-l,2)/(2*Math.pow(c,2)));a+=o;r+=e[s-(i-1)+t].close*o}h.push({time:t.time,value:r/a})}));const d="alma"+(l>1?`_${t+1}`:""),p="ALMA"+i+(l>1?` #${t+1}`:"");c.push({key:d,title:p,type:"line",data:h})}return c}},nt=(e,t)=>{let i=0;return e.forEach((e=>{const o=e.close-t;i+=o*o})),Math.sqrt(i/e.length)},st={name:"Bollinger Bands",shortName:"BOLL",shouldOhlc:!0,paramMap:{length:{defaultValue:[20],type:"numberArray"},multiplier:{defaultValue:[2],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=tt(t,"multiplier",this.paramMap.multiplier.defaultValue),n=Math.max(i.length,o.length),s=[];for(let t=0;t<n;t++){const a=it(i,t),r=it(o,t);let l=0;const c=[],h=[],d=[];e.forEach(((t,i)=>{if(l+=t.close,i>=a-1){const o=l/a,n=e.slice(i-(a-1),i+1),s=nt(n,o);c.push({time:t.time,value:o+r*s}),h.push({time:t.time,value:o}),d.push({time:t.time,value:o-r*s}),l-=e[i-(a-1)].close}else c.push({time:t.time,value:NaN}),h.push({time:t.time,value:NaN}),d.push({time:t.time,value:NaN})}));const p=n>1?`_${t+1}`:"";s.push({key:`boll_up${p}`,title:`BOLL_UP${a}${p}`,type:"line",data:c}),s.push({key:`boll_mid${p}`,title:`BOLL_MID${a}${p}`,type:"line",data:h}),s.push({key:`boll_dn${p}`,title:`BOLL_DN${a}${p}`,type:"line",data:d})}return s}},at={name:"Exponential Moving Average",shortName:"EMA",shouldOhlc:!0,paramMap:{length:{defaultValue:[6,12,20],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=[];return i.forEach(((t,n)=>{let s=0,a=0;const r=[];e.forEach(((i,o)=>{if(a+=i.close,o===t-1)s=a/t;else if(o>t-1){const e=2/(t+1);s=(i.close-s)*e+s}o>=t-1?(r.push({time:i.time,value:s}),a-=e[o-(t-1)].close):r.push({time:i.time,value:NaN})}));const l="ema"+(i.length>1?`_${n+1}`:""),c="EMA"+t+(i.length>1?` #${n+1}`:"");o.push({key:l,title:c,type:"line",data:r})})),o}},rt={name:"Highest High",shortName:"HH",shouldOhlc:!0,paramMap:{length:{defaultValue:[14],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=[];return i.forEach(((t,n)=>{const s=[];e.forEach(((i,o)=>{if(o<t-1)return void s.push({time:i.time,value:NaN});let n=-1/0;for(let i=o-(t-1);i<=o;i++)n=Math.max(n,e[i].high);s.push({time:i.time,value:n})}));const a="hh"+(i.length>1?`_${n+1}`:""),r="HH"+t+(i.length>1?` #${n+1}`:"");o.push({key:a,title:r,type:"line",data:s})})),o}},lt={name:"Linear Regression",shortName:"LINREG",shouldOhlc:!0,paramMap:{length:{defaultValue:[14],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=e.map((e=>e.close)),n=[];return i.forEach(((t,s)=>{const a=[];e.forEach(((e,i)=>{if(i<t-1)return void a.push({time:e.time,value:NaN});const n=function(e,t,i=0){if(e.length<t)return NaN;const o=e.slice(e.length-t),n=t,s=n*(n-1)/2,a=o.reduce(((e,t)=>e+t),0),r=(n*o.reduce(((e,t,i)=>e+i*t),0)-s*a)/(n*(n*(n-1)*(2*n-1)/6)-s*s);return r*(n-1)/2+(a-r*s)/n+i}(o.slice(i-(t-1),i+1),t,0);a.push({time:e.time,value:n})}));const r="linreg"+(i.length>1?`_${s+1}`:""),l="LINREG"+t+(i.length>1?` #${s+1}`:"");n.push({key:r,title:l,type:"line",data:a})})),n}},ct={name:"Lowest Low",shortName:"LL",shouldOhlc:!0,paramMap:{length:{defaultValue:[14],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=[];return i.forEach(((t,n)=>{const s=[];e.forEach(((i,o)=>{if(o<t-1)return void s.push({time:i.time,value:NaN});let n=1/0;for(let i=o-(t-1);i<=o;i++)n=Math.min(n,e[i].low);s.push({time:i.time,value:n})}));const a="ll"+(i.length>1?`_${n+1}`:""),r="LL"+t+(i.length>1?` #${n+1}`:"");o.push({key:a,title:r,type:"line",data:s})})),o}},ht={name:"Median",shortName:"Median",shouldOhlc:!0,paramMap:{length:{defaultValue:[14],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=[];return i.forEach(((t,n)=>{const s=[];e.forEach(((i,o)=>{if(o<t-1)return void s.push({time:i.time,value:NaN});const n=e.slice(o-(t-1),o+1).map((e=>e.close));n.sort(((e,t)=>e-t));const a=Math.floor(n.length/2),r=n.length%2==0?(n[a-1]+n[a])/2:n[a];s.push({time:i.time,value:r})}));const a="median"+(i.length>1?`_${n+1}`:""),r="Median"+t+(i.length>1?` #${n+1}`:"");o.push({key:a,title:r,type:"line",data:s})})),o}},dt={name:"Moving Average",shortName:"MA",shouldOhlc:!0,paramMap:{length:{defaultValue:[5,10,30,60],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=[];return i.forEach(((t,n)=>{const s=[];let a=0;e.forEach(((i,o)=>{if(a+=i.close,o>=t-1){const n=a/t;s.push({time:i.time,value:n}),a-=e[o-(t-1)].close}else s.push({time:i.time,value:NaN})}));const r="ma"+(i.length>1?`_${n+1}`:""),l="MA"+t+(i.length>1?` #${n+1}`:"");o.push({key:r,title:l,type:"line",data:s})})),o}},pt={name:"Rolling Moving Average",shortName:"RMA",shouldOhlc:!1,paramMap:{length:{defaultValue:[14],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=[];return i.forEach(((t,n)=>{const s=1/t;let a=0;const r=[];e.forEach(((e,t)=>{a=0===t?e.close:s*e.close+(1-s)*a,r.push({time:e.time,value:a})}));const l="rma"+(i.length>1?`_${n+1}`:""),c="RMA"+t+(i.length>1?` #${n+1}`:"");o.push({key:l,title:c,type:"line",data:r})})),o}},ut={name:"Simple Moving Average",shortName:"SMA",shouldOhlc:!0,paramMap:{n:{defaultValue:[12],type:"numberArray"},k:{defaultValue:[2],type:"numberArray"}},calc(e,t){const i=tt(t,"n",this.paramMap.n.defaultValue),o=tt(t,"k",this.paramMap.k.defaultValue),n=Math.max(i.length,o.length),s=[];for(let t=0;t<n;t++){const a=it(i,t),r=it(o,t);let l=0,c=0;const h=[];e.forEach(((t,i)=>{l+=t.close,i>=a-1?(c=i===a-1?l/a:(t.close*r+c*(a-r))/a,l-=e[i-(a-1)].close,h.push({time:t.time,value:c})):h.push({time:t.time,value:NaN})}));const d="sma"+(n>1?`_${t+1}`:""),p="SMA"+a+","+r+(n>1?` #${t+1}`:"");s.push({key:d,title:p,type:"line",data:h})}return s}},mt={name:"Stop and Reverse",shortName:"SAR",shouldOhlc:!0,paramMap:{accStart:{defaultValue:[.02],type:"numberArray"},accStep:{defaultValue:[.02],type:"numberArray"},accMax:{defaultValue:[.2],type:"numberArray"}},calc(e,t){const i=tt(t,"accStart",this.paramMap.accStart.defaultValue),o=tt(t,"accStep",this.paramMap.accStep.defaultValue),n=tt(t,"accMax",this.paramMap.accMax.defaultValue),s=Math.max(i.length,o.length,n.length),a=[];for(let t=0;t<s;t++){const r=it(i,t),l=it(o,t),c=it(n,t);let h=r,d=0,p=0,u=!1;const m=[];e.forEach(((t,i)=>{0!==i?(1===i&&(u=t.close>e[0].close,d=u?t.high:t.low,p=u?e[0].low:e[0].high,m.push({time:e[0].time,value:p})),p+=h*(d-p),u?t.low<p?(u=!1,p=d,h=r,d=t.low):t.high>d&&(d=t.high,h=Math.min(h+l,c)):t.high>p?(u=!0,p=d,h=r,d=t.high):t.low<d&&(d=t.low,h=Math.min(h+l,c)),m.push({time:t.time,value:p})):m.push({time:t.time,value:NaN})}));const g="sar"+(s>1?`_${t+1}`:""),y="SAR"+r+","+l+","+c+(s>1?` #${t+1}`:"");a.push({key:g,title:y,type:"line",data:m})}return a}},gt={name:"Super Trend",shortName:"SuperTrend",shouldOhlc:!0,paramMap:{factor:{defaultValue:[3],type:"numberArray"},atrPeriod:{defaultValue:[10],type:"numberArray"}},calc(e,t){const i=tt(t,"factor",this.paramMap.factor.defaultValue),o=tt(t,"atrPeriod",this.paramMap.atrPeriod.defaultValue),n=Math.max(i.length,o.length),s=[];for(let t=0;t<n;t++){const a=it(i,t),r=it(o,t),l=[],c=[];let h=NaN,d=NaN,p=NaN,u=NaN;e.forEach(((t,i)=>{if(i<r-1)return l.push({time:t.time,value:NaN}),void c.push({time:t.time,value:NaN});let o=0;for(let t=i-(r-1);t<=i;t++){const i=e[t-1]?.close??e[t].close;o+=Math.max(e[t].high-e[t].low,Math.abs(e[t].high-i),Math.abs(e[t].low-i))}const n=o/r,s=(t.high+t.low)/2;let m=s+a*n,g=s-a*n;isNaN(p)||(g=g>p||e[i-1].close<p?g:p),isNaN(d)||(m=m<d||e[i-1].close>d?m:d),u=isNaN(h)?1:h===d?t.close>m?-1:1:t.close<g?1:-1;const y=-1===u?g:m;l.push({time:t.time,value:y}),c.push({time:t.time,value:u}),h=y,d=m,p=g}));const m=n>1?`_${t+1}`:"";s.push({key:"superTrend"+m,title:"SuperTrend"+a+(n>1?` #${t+1}`:""),type:"line",data:l}),s.push({key:"direction"+m,title:"Direction"+(n>1?` #${t+1}`:""),type:"line",data:c})}return s}},yt={name:"Symmetrically Weighted Moving Average",shortName:"SWMA",shouldOhlc:!1,paramMap:{window:{defaultValue:[4],type:"numberArray"}},calc(e,t){const i=tt(t,"window",this.paramMap.window.defaultValue),o=[];return i.forEach(((t,n)=>{const s=[];e.forEach(((i,o)=>{if(o<t-1)return void s.push({time:i.time,value:NaN});let n=0,a=0;for(let i=0;i<t;i++){const s=i+1;n+=e[o-(t-1)+i].close*s,a+=s}s.push({time:i.time,value:n/a})}));const a="swma"+(i.length>1?`_${n+1}`:""),r="SWMA"+t+(i.length>1?` #${n+1}`:"");o.push({key:a,title:r,type:"line",data:s})})),o}},ft={name:"TRIX",shortName:"TRIX",shouldOhlc:!0,paramMap:{n:{defaultValue:[12],type:"numberArray"},m:{defaultValue:[9],type:"numberArray"}},calc(e,t){const i=tt(t,"n",this.paramMap.n.defaultValue),o=tt(t,"m",this.paramMap.m.defaultValue),n=Math.max(i.length,o.length),s=[];for(let t=0;t<n;t++){const a=it(i,t),r=it(o,t);let l=0,c=0,h=0,d=0;const p=[],u=[];let m=0;const g=[];e.forEach(((e,t)=>{d+=e.close,t===a-1?l=d/a:t>a-1&&(l=(2*e.close+(a-1)*l)/(a+1)),t>=a-1&&(t===2*a-2?c=l:t>2*a-2&&(c=(2*l+(a-1)*c)/(a+1)));let i=NaN;if(t>=2*a-2)if(t===3*a-3)h=c;else if(t>3*a-3){const e=h;h=(2*c+(a-1)*e)/(a+1),i=(h-e)/e*100}if(p.push({time:e.time,value:i}),g.push(i),m+=isNaN(i)?0:i,g.length>r){const e=g[g.length-1-r];m-=isNaN(e)?0:e}const o=g.length>=r&&!isNaN(i)?m/r:NaN;u.push({time:e.time,value:o})}));const y=n>1?`_${t+1}`:"";s.push({key:"trix"+y,title:"TRIX"+a+(n>1?` #${t+1}`:""),type:"line",data:p}),s.push({key:"maTrix"+y,title:n>1?`MATRIX #${t+1}`:"MATRIX",type:"line",data:u})}return s}},_t={name:"Volume Weighted Average Price",shortName:"VWAP",shouldOhlc:!0,paramMap:{anchorInterval:{defaultValue:[1],type:"numberArray"}},calc(e,t,i){if(!i)return[{key:"vwap",title:"VWAP",type:"line",data:[]}];const o=tt(t,"anchorInterval",this.paramMap.anchorInterval.defaultValue),n=[];return o.forEach(((t,s)=>{let a=0,r=0;const l=[];e.forEach(((e,o)=>{o%t==0&&(a=0,r=0);const n=i[o]?.value??0,s=(e.high+e.low+e.close)/3;r+=s*n,a+=n;const c=0!==a?r/a:NaN;l.push({time:e.time,value:c})}));const c=o.length>1?`_${s+1}`:"";n.push({key:"vwap"+c,title:"VWAP"+t+(o.length>1?` #${s+1}`:""),type:"line",data:l})})),n}},vt={name:"Volume Weighted Moving Average",shortName:"VWMA",shouldOhlc:!0,paramMap:{length:{defaultValue:[20],type:"numberArray"}},calc(e,t,i){if(!i)return[{key:"vwma",title:"VWMA",type:"line",data:[]}];const o=tt(t,"length",this.paramMap.length.defaultValue),n=[];return o.forEach(((t,s)=>{let a=0,r=0;const l=[];e.forEach(((o,n)=>{const s=i[n]?.value??0;if(a+=o.close*s,r+=s,n>=t-1){const s=0!==r?a/r:NaN;l.push({time:o.time,value:s});const c=i[n-(t-1)].value??0;a-=e[n-(t-1)].close*c,r-=c}else l.push({time:o.time,value:NaN})}));const c=o.length>1?`_${s+1}`:"";n.push({key:"vwma"+c,title:"VWMA"+t+(o.length>1?` #${s+1}`:""),type:"line",data:l})})),n}},bt={name:"Weighted Moving Average",shortName:"WMA",shouldOhlc:!1,paramMap:{length:{defaultValue:[9],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=[];return i.forEach(((t,n)=>{const s=[];e.forEach(((i,o)=>{if(o<t-1)return void s.push({time:i.time,value:NaN});let n=0,a=0;for(let i=0;i<t;i++){const s=t-i;n+=s,a+=e[o-i].close*s}s.push({time:i.time,value:a/n})}));const a=i.length>1?`_${n+1}`:"";o.push({key:"wma"+a,title:"WMA"+t+(i.length>1?` #${n+1}`:""),type:"line",data:s})})),o}},wt=[ot,st,at,rt,{name:"High & Low",shortName:"HHLL",shouldOhlc:!0,paramMap:{length:{defaultValue:[14],type:"numberArray"}},calc(e,t){const i=tt(t,"length",this.paramMap.length.defaultValue),o=[];return i.forEach(((t,n)=>{const s=[],a=[];e.forEach(((i,o)=>{if(o<t-1)return s.push({time:i.time,value:NaN}),void a.push({time:i.time,value:NaN});let n=-1/0,r=1/0;for(let i=o-(t-1);i<=o;i++)n=Math.max(n,e[i].high),r=Math.min(r,e[i].low);s.push({time:i.time,value:n}),a.push({time:i.time,value:r})}));const r=i.length>1?`_${n+1}`:"";o.push({key:"hh"+r,title:"HH"+t+(i.length>1?` #${n+1}`:""),type:"line",data:s}),o.push({key:"ll"+r,title:"LL"+t+(i.length>1?` #${n+1}`:""),type:"line",data:a})})),o}},lt,ct,ht,dt,pt,ut,mt,gt,yt,ft,_t,vt,bt],xt={name:"Awesome Oscillator",shortName:"AO",shouldOhlc:!0,paramMap:{shortPeriod:{defaultValue:[5],type:"numberArray",min:1,max:100},longPeriod:{defaultValue:[34],type:"numberArray",min:1,max:200}},calc(e,t){const i=tt(t,"shortPeriod",[5]),o=tt(t,"longPeriod",[34]),n=Math.max(i.length,o.length),s=[];for(let a=0;a<n;a++){const r=it(i,a),l=it(o,a),c=Math.max(r,l);let h=0,d=0;const p=[];e.forEach(((t,i)=>{const o=(t.high+t.low)/2;h+=o,d+=o;let n=NaN,s=NaN;if(i>=r-1){n=h/r;const t=(e[i-(r-1)].high+e[i-(r-1)].low)/2;h-=t}if(i>=l-1){s=d/l;const t=(e[i-(l-1)].high+e[i-(l-1)].low)/2;d-=t}let a=NaN;i>=c-1&&(a=n-s),p.push({time:t.time,value:a})}));const u="ao"+(n>1?`_${a+1}`:""),m="AO"+it(i,a)+(n>1?` #${a+1}`:"");et(p,t?.upColor??"green",t?.downColor??"red"),s.push({key:u,title:m,type:"histogram",data:p,pane:1})}return s}},Ct={name:"Average True Range",shortName:"ATR",shouldOhlc:!0,paramMap:{length:{defaultValue:[14],type:"numberArray",min:1,max:100}},calc(e,t){const i=tt(t,"length",[14]),o=[];return i.forEach(((t,n)=>{const s=[];let a=0;const r=[];e.forEach(((i,o)=>{if(0===o)return void s.push({time:i.time,value:NaN});const n=e[o-1].close,l=Math.max(i.high-i.low,Math.abs(i.high-n),Math.abs(i.low-n));r.push(l),a+=l,r.length>t&&(a-=r.shift());const c=r.length>=t?a/t:NaN;s.push({time:i.time,value:c})}));const l=i.length>1?`_${n+1}`:"";o.push({key:"atr"+l,title:"ATR"+t+(i.length>1?` #${n+1}`:""),type:"line",data:s,pane:1})})),o}},Mt={name:"Bias",shortName:"BIAS",shouldOhlc:!0,paramMap:{period1:{defaultValue:[6],type:"numberArray",min:1,max:999},period2:{defaultValue:[12],type:"numberArray",min:1,max:999},period3:{defaultValue:[24],type:"numberArray",min:1,max:999}},calc(e,t){const i=tt(t,"period1",[6]),o=tt(t,"period2",[12]),n=tt(t,"period3",[24]),s=Math.max(i.length,o.length,n.length),a=[];for(let t=0;t<s;t++){const r=[it(i,t),it(o,t),it(n,t)],l=r.map((()=>0)),c=r.map(((e,i)=>({key:`bias${i+1}`+(s>1?`_${t+1}`:""),title:`BIAS${e}`+(s>1?` #${t+1}`:""),type:"line",data:[],pane:1})));e.forEach(((t,i)=>{const o=t.close;r.forEach(((n,s)=>{if(l[s]+=o,i>=n-1){const a=l[s]/n,r=(o-a)/a*100;c[s].data.push({time:t.time,value:r}),l[s]-=e[i-(n-1)].close}else c[s].data.push({time:t.time,value:NaN})}))})),a.push(...c)}return a}},St={name:"Buy-Ratio Analysis",shortName:"BRAR",shouldOhlc:!0,paramMap:{length:{defaultValue:[26],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"length",[26]),o=[];return i.forEach(((t,n)=>{let s=0,a=0,r=0,l=0;const c=[],h=[];e.forEach(((i,o)=>{const n=o-1>=0?e[o-1]:i;if(r+=i.high-i.open,l+=i.open-i.low,s+=i.high-n.close,a+=n.close-i.low,o>=t-1){const n=0!==a?s/a*100:0,d=0!==l?r/l*100:0;c.push({time:i.time,value:n}),h.push({time:i.time,value:d});const p=e[o-(t-1)],u=o-t>=0?e[o-t]:p;s-=p.high-u.close,a-=u.close-p.low,r-=p.high-p.open,l-=p.open-p.low}else c.push({time:i.time,value:NaN}),h.push({time:i.time,value:NaN})}));const d=i.length>1?`_${n+1}`:"";o.push({key:"br"+d,title:"BR"+t+(i.length>1?` #${n+1}`:""),type:"line",data:c,pane:1}),o.push({key:"ar"+d,title:"AR"+t+(i.length>1?` #${n+1}`:""),type:"line",data:h,pane:1})})),o}},kt={name:"Bull and Bear Index",shortName:"BBI",shouldOhlc:!0,paramMap:{p1:{defaultValue:[3],type:"numberArray",min:1},p2:{defaultValue:[6],type:"numberArray",min:1},p3:{defaultValue:[12],type:"numberArray",min:1},p4:{defaultValue:[24],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"p1",[3]),o=tt(t,"p2",[6]),n=tt(t,"p3",[12]),s=tt(t,"p4",[24]),a=Math.max(i.length,o.length,n.length,s.length),r=[];for(let t=0;t<a;t++){const l=it(i,t),c=it(o,t),h=it(n,t),d=it(s,t),p=[l,c,h,d],u=[0,0,0,0],m=[0,0,0,0],g=[];e.forEach(((t,i)=>{const o=t.close;if(p.forEach(((t,n)=>{u[n]+=o,i>=t-1&&(m[n]=u[n]/t,u[n]-=e[i-(t-1)].close)})),i>=Math.max(...p)-1){const e=(m[0]+m[1]+m[2]+m[3])/4;g.push({time:t.time,value:e})}else g.push({time:t.time,value:NaN})}));const y=a>1?`_${t+1}`:"";r.push({key:"bbi"+y,title:"BBI"+[l,c,h,d].join(",")+(a>1?` #${t+1}`:""),type:"line",data:g,pane:1})}return r}},Pt={name:"Commodity Channel Index",shortName:"CCI",shouldOhlc:!0,paramMap:{length:{defaultValue:[20],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"length",[20]),o=[];return i.forEach(((t,n)=>{let s=0;const a=[],r=[];e.forEach(((i,o)=>{const n=(i.high+i.low+i.close)/3;if(s+=n,a.push(n),o>=t-1){const l=s/t;let c=0;for(let e=o-(t-1);e<=o;e++)c+=Math.abs(a[e]-l);const h=c/t,d=0!==h?(n-l)/(.015*h):0;r.push({time:i.time,value:d});const p=(e[o-(t-1)].high+e[o-(t-1)].low+e[o-(t-1)].close)/3;s-=p}else r.push({time:i.time,value:NaN})}));const l=i.length>1?`_${n+1}`:"";o.push({key:"cci"+l,title:"CCI"+t+(i.length>1?` #${n+1}`:""),type:"line",data:r,pane:1})})),o}},Tt={name:"Current Ratio",shortName:"CR",shouldOhlc:!0,paramMap:{length:{defaultValue:[26],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"length",[26]),o=[];return i.forEach(((t,n)=>{let s=0,a=0;const r=[],l=[],c=[];e.forEach(((i,o)=>{const n=o-1>=0?e[o-1]:i,h=(n.high+n.low)/2,d=Math.max(0,i.high-h),p=Math.max(0,h-i.low);s+=d,a+=p,r.push(d),l.push(p);let u=NaN;o>=t-1&&(u=0!==a?s/a*100:0,s-=r[o-(t-1)],a-=l[o-(t-1)]),c.push({time:i.time,value:u})}));const h=i.length>1?`_${n+1}`:"";o.push({key:"cr"+h,title:"CR"+t+(i.length>1?` #${n+1}`:""),type:"line",data:c,pane:1})})),o}},Dt={name:"Difference of Moving Average",shortName:"DMA",shouldOhlc:!0,paramMap:{n1:{defaultValue:[10],type:"numberArray",min:1},n2:{defaultValue:[50],type:"numberArray",min:1},m:{defaultValue:[10],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"n1",[10]),o=tt(t,"n2",[50]),n=tt(t,"m",[10]),s=Math.max(i.length,o.length,n.length),a=[];for(let t=0;t<s;t++){const r=it(i,t),l=it(o,t),c=it(n,t),h=Math.max(r,l);let d=0,p=0,u=0;const m=[],g=[],y=[];e.forEach(((t,i)=>{d+=t.close,p+=t.close;let o=NaN,n=NaN;if(i>=r-1&&(o=d/r,d-=e[i-(r-1)].close),i>=l-1&&(n=p/l,p-=e[i-(l-1)].close),i>=h-1){const e=o-n;if(y.push(e),m.push({time:t.time,value:e}),u+=e,y.length>c){u-=y[y.length-1-c];const e=u/c;g.push({time:t.time,value:e})}else g.push({time:t.time,value:NaN})}else m.push({time:t.time,value:NaN}),g.push({time:t.time,value:NaN})}));const f=s>1?`_${t+1}`:"";a.push({key:"dma"+f,title:"DMA"+r+"-"+l+(s>1?` #${t+1}`:""),type:"line",data:m,pane:1}),a.push({key:"ama"+f,title:"AMA"+r+"-"+l+(s>1?` #${t+1}`:""),type:"line",data:g,pane:1})}return a}},Lt={name:"Directional Movement Index",shortName:"DMI",shouldOhlc:!0,paramMap:{n:{defaultValue:[14],type:"numberArray",min:1},mm:{defaultValue:[6],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"n",[14]),o=tt(t,"mm",[6]),n=Math.max(i.length,o.length),s=[];for(let t=0;t<n;t++){const a=it(i,t),r=it(o,t);let l=0,c=0,h=0,d=0,p=!1;const u=[],m=[],g=[],y=[];e.forEach(((t,i)=>{const o=i-1>=0?e[i-1]:t,n=t.high-o.high,s=o.low-t.low,f=Math.max(t.high-t.low,Math.abs(t.high-o.close),Math.abs(o.close-t.low));let _=0,v=0;n>0&&n>s&&(_=n),s>0&&s>n&&(v=s),0===i?(l=f,c=_,h=v):(l=(l*(a-1)+f)/a,c=(c*(a-1)+_)/a,h=(h*(a-1)+v)/a);let b=NaN,w=NaN;0!==l&&(b=c/l*100,w=h/l*100),u.push({time:t.time,value:b}),m.push({time:t.time,value:w});let x=NaN;if(isNaN(b)||isNaN(w)||b+w===0||(x=Math.abs(w-b)/(w+b)*100),i<a-1)g.push({time:t.time,value:NaN}),y.push({time:t.time,value:NaN});else if(p?d=(d*(a-1)+x)/a:(d=x,p=!0),g.push({time:t.time,value:d}),i<a-1+r)y.push({time:t.time,value:NaN});else{const e=g[g.length-1-r];if(e){const i=(d+e.value)/2;y.push({time:t.time,value:i})}else y.push({time:t.time,value:NaN})}}));const f=n>1?`_${t+1}`:"";s.push({key:"pdi"+f,title:"PDI"+a+(n>1?` #${t+1}`:""),type:"line",data:u,pane:1}),s.push({key:"mdi"+f,title:"MDI"+a+(n>1?` #${t+1}`:""),type:"line",data:m,pane:1}),s.push({key:"adx"+f,title:"ADX"+a+(n>1?` #${t+1}`:""),type:"line",data:g,pane:1}),s.push({key:"adxr"+f,title:"ADXR"+a+(n>1?` #${t+1}`:""),type:"line",data:y,pane:1})}return s}},Et={name:"Momentum",shortName:"MTM",shouldOhlc:!0,paramMap:{n:{defaultValue:[12],type:"numberArray",min:1},m:{defaultValue:[6],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"n",[12]),o=tt(t,"m",[6]),n=Math.max(i.length,o.length),s=[];for(let t=0;t<n;t++){const a=it(i,t),r=it(o,t),l=[],c=[];let h=0;const d=[];e.forEach(((t,i)=>{if(i>=a){const o=e[i-a],n=t.close-o.close;l.push({time:t.time,value:n}),d.push(n),h+=n,d.length>r&&(h-=d[d.length-1-r]);const s=d.length>=r?h/r:NaN;c.push({time:t.time,value:s})}else l.push({time:t.time,value:NaN}),c.push({time:t.time,value:NaN})}));const p=n>1?`_${t+1}`:"";s.push({key:"mtm"+p,title:"MTM"+a+(n>1?` #${t+1}`:""),type:"line",data:l,pane:1}),s.push({key:"maMtm"+p,title:"MAMTM"+a+(n>1?` #${t+1}`:""),type:"line",data:c,pane:1})}return s}},It={name:"Psychological Line",shortName:"PSY",shouldOhlc:!0,paramMap:{n:{defaultValue:[12],type:"numberArray",min:1},m:{defaultValue:[6],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"n",[12]),o=tt(t,"m",[6]),n=Math.max(i.length,o.length),s=[];for(let t=0;t<n;t++){const a=it(i,t),r=it(o,t);let l=0;const c=[];let h=0;const d=[],p=[],u=[];e.forEach(((t,i)=>{const o=i-1>=0?e[i-1]:t,n=t.close>o.close?1:0;if(c.push(n),l+=n,i>=a-1){const e=l/a*100;d.push({time:t.time,value:e}),u.push(e),h+=e,u.length>r&&(h-=u[u.length-1-r]);const o=u.length>=r?h/r:NaN;p.push({time:t.time,value:o}),l-=c[i-(a-1)]}else d.push({time:t.time,value:NaN}),p.push({time:t.time,value:NaN})}));const m=n>1?`_${t+1}`:"";s.push({key:"psy"+m,title:"PSY"+a+(n>1?` #${t+1}`:""),type:"line",data:d,pane:1}),s.push({key:"maPsy"+m,title:"MAPSY"+a+(n>1?` #${t+1}`:""),type:"line",data:p,pane:1})}return s}},Ot={name:"Rate of Change",shortName:"ROC",shouldOhlc:!0,paramMap:{n:{defaultValue:[12],type:"numberArray",min:1},m:{defaultValue:[6],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"n",[12]),o=tt(t,"m",[6]),n=Math.max(i.length,o.length),s=[];for(let t=0;t<n;t++){const a=it(i,t),r=it(o,t),l=[],c=[];let h=0;const d=[];e.forEach(((t,i)=>{if(i>=a){const o=e[i-a].close;let n=0;0!==o&&(n=(t.close-o)/o*100),l.push({time:t.time,value:n}),d.push(n),h+=n,d.length>r&&(h-=d[d.length-1-r]);const s=d.length>=r?h/r:NaN;c.push({time:t.time,value:s})}else l.push({time:t.time,value:NaN}),c.push({time:t.time,value:NaN})}));const p=n>1?`_${t+1}`:"";s.push({key:"roc"+p,title:"ROC"+a+(n>1?` #${t+1}`:""),type:"line",data:l,pane:1}),s.push({key:"maRoc"+p,title:"MAROC"+a+(n>1?` #${t+1}`:""),type:"line",data:c,pane:1})}return s}},Nt={name:"Relative Strength Index",shortName:"RSI",shouldOhlc:!0,paramMap:{p1:{defaultValue:[6],type:"numberArray",min:1},p2:{defaultValue:[12],type:"numberArray",min:1},p3:{defaultValue:[24],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"p1",[6]),o=tt(t,"p2",[12]),n=tt(t,"p3",[24]),s=Math.max(i.length,o.length,n.length),a=[];for(let t=0;t<s;t++){const r=[it(i,t),it(o,t),it(n,t)],l=r.map((()=>0)),c=r.map((()=>0)),h=r.map(((e,i)=>({key:`rsi${i+1}`+(s>1?`_${t+1}`:""),title:`RSI${e}`+(s>1?` #${t+1}`:""),type:"line",data:[],pane:1})));e.forEach(((t,i)=>{const o=i-1>=0?e[i-1]:t,n=t.close-o.close;r.forEach(((o,s)=>{if(n>0?l[s]+=n:c[s]+=Math.abs(n),i>=o-1){const n=0!==c[s]?100-100/(1+l[s]/c[s]):100;h[s].data.push({time:t.time,value:n});const a=e[i-(o-1)].close-(e[i-o]?.close||0);a>0?l[s]-=a:c[s]-=Math.abs(a)}else h[s].data.push({time:t.time,value:NaN})}))})),a.push(...h)}return a}},At={name:"Stochastic",shortName:"KDJ",shouldOhlc:!0,paramMap:{n:{defaultValue:[9],type:"numberArray",min:1},kPeriod:{defaultValue:[3],type:"numberArray",min:1},dPeriod:{defaultValue:[3],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"n",[9]),o=tt(t,"kPeriod",[3]),n=tt(t,"dPeriod",[3]),s=Math.max(i.length,o.length,n.length),a=[];for(let t=0;t<s;t++){const r=it(i,t),l=it(o,t),c=it(n,t);let h=50,d=50;const p=[],u=[],m=[];e.forEach(((t,i)=>{if(i<r-1)return p.push({time:t.time,value:NaN}),u.push({time:t.time,value:NaN}),void m.push({time:t.time,value:NaN});const o=e.slice(i-(r-1),i+1),n=Math.max(...o.map((e=>e.high))),s=Math.min(...o.map((e=>e.low))),a=n===s?100:(t.close-s)/(n-s)*100,g=((l-1)*h+a)/l,y=((c-1)*d+g)/c,f=3*g-2*y;p.push({time:t.time,value:g}),u.push({time:t.time,value:y}),m.push({time:t.time,value:f}),h=g,d=y}));const g=s>1?`_${t+1}`:"";a.push({key:"k"+g,title:"K"+r+(s>1?` #${t+1}`:""),type:"line",data:p,pane:1}),a.push({key:"d"+g,title:"D"+r+(s>1?` #${t+1}`:""),type:"line",data:u,pane:1}),a.push({key:"j"+g,title:"J"+r+(s>1?` #${t+1}`:""),type:"line",data:m,pane:1})}return a}},Vt={name:"Variance",shortName:"Variance",shouldOhlc:!0,paramMap:{length:{defaultValue:[14],type:"numberArray",min:1,max:100}},calc(e,t){const i=tt(t,"length",[14]),o=[];return i.forEach(((t,n)=>{const s=[];e.forEach(((i,o)=>{if(o<t-1)return void s.push({time:i.time,value:NaN});const n=e.slice(o-(t-1),o+1).map((e=>e.close)),a=n.reduce(((e,t)=>e+t),0)/n.length,r=n.reduce(((e,t)=>e+Math.pow(t-a,2)),0)/n.length;s.push({time:i.time,value:r})}));const a=i.length>1?`_${n+1}`:"";o.push({key:"variance"+a,title:"Variance"+t+(i.length>1?` #${n+1}`:""),type:"line",data:s,pane:1})})),o}},$t={name:"Williams %R",shortName:"WR",shouldOhlc:!0,paramMap:{p1:{defaultValue:[6],type:"numberArray",min:1},p2:{defaultValue:[10],type:"numberArray",min:1},p3:{defaultValue:[14],type:"numberArray",min:1}},calc(e,t){const i=tt(t,"p1",[6]),o=tt(t,"p2",[10]),n=tt(t,"p3",[14]),s=Math.max(i.length,o.length,n.length),a=[];for(let t=0;t<s;t++){const r=[it(i,t),it(o,t),it(n,t)],l=r.map(((e,i)=>({key:`wr${i+1}`+(s>1?`_${t+1}`:""),title:`WR${e}`+(s>1?` #${t+1}`:""),type:"line",data:[],pane:1})));e.forEach(((t,i)=>{r.forEach(((o,n)=>{if(i>=o-1){let s=-1/0,a=1/0;for(let t=i-(o-1);t<=i;t++)s=Math.max(s,e[t].high),a=Math.min(a,e[t].low);const r=s!==a?(t.close-s)/(s-a)*100:0;l[n].data.push({time:t.time,value:r})}else l[n].data.push({time:t.time,value:NaN})}))})),a.push(...l)}return a}},Rt={name:"Change",shortName:"Change",shouldOhlc:!0,paramMap:{length:{defaultValue:[1],type:"numberArray",min:1,max:100}},calc(e,t){const i=tt(t,"length",[1]),o=[];return i.forEach(((t,n)=>{const s=[];e.forEach(((i,o)=>{if(o<t)return void s.push({time:i.time,value:NaN});const n=e[o-t].close;s.push({time:i.time,value:i.close-n})}));const a=i.length>1?`_${n+1}`:"";o.push({key:"change"+a,title:"Change"+t+(i.length>1?` #${n+1}`:""),type:"line",data:s,pane:1})})),o}},Gt={name:"Range",shortName:"Range",shouldOhlc:!0,paramMap:{length:{defaultValue:[14],type:"numberArray",min:1,max:100}},calc(e,t){const i=tt(t,"length",[14]),o=[];return i.forEach(((t,n)=>{const s=[];e.forEach(((i,o)=>{if(o<t-1)return void s.push({time:i.time,value:NaN});const n=e.slice(o-(t-1),o+1),a=Math.max(...n.map((e=>e.high))),r=Math.min(...n.map((e=>e.low)));s.push({time:i.time,value:a-r})}));const a=i.length>1?`_${n+1}`:"";o.push({key:"range"+a,title:"Range"+t+(i.length>1?` #${n+1}`:""),type:"line",data:s,pane:1})})),o}},Bt={name:"Standard Deviation",shortName:"StdDev",shouldOhlc:!0,paramMap:{length:{defaultValue:[14],type:"numberArray",min:1,max:100}},calc(e,t){const i=tt(t,"length",[14]),o=[];return i.forEach(((t,n)=>{const s=[];e.forEach(((i,o)=>{if(o<t-1)return void s.push({time:i.time,value:NaN});const n=e.slice(o-(t-1),o+1).map((e=>e.close)),a=n.reduce(((e,t)=>e+t),0)/n.length,r=n.reduce(((e,t)=>e+Math.pow(t-a,2)),0)/n.length,l=Math.sqrt(r);s.push({time:i.time,value:l})}));const a=i.length>1?`_${n+1}`:"";o.push({key:"stdDev"+a,title:"StdDev"+t+(i.length>1?` #${n+1}`:""),type:"line",data:s,pane:1})})),o}},Ft=[...wt,...[xt,Ct,Mt,St,kt,Pt,Tt,Dt,Lt,Et,{name:"Moving Average Convergence Divergence",shortName:"MACD",shouldOhlc:!0,paramMap:{shortPeriod:{defaultValue:12,type:"number",min:1},longPeriod:{defaultValue:26,type:"number",min:1},signalPeriod:{defaultValue:9,type:"number",min:1}},calc(e,t){const i=function(e,t){const i={};for(const[o,n]of Object.entries(e.paramMap)){const e=t?.[o]??n.defaultValue;i[o]=e}return i}(this,t),o=i.shortPeriod,n=i.longPeriod,s=i.signalPeriod;let a=0,r=0,l=0,c=0,h=0;const d=[],p=[],u=[];let m=0;e.forEach(((e,t)=>{m+=e.close,t===o-1?a=m/o:t>o-1&&(a=(2*e.close+(o-1)*a)/(o+1)),t===n-1?r=m/n:t>n-1&&(r=(2*e.close+(n-1)*r)/(n+1)),t>=Math.max(o,n)-1?(l=a-r,d.push({time:e.time,value:l}),h+=l,d.length===s?c=h/s:d.length>s&&(c=(2*l+(s-1)*c)/(s+1)),d.length>=s?(p.push({time:e.time,value:c}),u.push({time:e.time,value:2*(l-c)})):(p.push({time:e.time,value:NaN}),u.push({time:e.time,value:NaN}))):(d.push({time:e.time,value:NaN}),p.push({time:e.time,value:NaN}),u.push({time:e.time,value:NaN}))}));return et(u,t?.upColor??"green",t?.downColor??"red"),[{key:"dif",title:"DIF",type:"line",data:d,pane:1},{key:"dea",title:"DEA",type:"line",data:p,pane:1},{key:"macd",title:"MACD",type:"histogram",data:u,pane:1}]}},It,Ot,Nt,At,Vt,$t,Rt,Gt,Bt]];class Ut{contextMenu;handler;container;currentTab="options";constructor(e){this.contextMenu=e.contextMenu,this.handler=e.handler,this.container=this.contextMenu.div}openMenu(e,t,i){const o={type:i||e._type||e.constructor.name,object:e.toJSON(),title:e.title},n=JSON.stringify(o,null,2);let s={};e instanceof Zt?s=e.chart.options():void 0!==e.options?s="function"==typeof e.options?e.options():e.options:void 0!==e._options&&(s=e._options);const a={...s},r=JSON.stringify(a,null,2),l=document.createElement("div");l.style.position="fixed",l.style.top="0",l.style.left="0",l.style.width="100%",l.style.height="100%",l.style.backgroundColor="rgba(0, 0, 0, 0.5)",l.style.display="flex",l.style.justifyContent="center",l.style.alignItems="center",l.style.zIndex="1000";const c=e=>{"Escape"===e.key&&this.close(l,c)};document.addEventListener("keydown",c);const h=document.createElement("div");h.style.backgroundColor="#333",h.style.color="#fff",h.style.padding="20px",h.style.borderRadius="8px",h.style.width="80%",h.style.maxWidth="800px",h.style.maxHeight="90%",h.style.overflowY="auto",h.style.boxShadow="0 2px 10px rgba(0,0,0,0.5)",h.setAttribute("tabindex","-1"),h.focus();const d=document.createElement("div");d.style.display="flex",d.style.borderBottom="1px solid #555",d.style.marginBottom="10px";const p=document.createElement("button");p.textContent="Options",p.style.flex="1",p.style.padding="10px",p.style.cursor="pointer",p.style.border="none",p.style.backgroundColor="options"===this.currentTab?"#555":"#333",p.onclick=()=>{this.currentTab="options",p.style.backgroundColor="#555",u.style.backgroundColor="#333",g.value=r,v.style.display="flex",y.style.display="none"};const u=document.createElement("button");u.textContent="Full",u.style.flex="1",u.style.padding="10px",u.style.cursor="pointer",u.style.border="none",u.style.backgroundColor="full"===this.currentTab?"#555":"#333",u.onclick=()=>{this.currentTab="full",u.style.backgroundColor="#555",p.style.backgroundColor="#333",g.value=n,y.style.display="flex",v.style.display="none"},d.appendChild(p),d.appendChild(u),h.appendChild(d);const m=document.createElement("h2");m.textContent=`Export/Import ${e.title} Data`,h.appendChild(m);const g=document.createElement("textarea");g.value="full"===this.currentTab?n:r,g.style.width="100%",g.style.height="400px",g.style.marginTop="10px",g.style.marginBottom="10px",g.style.resize="vertical",g.style.backgroundColor="#444",g.style.color="#fff",g.setAttribute("aria-label","JSON Data Editor"),h.appendChild(g);const y=document.createElement("div");y.style.display="full"===this.currentTab?"flex":"none",y.style.flexWrap="wrap",y.style.justifyContent="flex-end",y.style.gap="10px";const f=document.createElement("button");f.textContent="Export",f.style.padding="8px 12px",f.style.cursor="pointer",f.style.backgroundColor="#f44336",f.style.color="#fff",f.style.border="none",f.style.borderRadius="4px",f.onclick=()=>{this.downloadJson(n,`${e.title}_full.json`)},y.appendChild(f);const _=document.createElement("button");_.textContent="Import",_.style.padding="8px 12px",_.style.cursor="pointer",_.style.backgroundColor="#4CAF50",_.style.color="#fff",_.style.border="none",_.style.borderRadius="4px",_.onclick=()=>{try{const t=JSON.parse(g.value);if("object"!=typeof t||!t.object)throw new Error("Invalid structure: missing 'object'.");e.fromJSON(t.object),"function"==typeof e.updateView&&e.updateView(),this.showNotification("Whole data imported successfully.","success")}catch(e){this.showNotification("Failed to import whole data: "+e.message,"error")}},y.appendChild(_);const v=document.createElement("div");v.style.display="options"===this.currentTab?"flex":"none",v.style.flexWrap="wrap",v.style.justifyContent="flex-end",v.style.gap="10px";const b=document.createElement("button");b.textContent="Export Options",b.style.padding="8px 12px",b.style.cursor="pointer",b.style.backgroundColor="#f44336",b.style.color="#fff",b.style.border="none",b.style.borderRadius="4px",b.onclick=()=>{this.downloadJson(r,`${e.title}_options.json`)},v.appendChild(b);const w=document.createElement("button");w.textContent="Import Options",w.style.padding="8px 12px",w.style.cursor="pointer",w.style.backgroundColor="#4CAF50",w.style.color="#fff",w.style.border="none",w.style.borderRadius="4px",w.onclick=()=>{const t=document.createElement("input");t.type="file",t.accept="application/json",t.style.display="none",t.addEventListener("change",(()=>{if(t.files&&t.files.length>0){const i=t.files[0],o=new FileReader;o.onload=()=>{try{const t=o.result;if("string"!=typeof t)throw new Error("File content is not a string.");g.value=t;const i=JSON.parse(t);if("object"!=typeof i||!i.options)throw new Error("Invalid structure: missing 'options'.");e.fromJSON(i.options),"function"==typeof e.updateView&&e.updateView(),this.showNotification("Options imported successfully.","success")}catch(e){this.showNotification("Failed to import options: "+e.message,"error")}},o.readAsText(i)}})),t.click()},v.appendChild(w);const x=document.createElement("button");x.textContent="Save",x.style.padding="8px 12px",x.style.cursor="pointer",x.style.backgroundColor="#008CBA",x.style.color="#fff",x.style.border="none",x.style.borderRadius="4px",x.onclick=()=>{try{const t=JSON.parse(g.value);if("object"!=typeof t||!t.options)throw new Error("Invalid structure: missing 'options'.");e.fromJSON(t),"function"==typeof e.updateView&&e.updateView(),this.showNotification("Options saved successfully.","success")}catch(e){this.showNotification("Failed to save options: "+e.message,"error")}};const C=document.createElement("button");C.textContent="Save as Default",C.style.padding="8px 12px",C.style.cursor="pointer",C.style.backgroundColor="#008CBA",C.style.color="#fff",C.style.border="none",C.style.borderRadius="4px",C.onclick=()=>{let t={};e instanceof Zt?t=e.chart.options():"function"==typeof e.options?t=e.options():void 0!==e.options?t=e.options:void 0!==e._options&&(t=e._options);const i=JSON.stringify(t,null,2);let o;if(e._type&&"custom/custom"===e._type.toLowerCase()){if(o=prompt("Enter save key (e.g., area, line, candlestick):",e.title.toLowerCase())||"",!o)return}else o=e._type?e._type.toLowerCase():e.title.toLowerCase();const n=`save_defaults_~_${o};;;${i}`;window.callbackFunction(n)},this.container.appendChild(C);const M=document.createElement("div");M.style.display="flex",M.style.flexDirection="column",M.style.gap="10px",M.appendChild(y),M.appendChild(v),M.appendChild(x),M.appendChild(C),h.appendChild(M),l.appendChild(h),this.container.appendChild(l)}downloadJson(e,t){try{const i=new Blob([e],{type:"application/json"}),o=URL.createObjectURL(i),n=document.createElement("a");n.href=o,n.download=t,n.click(),URL.revokeObjectURL(o)}catch(e){this.showNotification("Failed to download data: "+e,"error")}}addSaveDefaultButton(e){const t=document.createElement("button");t.textContent="Save as Default",t.style.padding="8px 12px",t.style.cursor="pointer",t.style.backgroundColor="#008CBA",t.style.color="#fff",t.style.border="none",t.style.borderRadius="4px",t.onclick=()=>{let t={};e instanceof Zt?t=e.chart.options():"function"==typeof e.options?t=e.options():void 0!==e.options?t=e.options:void 0!==e._options&&(t=e._options);const i=JSON.stringify(t,null,2),o=prompt("Enter save key (area, line, trend-trace, candlestick etc):",e.title.toLowerCase());if(!o)return;const n=`save_defaults_${o}_~_${i}`;window.callbackFunction(n)},this.container.appendChild(t)}close(e,t){e.parentElement&&e.parentElement.removeChild(e),document.removeEventListener("keydown",t)}showNotification(e,t){const i=document.createElement("div");i.textContent=e,i.style.position="fixed",i.style.bottom="20px",i.style.right="20px",i.style.padding="10px 20px",i.style.borderRadius="4px",i.style.color="#fff",i.style.backgroundColor="success"===t?"#4CAF50":"#f44336",i.style.boxShadow="0 2px 6px rgba(0,0,0,0.2)",i.style.zIndex="1001",i.style.opacity="0",i.style.transition="opacity 0.5s ease-in-out",this.container.appendChild(i),setTimeout((()=>{i.style.opacity="1"}),100),setTimeout((()=>{i.style.opacity="0",setTimeout((()=>{i.parentElement&&i.parentElement.removeChild(i)}),500)}),3e3)}openDefaultOptions(e){const t=this.handler.defaultsManager;if(!t)return void this.showNotification("No defaults manager found.","error");const i=t.get(e);if(!i)return void this.showNotification(`No default config found for key: "${e}"`,"error");const o=JSON.stringify(i,null,2),n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor="rgba(0,0,0,0.5)",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="1000";const s=e=>{"Escape"===e.key&&this.close(n,s)};document.addEventListener("keydown",s);const a=document.createElement("div");a.style.backgroundColor="#333",a.style.color="#fff",a.style.padding="20px",a.style.borderRadius="8px",a.style.width="80%",a.style.maxWidth="800px",a.style.maxHeight="90%",a.style.overflowY="auto",a.style.boxShadow="0 2px 10px rgba(0,0,0,0.5)",a.setAttribute("tabindex","-1"),a.focus();const r=document.createElement("h2");r.textContent=`Edit Default Options - "${e}"`,a.appendChild(r);const l=document.createElement("textarea");l.value=o,l.style.width="100%",l.style.height="400px",l.style.resize="vertical",l.style.backgroundColor="#444",l.style.color="#fff",l.style.border="none",l.style.margin="10px 0",l.style.padding="10px",a.appendChild(l);const c=document.createElement("div");c.style.display="flex",c.style.flexWrap="wrap",c.style.gap="10px",c.style.justifyContent="flex-end";const h=document.createElement("button");h.textContent="Export",h.style.padding="8px 12px",h.style.cursor="pointer",h.style.backgroundColor="#f44336",h.style.color="#fff",h.style.border="none",h.style.borderRadius="4px",h.onclick=()=>{this.downloadJson(l.value,`${e}_defaults.json`)},c.appendChild(h);const d=document.createElement("button");d.textContent="Import",d.style.padding="8px 12px",d.style.cursor="pointer",d.style.backgroundColor="#4CAF50",d.style.color="#fff",d.style.border="none",d.style.borderRadius="4px",d.onclick=()=>{const e=document.createElement("input");e.type="file",e.accept="application/json",e.style.display="none",e.addEventListener("change",(()=>{if(e.files&&e.files.length>0){const t=e.files[0],i=new FileReader;i.onload=()=>{try{if("string"!=typeof i.result)throw new Error("File content is not a string.");l.value=i.result}catch(e){this.showNotification("Failed to read defaults file: "+e.message,"error")}},i.readAsText(t)}})),e.click()},c.appendChild(d);const p=document.createElement("button");p.textContent="Save",p.style.padding="8px 12px",p.style.cursor="pointer",p.style.backgroundColor="#008CBA",p.style.color="#fff",p.style.border="none",p.style.borderRadius="4px",p.onclick=()=>{try{const i=JSON.parse(l.value);t.set(e,i),this.showNotification(`Defaults for "${e}" saved successfully.`,"success")}catch(e){this.showNotification("Failed to save defaults: "+e.message,"error")}},c.appendChild(p);const u=document.createElement("button");u.textContent="Cancel",u.style.padding="8px 12px",u.style.cursor="pointer",u.style.backgroundColor="#444",u.style.color="#fff",u.style.border="none",u.style.borderRadius="4px",u.onclick=()=>{this.close(n,s)},c.appendChild(u),a.appendChild(c),n.appendChild(a),this.container.appendChild(n)}}class Ht{container;backdrop;isOpen=!1;categories=[];contentArea;activeCategoryId="";handler;colorPicker=null;constructor(e){this.handler=e,this.backdrop=document.createElement("div"),this.backdrop.style.position="fixed",this.backdrop.style.top="0",this.backdrop.style.left="0",this.backdrop.style.width="100%",this.backdrop.style.height="100%",this.backdrop.style.backgroundColor="rgba(0,0,0,0.5)",this.backdrop.style.opacity="0",this.backdrop.style.transition="opacity 0.3s ease",this.backdrop.style.zIndex="9998",this.backdrop.style.display="none",this.backdrop.addEventListener("click",(e=>{e.target===this.backdrop&&this.close(!1)})),document.body.appendChild(this.backdrop),this.container=document.createElement("div"),this.container.style.position="fixed",this.container.style.top="50%",this.container.style.left="50%",this.container.style.transform="translate(-50%, -50%)",this.container.style.width="700px",this.container.style.maxWidth="90%",this.container.style.height="500px",this.container.style.maxHeight="90%",this.container.style.backgroundColor="#2B2B2B",this.container.style.color="#FFF",this.container.style.borderRadius="6px",this.container.style.boxShadow="0 2px 10px rgba(0,0,0,0.8)",this.container.style.zIndex="9999",this.container.style.opacity="0",this.container.style.display="none",this.container.style.transition="opacity 0.3s ease, transform 0.3s ease",document.body.appendChild(this.container);const t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="space-between",t.style.padding="12px 16px",t.style.borderBottom="1px solid #3C3C3C";const i=document.createElement("div");i.innerText="Settings",i.style.fontSize="16px",i.style.fontWeight="bold",t.appendChild(i);const o=document.createElement("div");o.innerText="×",o.style.fontSize="20px",o.style.cursor="pointer",o.onclick=()=>this.close(!1),t.appendChild(o),this.container.appendChild(t);const n=document.createElement("div");n.style.display="flex",n.style.flex="1 1 auto",n.style.height="calc(100% - 50px)",this.container.appendChild(n);const s=document.createElement("div");s.style.width="150px",s.style.borderRight="1px solid #3C3C3C",s.style.display="flex",s.style.flexDirection="column",n.appendChild(s),this.contentArea=document.createElement("div"),this.contentArea.style.flex="1",this.contentArea.style.padding="16px",this.contentArea.style.overflowY="auto",n.appendChild(this.contentArea);const a=document.createElement("div");a.style.borderTop="1px solid #3C3C3C",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.padding="8px 12px";const r=document.createElement("button");r.innerText="Template ▾",r.style.backgroundColor="#444",r.style.color="#FFF",r.style.border="none",r.style.borderRadius="4px",r.style.padding="6px 12px",a.appendChild(r);const l=document.createElement("div");l.style.display="flex",l.style.gap="8px";const c=document.createElement("button");c.innerText="Cancel",c.style.backgroundColor="#444",c.style.color="#FFF",c.style.border="none",c.style.borderRadius="4px",c.style.padding="6px 12px",c.style.cursor="pointer",c.onclick=()=>this.close(!1),l.appendChild(c);const h=document.createElement("button");h.innerText="Ok",h.style.backgroundColor="#008CBA",h.style.color="#FFF",h.style.border="none",h.style.borderRadius="4px",h.style.padding="6px 12px",h.style.cursor="pointer",h.onclick=()=>this.close(!0),l.appendChild(h),a.appendChild(l),this.container.appendChild(a),this.categories=[{id:"layout-options",label:"Layout Options",buildContent:()=>this.buildLayoutOptionsTab()},{id:"grid-options",label:"Grid Options",buildContent:()=>this.buildGridOptionsTab()},{id:"crosshair-options",label:"Crosshair Options",buildContent:()=>this.buildCrosshairOptionsTab()},{id:"time-scale-options",label:"Time Scale Options",buildContent:()=>this.buildTimeScaleOptionsTab()},{id:"price-scale-options",label:"Price Scale Options",buildContent:()=>this.buildPriceScaleOptionsTab()},{id:"series-list",label:"Series List",buildContent:()=>this.buildSeriesListTab()},{id:"defaults-list",label:"Defaults",buildContent:()=>this.buildDefaultsListTab()}],this.categories.forEach((e=>{const t=document.createElement("div");t.innerText=e.label,t.style.padding="8px 16px",t.style.cursor="pointer",t.style.borderBottom="1px solid #3C3C3C",t.addEventListener("click",(()=>this.switchCategory(e.id))),s.appendChild(t)})),this.categories.length>0&&this.switchCategory(this.categories[0].id)}open(){this.isOpen||(this.isOpen=!0,this.backdrop.style.display="block",setTimeout((()=>{this.backdrop.style.opacity="1"}),10),this.container.style.display="block",setTimeout((()=>{this.container.style.opacity="1",this.container.style.transform="translate(-50%, -50%) scale(1)"}),10))}close(e){e?console.log("Settings Modal: OK clicked. Save changes here."):console.log("Settings Modal: Cancel clicked."),this.isOpen=!1,this.backdrop.style.opacity="0",this.container.style.opacity="0",this.container.style.transform="translate(-50%, -50%) scale(0.95)",setTimeout((()=>{this.isOpen||(this.backdrop.style.display="none",this.container.style.display="none")}),300)}switchCategory(e){this.activeCategoryId=e,this.contentArea.innerHTML="";const t=this.categories.find((t=>t.id===e));t&&t.buildContent()}buildLayoutOptionsTab(){const e=document.createElement("div");e.innerText="Layout Options",e.style.fontSize="14px",e.style.fontWeight="bold",e.style.marginBottom="8px",this.contentArea.appendChild(e);const i=this.getCurrentOptionValue("layout.textColor")||"#000000";this.addColorPicker("Text Color",i,(e=>{this.handler.chart.applyOptions({layout:{textColor:e}})}));const o=this.handler.chart.options().layout?.background;if(o&&"solid"===o.type){const e=o.color||"#FFFFFF";this.addColorPicker("Background Color",e,(e=>{this.handler.chart.applyOptions({layout:{background:{type:t.ColorType.Solid,color:e}}})}))}else if(o&&o.type===t.ColorType.VerticalGradient){const e=o.topColor||"rgba(255,0,0,0.33)",i=o.bottomColor||"rgba(0,255,0,0.33)";this.addColorPicker("Top Color",e,(e=>{this.handler.chart.applyOptions({layout:{background:{type:t.ColorType.VerticalGradient,topColor:e,bottomColor:i}}})})),this.addColorPicker("Bottom Color",i,(i=>{this.handler.chart.applyOptions({layout:{background:{type:t.ColorType.VerticalGradient,topColor:e,bottomColor:i}}})}))}else console.warn("Unknown background type.");const n=document.createElement("button");n.innerText="Switch Background Type",n.style.marginTop="12px",n.onclick=()=>this.toggleBackgroundType(),this.contentArea.appendChild(n)}buildGridOptionsTab(){const e=document.createElement("div");e.innerText="Grid Options",e.style.fontSize="14px",e.style.fontWeight="bold",e.style.marginBottom="8px",this.contentArea.appendChild(e);const i=this.getCurrentOptionValue("grid.vertLines.color")||"#D6DCDE";this.addColorPicker("Vertical Line Color",i,(e=>{this.handler.chart.applyOptions({grid:{vertLines:{color:e}}})}));const o=this.getCurrentOptionValue("grid.horzLines.color")||"#D6DCDE";this.addColorPicker("Horizontal Line Color",o,(e=>{this.handler.chart.applyOptions({grid:{horzLines:{color:e}}})}));const n={Solid:t.LineStyle.Solid,Dotted:t.LineStyle.Dotted,Dashed:t.LineStyle.Dashed,LargeDashed:t.LineStyle.LargeDashed};this.addDropdown("Vertical Line Style",["Solid","Dashed","Dotted","LargeDashed"],(e=>{const t=n[e];this.handler.chart.applyOptions({grid:{vertLines:{style:t}}})})),this.addDropdown("Horizontal Line Style",["Solid","Dashed","Dotted","LargeDashed"],(e=>{const t=n[e];this.handler.chart.applyOptions({grid:{horzLines:{style:t}}})}));const s=!1!==this.getCurrentOptionValue("grid.vertLines.visible");this.addCheckbox("Show Vertical Lines",s,(e=>{this.handler.chart.applyOptions({grid:{vertLines:{visible:e}}})}));const a=!1!==this.getCurrentOptionValue("grid.horzLines.visible");this.addCheckbox("Show Horizontal Lines",a,(e=>{this.handler.chart.applyOptions({grid:{horzLines:{visible:e}}})}))}buildCrosshairOptionsTab(){const e=document.createElement("div");e.innerText="Crosshair Options",e.style.fontSize="14px",e.style.fontWeight="bold",e.style.marginBottom="8px",this.contentArea.appendChild(e);const t=this.getCurrentOptionValue("crosshair.vertLine.color")||"#000000";this.addColorPicker("Vertical Line Color",t,(e=>{this.handler.chart.applyOptions({crosshair:{vertLine:{color:e}}})}));const i=this.getCurrentOptionValue("crosshair.horzLine.color")||"#000000";this.addColorPicker("Horizontal Line Color",i,(e=>{this.handler.chart.applyOptions({crosshair:{horzLine:{color:e}}})}))}buildTimeScaleOptionsTab(){const e=document.createElement("div");e.innerText="Time Scale Options",e.style.fontSize="14px",e.style.fontWeight="bold",e.style.marginBottom="8px",this.contentArea.appendChild(e);const t=this.getCurrentOptionValue("timeScale.rightOffset")||0;this.addNumberField("Right Offset",t,(e=>{this.handler.chart.applyOptions({timeScale:{rightOffset:e}})}));const i=this.getCurrentOptionValue("timeScale.barSpacing")||10;this.addNumberField("Bar Spacing",i,(e=>{this.handler.chart.applyOptions({timeScale:{barSpacing:e}})}));const o=this.getCurrentOptionValue("timeScale.minBarSpacing")||.1;this.addNumberField("Min Bar Spacing",o,(e=>{this.handler.chart.applyOptions({timeScale:{minBarSpacing:e}})}));const n=this.getCurrentOptionValue("timeScale.fixLeftEdge")||!1;this.addCheckbox("Fix Left Edge",n,(e=>{this.handler.chart.applyOptions({timeScale:{fixLeftEdge:e}})}));const s=this.getCurrentOptionValue("timeScale.fixRightEdge")||!1;this.addCheckbox("Fix Right Edge",s,(e=>{this.handler.chart.applyOptions({timeScale:{fixRightEdge:e}})}));const a=this.getCurrentOptionValue("timeScale.lockVisibleTimeRangeOnResize")||!1;this.addCheckbox("Lock Visible Range on Resize",a,(e=>{this.handler.chart.applyOptions({timeScale:{lockVisibleTimeRangeOnResize:e}})}));const r=this.getCurrentOptionValue("timeScale.visible");this.addCheckbox("Time Scale Visible",!1!==r,(e=>{this.handler.chart.applyOptions({timeScale:{visible:e}})}));const l=this.getCurrentOptionValue("timeScale.borderVisible");this.addCheckbox("Border Visible",!1!==l,(e=>{this.handler.chart.applyOptions({timeScale:{borderVisible:e}})}));const c=this.getCurrentOptionValue("timeScale.borderColor")||"#000000";this.addColorPicker("Border Color",c,(e=>{this.handler.chart.applyOptions({timeScale:{borderColor:e}})}))}buildPriceScaleOptionsTab(){const e=document.createElement("div");e.innerText="Price Scale Options",e.style.fontSize="14px",e.style.fontWeight="bold",e.style.marginBottom="8px",this.contentArea.appendChild(e);const i=this.handler.chart.priceScale("right");i.options().mode||t.PriceScaleMode.Normal;const o=[{label:"Normal",value:t.PriceScaleMode.Normal},{label:"Logarithmic",value:t.PriceScaleMode.Logarithmic},{label:"Percentage",value:t.PriceScaleMode.Percentage},{label:"Indexed To 100",value:t.PriceScaleMode.IndexedTo100}],n=o.map((e=>e.label));this.addDropdown("Price Scale Mode",n,(e=>{const t=o.find((t=>t.label===e));t&&i.applyOptions({mode:t.value})}));const s=void 0===i.options().autoScale||i.options().autoScale;this.addCheckbox("Auto Scale",s,(e=>{i.applyOptions({autoScale:e})}));const a=i.options().invertScale||!1;this.addCheckbox("Invert Scale",a,(e=>{i.applyOptions({invertScale:e})}));const r=void 0===i.options().alignLabels||i.options().alignLabels;this.addCheckbox("Align Labels",r,(e=>{i.applyOptions({alignLabels:e})}));const l=void 0===i.options().borderVisible||i.options().borderVisible;this.addCheckbox("Border Visible",l,(e=>{i.applyOptions({borderVisible:e})}));const c=i.options().ticksVisible||!1;this.addCheckbox("Ticks Visible",c,(e=>{i.applyOptions({ticksVisible:e})}))}buildSeriesListTab(){const e=document.createElement("div");e.innerText="Series List",Object.assign(e.style,{fontSize:"16px",fontWeight:"bold",marginBottom:"12px"}),this.contentArea.appendChild(e);Array.from(this.handler.seriesMap.entries()).forEach((([e,t])=>{this.addButton(e,(()=>this.buildSeriesMenuTab(t)),{backgroundColor:"#444",borderRadius:"8px"})}))}buildSeriesMenuTab(e){this.contentArea.innerHTML="";const t=document.createElement("div");t.innerText="Series Settings - "+(e.options().title||"Untitled"),Object.assign(t.style,{fontSize:"16px",fontWeight:"bold",marginBottom:"12px"}),this.contentArea.appendChild(t),this.addTextInput("Title",e.options().title||"",(t=>{e.applyOptions({title:t}),this.handler.seriesMap.has(e.options().title)&&this.handler.seriesMap.delete(e.options().title),this.handler.seriesMap.set(t,e)})),this.addButton("Clone Series ▸",(()=>{alert("Clone Series functionality not implemented in modal demo.")})),this.addButton("Visibility Options ▸",(()=>{alert("Visibility Options not implemented in modal demo.")})),this.addButton("Style Options ▸",(()=>{alert("Style Options not implemented in modal demo.")})),this.addButton("Width Options ▸",(()=>{alert("Width Options not implemented in modal demo.")})),this.addButton("Color Options ▸",(()=>{alert("Color Options not implemented in modal demo.")})),this.addButton("Price Scale Options ▸",(()=>{alert("Price Scale Options not implemented in modal demo.")})),this.addButton("Primitives ▸",(()=>{alert("Primitives not implemented in modal demo.")})),this.addButton("Indicators ▸",(()=>{alert("Indicators not implemented in modal demo.")})),this.addButton("Export/Import Series Data ▸",(()=>{alert("Export/Import Series Data not implemented in modal demo.")})),this.addButton("⤝ Back to Series List",(()=>this.buildSeriesListTab()),{backgroundColor:"#444"})}buildDefaultsListTab(){const e=document.createElement("div");e.innerText="Default Configurations",Object.assign(e.style,{fontSize:"16px",fontWeight:"bold",marginBottom:"12px"}),this.contentArea.appendChild(e);const t=this.handler?.defaultsManager;if(!t){const e=document.createElement("div");return e.innerText="No defaults manager found.",e.style.color="#ccc",void this.contentArea.appendChild(e)}const i=t.getAll(),o=Array.from(i.keys());if(0===o.length){const e=document.createElement("div");return e.innerText="No default configurations found.",e.style.color="#ccc",void this.contentArea.appendChild(e)}o.forEach((e=>{this.addButton(`Edit "${e}" Defaults`,(()=>{this.handler.ContextMenu.dataMenu&&"function"==typeof this.handler.ContextMenu.dataMenu.openDefaultOptions?this.handler.ContextMenu.dataMenu.openDefaultOptions(e):console.warn("No dataMenu or openDefaultOptions method found on handler.")}),{backgroundColor:"#444",borderRadius:"8px",marginBottom:"8px",display:"block"})}))}addColorPicker(e,t,i){const o=document.createElement("div");Object.assign(o.style,{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"8px",fontFamily:"sans-serif",fontSize:"14px"});const n=document.createElement("span");n.innerText=e,o.appendChild(n);const s=document.createElement("input");s.type="color",s.value=t,Object.assign(s.style,{border:"none",borderRadius:"8px",width:"32px",height:"32px",cursor:"pointer",padding:"2px"}),s.oninput=()=>i(s.value),o.appendChild(s),this.contentArea.appendChild(o)}addDropdown(e,t,i){const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.marginBottom="8px",o.style.justifyContent="space-between",o.style.marginBottom="8px";const n=document.createElement("span");n.innerText=e,o.appendChild(n);const s=document.createElement("select");s.style.backgroundColor="#444",s.style.color="#fff",s.style.border="1px solid #555",s.style.borderRadius="4px",s.style.outline="none",t.forEach((e=>{const t=document.createElement("option");t.value=e,t.innerText=e,s.appendChild(t)})),s.onchange=()=>i(s.value),o.appendChild(s),this.contentArea.appendChild(o)}addButton(e,t,i){const o=document.createElement("button");o.innerText=e,Object.assign(o.style,{padding:"8px 12px",margin:"4px 0",backgroundColor:"#008CBA",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontFamily:"sans-serif",fontSize:"14px"}),i&&Object.assign(o.style,i),o.onclick=t,this.contentArea.appendChild(o)}addNumberField(e,t,i){const o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",o.style.marginBottom="8px";const n=document.createElement("span");n.innerText=e,o.appendChild(n);const s=document.createElement("input");s.type="number",s.value=t.toString(),s.style.width="60px",s.style.backgroundColor="#444",s.style.color="#fff",s.style.border="1px solid #555",s.style.borderRadius="4px",s.oninput=()=>{const e=parseFloat(s.value);i(isNaN(e)?0:e)},o.appendChild(s),this.contentArea.appendChild(o)}addCheckbox(e,t,i){const o=document.createElement("label");o.style.display="flex",o.style.alignItems="center",o.style.marginBottom="8px";const n=document.createElement("input");n.type="checkbox",n.checked=t,n.style.marginRight="8px",n.onchange=()=>i(n.checked),o.appendChild(n);const s=document.createElement("span");s.innerText=e,o.appendChild(s),this.contentArea.appendChild(o)}getCurrentOptionValue(e){const t=e.split(".");let i=this.handler.chart.options();for(const o of t){if(!i||!(o in i))return console.warn(`Option path "${e}" is invalid.`),null;i=i[o]}return i}toggleBackgroundType(){const e=this.handler.chart.options().layout?.background;let i;i=e&&"solid"===e.type?{type:t.ColorType.VerticalGradient,topColor:"rgba(255,0,0,0.2)",bottomColor:"rgba(0,255,0,0.2)"}:{type:"solid",color:"#000000"},this.handler.chart.applyOptions({layout:{background:i}}),this.buildLayoutOptionsTab()}addTextInput(e,t,i){const o=document.createElement("div");Object.assign(o.style,{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:"8px",fontFamily:"sans-serif",fontSize:"14px"});const n=document.createElement("span");n.innerText=e,o.appendChild(n);const s=document.createElement("input");s.type="text",s.value=t,Object.assign(s.style,{width:"150px",padding:"4px",backgroundColor:"#444",color:"#fff",border:"1px solid #555",borderRadius:"4px"}),s.oninput=()=>i(s.value),o.appendChild(s),this.contentArea.appendChild(o)}}let Wt=null;class zt{handler;handlerMap;getMouseEventParams;div;hoverItem;items=[];colorPicker=new Je("#ff0000",(()=>null));saveDrawings=null;drawingTool=null;recentSeries=null;recentDrawing=null;SettingsModal=null;volumeProfile=null;dataMenu;constructor(e,t,i){this.handler=e,this.handlerMap=t,this.getMouseEventParams=i,this.div=document.createElement("div"),this.div.classList.add("context-menu"),document.body.appendChild(this.div),this.div.style.overflowY="scroll",this.hoverItem=null,document.body.addEventListener("contextmenu",this._onRightClick.bind(this)),document.body.addEventListener("click",this._onClick.bind(this)),this.dataMenu=new Ut({contextMenu:this,handler:this.handler}),this.SettingsModal=new Ht(this.handler),this.setupMenu()}constraints={baseline:{skip:!0},title:{skip:!0},PriceLineSource:{skip:!0},tickInterval:{min:0,max:100},lastPriceAnimation:{skip:!0},lineType:{min:0,max:2},lineStyle:{min:0,max:4},seriesType:{skip:!0},chandelierSize:{min:1},dynamicCandles:{skip:!0},volumeMALength:{skip:!0},volumeMultiplier:{skip:!0},volumeOpacityPeriod:{skip:!0}};setupDrawingTools(e,t){this.saveDrawings=e,this.drawingTool=t}shouldSkipOption(e){return!!(this.constraints[e]||{}).skip}separator(){const e=document.createElement("div");e.style.width="90%",e.style.height="1px",e.style.margin="3px 0px",e.style.backgroundColor=window.pane.borderColor,this.div.appendChild(e),this.items.push(e)}menuItem(e,t,i=null){const o=document.createElement("span");o.classList.add("context-menu-item"),this.div.appendChild(o);const n=document.createElement("span");if(n.innerText=e,n.style.pointerEvents="none",o.appendChild(n),i){let e=document.createElement("span");e.innerText="►",e.style.fontSize="8px",e.style.pointerEvents="none",o.appendChild(e)}if(o.addEventListener("mouseover",(()=>{this.hoverItem&&this.hoverItem.closeAction&&this.hoverItem.closeAction(),this.hoverItem={elem:n,action:t,closeAction:i}})),i){let e;o.addEventListener("mouseover",(()=>e=setTimeout((()=>t(o.getBoundingClientRect())),100))),o.addEventListener("mouseout",(()=>clearTimeout(e)))}else o.addEventListener("click",(e=>{t(e),this.div.style.display="none"}));this.items.push(o)}_onClick(e){const t=e.target;[this.colorPicker].forEach((e=>{e.getElement().contains(t)||e.closeMenu()}))}_onRightClick(e){e.preventDefault();const t=this.getMouseEventParams(),i=this.getProximitySeries(this.getMouseEventParams()),o=this.getProximityDrawing(),n=this.getProximityTrendTrace();console.log("Mouse Event Params:",t),console.log("Proximity Series:",i),console.log("Proximity Drawing:",o),this.clearMenu(),this.clearAllMenus(),i?(console.log("Right-click detected on a series (proximity)."),this.populateSeriesMenu(i,e),this.recentSeries=i):o?(console.log("Right-click detected on a drawing."),this.populateDrawingMenu(e,o),this.recentDrawing=o):n?(console.log("Right-click detected on a drawing."),this.populateTrendTraceMenu(e,n)):t?.hoveredSeries?(console.log("Right-click detected on a series (hovered)."),this.populateSeriesMenu(t.hoveredSeries,e),this.recentSeries=i):(console.log("Right-click detected on the chart background."),this.populateChartMenu(e)),this.showMenu(e),e.preventDefault(),e.stopPropagation()}getProximityDrawing(){return L.hoveredObject?L.hoveredObject:null}getProximityTrendTrace(){return ne.hoveredObject?ne.hoveredObject:null}getProximitySeries(e){if(!e||!e.seriesData)return console.warn("No mouse event parameters or series data available."),null;if(!e.point)return console.warn("No point data in MouseEventParams."),null;const t=e.point.y;let i=null;const o=this.handler._seriesList[0];if(this.handler.series)i=this.handler.series,console.log("Using handler.series for coordinate conversion.");else{if(!o)return console.warn("No handler.series or referenceSeries available."),null;i=o,console.log("Using referenceSeries for coordinate conversion.")}const n=i.coordinateToPrice(t);if(console.log(`Converted chart Y (${t}) to Price: ${n}`),null===n)return console.warn("Cursor price is null. Unable to determine proximity."),null;const s=[];return e.seriesData.forEach(((e,t)=>{let i;if(d(e)?i=e.value:p(e)&&(i=e.close),void 0!==i&&!isNaN(i)){const e=Math.abs(i-n);if(e/n*100<=3.33){const i=Z(t,this.handler.legend);s.push({distance:e,series:i})}}})),s.sort(((e,t)=>e.distance-t.distance)),s.length>0?(console.log("Closest series found."),s[0].series):(console.log("No series found within the proximity threshold."),null)}showMenu(e){const t=e.clientX,i=e.clientY;this.div.style.position="absolute",this.div.style.zIndex="10000",this.div.style.left=`${t}px`,this.div.style.top=`${i}px`,this.div.style.width="250px",this.div.style.maxHeight="400px",this.div.style.overflowY="auto",this.div.style.display="block",this.div.style.overflowX="hidden",console.log("Displaying Menu at:",t,i),Wt=this.div,console.log("Displaying Menu",t,i),document.addEventListener("mousedown",this.hideMenuOnOutsideClick.bind(this),{once:!0})}hideMenuOnOutsideClick(e){this.div.contains(e.target)||this.hideMenu()}hideMenu(){this.div.style.display="none",Wt===this.div&&(Wt=null)}clearAllMenus(){this.handlerMap.forEach((e=>{e.ContextMenu&&e.ContextMenu.clearMenu()}))}setupMenu(){if(!this.div.querySelector(".chart-options-container")){const e=document.createElement("div");e.classList.add("chart-options-container"),this.div.appendChild(e)}this.div.querySelector(".context-menu-item.close-menu")||this.addMenuItem("Close Menu",(()=>this.hideMenu()))}addNumberInput(e,t,i,o,n,s){return this.addMenuInput(this.div,{type:"number",label:e,value:t,onChange:i,min:o,max:n,step:s})}addCheckbox(e,t,i){return this.addMenuInput(this.div,{type:"boolean",label:e,value:t,onChange:i})}addSelectInput(e,t,i,o){return this.addMenuInput(this.div,{type:"select",label:e,value:t,onChange:o,options:i})}addMenuInput(e,t,i=""){const o=document.createElement("div");if(o.classList.add("context-menu-item"),o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-around",o.style.width="90%",t.label){const e=document.createElement("label");e.innerText=t.label,e.htmlFor=`${i}${t.label.toLowerCase()}`,e.style.flex="0.8",e.style.whiteSpace="nowrap",o.appendChild(e)}let n;switch(t.type){case"hybrid":{if(!t.hybridConfig)throw new Error("Hybrid type requires hybridConfig.");const e=document.createElement("div");e.classList.add("context-menu-item"),e.style.position="relative",e.style.cursor="pointer",e.style.display="flex",e.style.textAlign="center",e.style.marginLeft="auto",e.style.marginRight="8px";const i=document.createElement("span");i.innerText=t.sublabel??"Action",i.style.flex="1",e.appendChild(i);const o=document.createElement("span");o.innerText="▼",o.style.marginLeft="8px",o.style.color="#fff",e.appendChild(o);const s=document.createElement("div");s.style.position="absolute",s.style.backgroundColor="#2b2b2b",s.style.color="#fff",s.style.border="1px solid #444",s.style.borderRadius="4px",s.style.minWidth="100px",s.style.boxShadow="0px 2px 5px rgba(0, 0, 0, 0.5)",s.style.zIndex="10000",s.style.display="none",e.appendChild(s),t.hybridConfig.options.forEach((e=>{const t=document.createElement("div");t.innerText=e.name,t.style.cursor="pointer",t.style.padding="5px 10px",t.addEventListener("click",(t=>{t.stopPropagation(),s.style.display="none",e.action()})),t.addEventListener("mouseenter",(()=>{t.style.backgroundColor="#444"})),t.addEventListener("mouseleave",(()=>{t.style.backgroundColor="#2b2b2b"})),s.appendChild(t)})),e.addEventListener("click",(e=>{e.stopPropagation(),s.style.display="block"===s.style.display?"none":"block"}));const a=document.createElement("div");a.classList.add("context-menu-item"),a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.cursor="pointer",a.addEventListener("click",(()=>{t.hybridConfig.defaultAction()})),a.appendChild(e),document.addEventListener("click",(()=>{s.style.display="none"})),n=a;break}case"number":{const e=document.createElement("input");e.type="number",e.value=void 0!==t.value?t.value.toString():"",e.style.backgroundColor="#2b2b2b",e.style.color="#fff",e.style.border="1px solid #444",e.style.borderRadius="4px",e.style.textAlign="center",e.style.marginLeft="auto",e.style.marginRight="8px",e.style.width="40px",void 0!==t.min&&(e.min=t.min.toString()),void 0!==t.max&&(e.max=t.max.toString()),void 0===t.step||isNaN(t.step)?e.step="1":e.step=t.step.toString(),e.addEventListener("input",(e=>{const i=e.target;let o=parseFloat(i.value);isNaN(o)||t.onChange(o)})),n=e;break}case"boolean":{const e=document.createElement("input");e.type="checkbox",e.checked=t.value??!1,e.style.marginLeft="auto",e.style.marginRight="8px",e.addEventListener("change",(e=>{const i=e.target;t.onChange(i.checked)})),n=e;break}case"select":{const e=document.createElement("select");e.id=`${i}${t.label?t.label.toLowerCase():"select"}`,e.style.backgroundColor="#2b2b2b",e.style.color="#fff",e.style.border="1px solid #444",e.style.borderRadius="4px",e.style.marginLeft="auto",e.style.marginRight="8px",e.style.width="80px",t.options?.forEach((i=>{const o=document.createElement("option");o.value=i,o.text=i,o.style.whiteSpace="normal",o.style.textAlign="right",i===t.value&&(o.selected=!0),e.appendChild(o)})),e.addEventListener("change",(e=>{const i=e.target;t.onChange(i.value)})),n=e;break}case"string":{const e=document.createElement("input");e.type="text",e.value=t.value??"",e.style.backgroundColor="#2b2b2b",e.style.color="#fff",e.style.border="1px solid #444",e.style.borderRadius="4px",e.style.marginLeft="auto",e.style.textAlign="center",e.style.marginRight="8px",e.style.width="60px",e.addEventListener("input",(e=>{const i=e.target;t.onChange(i.value)})),n=e;break}case"color":{const e=document.createElement("input");e.type="color",e.value=t.value??"#000000",e.style.marginLeft="auto",e.style.cursor="pointer",e.style.marginRight="8px",e.style.width="100px",e.addEventListener("input",(e=>{const i=e.target;t.onChange(i.value)})),n=e;break}default:throw new Error("Unsupported input type")}return o.style.padding="2px 10px 2px 10px",o.appendChild(n),e.appendChild(o),o}addMenuItem(e,t,i=!0,o=!1,n=1){const s=document.createElement("span");if(s.classList.add("context-menu-item"),s.innerText=e,o){const e=document.createElement("span");e.classList.add("submenu-arrow"),e.innerText="ː".repeat(n),s.appendChild(e)}s.addEventListener("click",(e=>{e.stopPropagation(),t(),i&&this.hideMenu()}));const a=["➩","➯","➱","➬","➫"];return s.addEventListener("mouseenter",(()=>{if(s.style.backgroundColor="royalblue",s.style.color="white",!s.querySelector(".hover-arrow")){const e=document.createElement("span");e.classList.add("hover-arrow");const t=Math.floor(Math.random()*a.length),i=a[t];e.innerText=i,e.style.marginLeft="auto",e.style.fontSize="8px",e.style.color="white",s.appendChild(e)}})),s.addEventListener("mouseleave",(()=>{s.style.backgroundColor="",s.style.color="";const e=s.querySelector(".hover-arrow");e&&s.removeChild(e)})),this.div.appendChild(s),this.items.push(s),s}clearMenu(){this.div.querySelectorAll(".context-menu-item:not(.close-menu), .context-submenu").forEach((e=>e.remove())),this.items=[],this.div.innerHTML=""}addColorPickerMenuItem(e,t,i,o){const n=document.createElement("span");n.classList.add("context-menu-item"),n.innerText=e,this.div.appendChild(n);const s=e=>{const t=E(i,e);o.applyOptions(t),console.log(`Updated ${i} to ${e}`);if("object"==typeof(n=o)&&null!==n&&"function"==typeof n.applyOptions&&"function"==typeof n.dataByIndex&&["color","lineColor","upColor","downColor"].includes(i)){const t=this.handler.legend._lines.find((e=>e.series===o));t&&("downColor"===i?(t.colors[1]=e,console.log(`Legend down color updated to: ${e}`)):(t.colors[0]=e,console.log(`Legend up/main color updated to: ${e}`)))}var n};return n.addEventListener("click",(e=>{e.stopPropagation(),this.colorPicker||(this.colorPicker=new Je(t??"#000000",s)),this.colorPicker.openMenu(e,225,s)})),n}currentWidthOptions=[];currentStyleOptions=[];populateSeriesMenu(e,i){const o=Z(e,this.handler.legend),n=e.options();if(!n)return void console.warn("No options found for the selected series.");this.div.innerHTML="";const s=[],a=[],l=[],c=[],h=[];for(const e of Object.keys(n)){const i=n[e];if(this.shouldSkipOption(e))continue;if(e.toLowerCase().includes("base"))continue;const o=I(e).toLowerCase(),p=o.includes("width")||"radius"===o||o.includes("radius");if(o.includes("color"))"string"==typeof i?s.push({label:e,value:i}):console.warn(`Expected string value for color option "${e}".`);else if(p){if("number"==typeof i){let t=1,n=10,s=1;o.includes("radius")&&(t=0,n=1,s=.1),c.push({name:e,label:e,value:i,min:t,max:n,step:s})}}else if(o.includes("visible")||o.includes("visibility"))"boolean"==typeof i?a.push({label:e,value:i}):console.warn(`Expected boolean value for visibility option "${e}".`);else if("lineType"===e){const t=this.getPredefinedOptions(I(e));h.push({name:e,label:e,value:i,options:t})}else if("crosshairMarkerRadius"===e)"number"==typeof i?c.push({name:e,label:e,value:i,min:1,max:50}):console.warn(`Expected number value for crosshairMarkerRadius option "${e}".`);else if(o.includes("style")){if("string"==typeof i||Object.values(t.LineStyle).includes(i)||"number"==typeof i){const t=["Solid","Dotted","Dashed","Large Dashed","Sparse Dotted"];h.push({name:e,label:e,value:i,options:t})}}else if(o.includes("shape")){if(d=i,Object.values(r).includes(d)){const t=["Rectangle","Rounded","Ellipse","Arrow","3d","Polygon","Bar"];t&&h.push({name:e,label:e,value:i,options:t})}}else l.push({label:e,value:i})}var d;this.currentWidthOptions=c,this.currentStyleOptions=h,this.addTextInput("Title",e.options().title||"",(t=>{const i={title:t};this.handler.seriesMap.has(e.options().title)&&this.handler.seriesMap.delete(e.options().title),this.handler.seriesMap.set(t,e),console.log(`Updated seriesMap label to: ${t}`);const o=this.handler.legend._lines.find((t=>t.series===e));o&&o.series===e&&(o.name=t,console.log(`Updated legend title to: ${t}`)),e.applyOptions(i),console.log(`Updated title to: ${t}`)}));const p=e.getPane().paneIndex(),u=this.handler.chart.panes(),m=`Pane ${p}`,g=[];for(let t=0;t<u.length;t++)g.push({name:`Pane ${t}`,action:()=>{e.moveToPane(t),console.log(`Moved series to existing pane ${t}.`)}});if(g.push({name:"New Pane",action:()=>{e.moveToPane(u.length),console.log(`Moved series to a new pane at index ${u.length}.`)}}),this.addMenuInput(this.div,{type:"hybrid",label:"Move to pane",sublabel:m,value:m,onChange:e=>{const t=g.find((t=>t.name===e));t&&t.action()},hybridConfig:{defaultAction:()=>{0===p?u.length>1?(e.moveToPane(1),console.log(`Default: Moved series from pane ${p} to pane 1.`)):(e.moveToPane(u.length),console.log(`Default: Moved series from pane ${p} to a new pane at index ${u.length}.`)):(e.moveToPane(0),console.log(`Default: Moved series from pane ${p} back to main pane (0).`))},options:g.map((e=>({name:e.name,action:e.action})))}}),this.addMenuItem("Clone Series ▸",(()=>{this.populateCloneSeriesMenu(e,i)}),!1,!0),a.length>0&&this.addMenuItem("Visibility Options ▸",(()=>{this.populateVisibilityMenu(i,e)}),!1,!0),this.currentStyleOptions.length>0&&this.addMenuItem("Style Options ▸",(()=>{this.populateStyleMenu(i,e)}),!1,!0),this.currentWidthOptions.length>0&&this.addMenuItem("Width Options ▸",(()=>{this.populateWidthMenu(i,e)}),!1,!0),s.length>0&&this.addMenuItem("Color Options ▸",(()=>{this.populateColorOptionsMenu(s,e,i)}),!1,!0),n.enableVolumeOpacity&&this.addNumberInput("Volume Opacity Period",n.volumeOpacityPeriod??21,(t=>{const i={volumeOpacityPeriod:t};e.applyOptions(i),console.log(`Updated Volume Opacity Period to ${t}`)}),1,1e4,1),l.forEach((t=>{const i=I(t.label);if(!this.constraints[t.label]?.skip)if("boolean"==typeof t.value)this.addCheckbox(I(t.label),Boolean(t.value),(i=>{const o=E(t.label,i);e.applyOptions(o),console.log(`Updated ${t.label} to ${i}`)}));else if("string"==typeof t.value){const o=this.getPredefinedOptions(t.label);o&&o.length>0?this.addMenuItem(`${i} ▸`,(()=>{this.div.innerHTML="",this.addSelectInput(i,t.value,o,(i=>{const o=E(t.label,i);e.applyOptions(o),console.log(`Updated ${t.label} to ${i}`)}))}),!1,!0):this.addMenuItem(`${i} ▸`,(()=>{this.div.innerHTML="",this.addTextInput(i,t.value,(i=>{const o=E(t.label,i);e.applyOptions(o),console.log(`Updated ${t.label} to ${i}`)}))}),!1,!0)}else{if("number"!=typeof t.value)return;{const o=this.constraints[t.label]?.min,n=this.constraints[t.label]?.max;this.addNumberInput(i,t.value,(i=>{const o=E(t.label,i);e.applyOptions(o),console.log(`Updated ${t.label} to ${i}`)}),o,n)}}})),this.addMenuItem("Price Scale Options ▸",(()=>{this.populatePriceScaleMenu(i,e.options().priceScaleId??"right",e)}),!1,!0),this.addMenuItem("Primitives ▸",(()=>{this.populatePrimitivesMenu(o,i)}),!1,!0),this.addMenuItem("Indicators ▸",(()=>{this.populateIndicatorMenu(e,i)}),!1,!0),function(e){return void 0!==e.figures&&void 0!==e.sourceSeries&&void 0!==e.indicator}(e)){const t=e;this.addMenuItem(`Configure ${t.indicator.name}`,(()=>{this.configureIndicatorParams(t,i,t.figureCount)}),!1)}this.addMenuItem("Export/Import Series Data ▸",(()=>{this.dataMenu||(this.dataMenu=new Ut({contextMenu:this,handler:this.handler})),this.dataMenu.openMenu(e,i,"Series")}),!1),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(i)}),!1,!1),this.showMenu(i)}populateDrawingMenu(e,t){this.div.innerHTML="",this.drawingTool||(this.drawingTool=new de(this.handler.chart,this.handler._seriesList[0]));for(const e of Object.keys(t._options)){let t;if(e.toLowerCase().includes("color"))t=new qe(this.saveDrawings,e);else{if("lineStyle"!==e)continue;t=new Xe(this.saveDrawings)}const i=e=>t.openMenu(e);this.menuItem(I(e),i,(()=>{document.removeEventListener("click",t.closeMenu),t._div.style.display="none"}))}if("PitchFork"===t._type){const i=t._options.variant||"standard",o=["standard","schiff","modifiedSchiff","inside"];this.addSelectInput("Pitchfork Variant",i,o,(e=>{t._options.variant=e,this.saveDrawings&&this.saveDrawings()})),this.addNumberInput("Length",t._options.length,(e=>{t._options.length=e,this.saveDrawings&&this.saveDrawings()}),0,1e3,.1),this.addMenuItem("Fork Line Options ▸",(()=>{this.populateForkLineMainMenu(e,t)}),!1,!0),this.addMenuItem("Export/Import  PitchFork Data ▸",(()=>{this.dataMenu||(this.dataMenu=new Ut({contextMenu:this,handler:this.handler})),this.dataMenu.openMenu(t,e,"PitchFork")}),!1)}if(t.points?.length>=2&&t.points[0]&&t.points[1]){let i;i=(t.points,t),i.linkedObjects?.length&&i.linkedObjects.forEach((t=>{t instanceof ne?this.addMenuItem(`${t.title} Options`,(()=>{this.populateTrendTraceMenu(e,t)}),!1,!0):t instanceof Ke&&this.addMenuItem("Volume Profile Options",(()=>{this.populateVolumeProfileMenu(e,t)}),!1,!0)})),this.addMenuItem("Trend Trace ▸",(()=>{this._createTrendTrace(e,i)}),!1,!0),this.addMenuItem("Volume Profile ▸",(()=>{this._createVolumeProfile(i)}),!1,!0)}this.separator(),this.menuItem("Delete Drawing",(()=>this.drawingTool.delete(t))),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1,!1),this.showMenu(e)}populateChartMenu(e){this.div.innerHTML="",console.log("Displaying Menu Options: Chart"),this.addResetViewOption(),this.addMenuInput(this.div,{type:"hybrid",label:"Display Volume Profile",sublabel:"Settings",hybridConfig:{defaultAction:()=>{this.volumeProfile?(this.handler.series.detachPrimitive(this.volumeProfile),this.volumeProfile=null,console.log("[ChartMenu] Detached Volume Profile.")):(this.volumeProfile=new Ke(this.handler,Ye),this.handler.series.attachPrimitive(this.volumeProfile,"Visible Range Volume Profile",!1,!0),console.log("[ChartMenu] Attached Volume Profile."))},options:[{name:"Options",action:()=>{this.volumeProfile&&this.populateVolumeProfileMenu(e,this.volumeProfile)}}]}}),this.addMenuItem(" ~ Series List",(()=>{this.populateSeriesListMenu(e,!1,(t=>{this.populateSeriesMenu(t,e)}))}),!1,!0),this.addMenuItem("Settings...",(()=>{this.SettingsModal.open()}),!1),this.showMenu(e)}populateLayoutMenu(e){this.div.innerHTML="";const t="Text Color",i="layout.textColor",o=this.getCurrentOptionValue(i)||"#000000";this.addColorPickerMenuItem(I(t),o,i,this.handler.chart);const n=this.handler.chart.options().layout?.background;c(n)?this.addColorPickerMenuItem("Background Color",n.color||"#FFFFFF","layout.background.color",this.handler.chart):h(n)?(this.addColorPickerMenuItem("Top Color",n.topColor||"rgba(255,0,0,0.33)","layout.background.topColor",this.handler.chart),this.addColorPickerMenuItem("Bottom Color",n.bottomColor||"rgba(0,255,0,0.33)","layout.background.bottomColor",this.handler.chart)):console.warn("Unknown background type; no color options displayed."),this.addMenuItem("Switch Background Type",(()=>{this.toggleBackgroundType(e)}),!1,!0),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1,!1),this.showMenu(e)}toggleBackgroundType(e){const i=this.handler.chart.options().layout?.background;let o;o=c(i)?{type:t.ColorType.VerticalGradient,topColor:"rgba(255,0,0,0.2)",bottomColor:"rgba(0,255,0,0.2)"}:{type:t.ColorType.Solid,color:"#000000"},this.handler.chart.applyOptions({layout:{background:o}}),this.populateLayoutMenu(e)}populateWidthMenu(e,t){this.div.innerHTML="",this.currentWidthOptions.forEach((e=>{"number"==typeof e.value&&this.addNumberInput(I(e.label),e.value,(i=>{const o=E(e.name,i);t.applyOptions(o),console.log(`Updated ${e.label} to ${i}`)}),e.min,e.max)})),this.addMenuItem("⤝ Back to Series Options",(()=>{this.populateSeriesMenu(t,e)}),!1,!1),this.showMenu(e)}populatePrimitivesMenu(e,t){this.div.innerHTML="",console.log("Showing Primitive Menu ");const i=e.primitives;this.addMenuItem("Fill Area Between",(()=>{this.startFillAreaBetween(t,e)}),!1,!1),console.log("Primitives:",i);const o=i?.FillArea??i?.pt;i.FillArea&&this.addMenuItem("Customize Fill Area",(()=>{this.customizeFillAreaOptions(t,o)}),!1,!0),this.addMenuItem("Create TrendTrace",(()=>{this._createTrendTrace(t,this.recentDrawing)}),!1,!1),console.log("Primitives:",i),i.TrendTrace&&this.addMenuItem("Customize TrendTrace",(()=>{this.populateTrendTraceMenu(t,i.TrendTrace)}),!1,!0),this.addMenuItem("⤝ Back",(()=>{this.populateSeriesMenu(e,t)}),!1,!1),this.showMenu(t)}populateStyleMenu(e,t){this.div.innerHTML="",this.currentStyleOptions.forEach((e=>{const i=this.getPredefinedOptions(e.name);i?this.addSelectInput(I(e.name),e.value.toString(),i,(i=>{let o=i;if(e.name.toLowerCase().includes("style")){o={Solid:0,Dotted:1,Dashed:2,"Large Dashed":3,"Sparse Dotted":4}[i]??0}else if(e.name.toLowerCase().includes("linetype")){o={Simple:0,WithSteps:1,Curved:2}[i]??0}const n=E(e.name,o);if(t.applyOptions(n),console.log(`Updated ${e.name} to "${i}" =>`,o),e.name.toLowerCase().includes("style")&&"Line"===t.seriesType()){const e=o,i=(()=>{switch(e){case 0:return"―";case 1:return"··";case 2:return"--";case 3:return"- -";case 4:return"· ·";default:return"~"}})(),n=this.handler.legend._lines.find((e=>e.series===t));n&&(n.legendSymbol=[i],console.log(`Updated legend symbol for lineStyle(${e}) to: ${i}`))}})):console.warn(`No predefined options found for "${e.name}".`)})),this.addMenuItem("⤝ Back",(()=>{this.populateSeriesMenu(t,e)}),!1,!1),this.showMenu(e)}populateCloneSeriesMenu(e,t){this.div.innerHTML="";const i=e.data(),o=["Line","Histogram","Area"];if(i&&i.length>0){i.some((e=>p(e)))&&o.push("Bar","Candlestick","Ohlc")}o.forEach((t=>{this.addMenuItem(`Clone as ${t}`,(()=>{const i=function(e,t,i,o){try{const n={...X(i),...o};let s;switch(console.log(`Cloning ${e.seriesType()} as ${i}...`),i){case"Line":s=t.createLineSeries(i,n);break;case"Histogram":s=t.createHistogramSeries(i,n);break;case"Area":s=t.createAreaSeries(i,n);break;case"Bar":s=t.createBarSeries(i,n);break;case"Candlestick":s={name:o.name,series:t.createCandlestickSeries()};break;case"Ohlc":s=t.createCustomOHLCSeries(i,n);break;default:return console.error(`Unsupported series type: ${i}`),null}let a=e.data().map(((t,o)=>Y(e,i,o))).filter((e=>null!==e));return s.series.setData(a),e.applyOptions({visible:!1}),e.subscribeDataChanged((()=>{const t=e.data().map(((t,o)=>Y(e,i,o))).filter((e=>null!==e));s.series.setData(t),console.log(`Updated synced series of type ${i}`)})),s.series}catch(e){return console.error("Error cloning series:",e),null}}(e,this.handler,t,this.handler.defaultsManager.defaults.get(t.toLowerCase())||{});i?console.log(`Cloned series as ${t}:`,i):console.warn(`Failed to clone as ${t}.`)}),!1)})),this.addMenuItem("⤝ Series Options",(()=>{this.populateSeriesMenu(e,t)}),!1,!1),this.showMenu(t)}addTextInput(e,t,i){const o=document.createElement("div");o.classList.add("context-menu-item"),o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between";const n=document.createElement("label");n.innerText=e,n.htmlFor=`${e.toLowerCase()}-input`,n.style.marginRight="8px",n.style.flex="1",o.appendChild(n);const s=document.createElement("input");return s.type="text",s.value=t,s.id=`${e.toLowerCase()}-input`,s.style.flex="0 0 100px",s.style.marginLeft="auto",s.style.backgroundColor="#2b2b2b",s.style.color="#fff",s.style.border="1px solid #444",s.style.borderRadius="4px",s.style.cursor="pointer",s.addEventListener("input",(e=>{const t=e.target;i(t.value)})),o.appendChild(s),this.div.appendChild(o),o}populateColorOptionsMenu(e,t,i){this.div.innerHTML="",e.forEach((e=>{this.addColorPickerMenuItem(I(e.label),e.value,e.label,t)})),this.addMenuItem("⤝ Back to Series Options",(()=>{this.populateSeriesMenu(t,i)}),!1,!1),this.showMenu(i)}populateVisibilityMenu(e,t){this.div.innerHTML="";const i=t.options();["visible","crosshairMarkerVisible","priceLineVisible"].forEach((e=>{const o=i[e];"boolean"==typeof o&&this.addCheckbox(I(e),o,(i=>{const o=E(e,i);t.applyOptions(o),console.log(`Toggled ${e} to ${i}`)}))})),this.addMenuItem("⤝ Back to Series Options",(()=>{this.populateSeriesMenu(t,e)}),!1,!1),this.showMenu(e)}populateBackgroundTypeMenu(e){this.div.innerHTML="";[{text:"Solid",action:()=>this.setBackgroundType(e,t.ColorType.Solid)},{text:"Vertical Gradient",action:()=>this.setBackgroundType(e,t.ColorType.VerticalGradient)}].forEach((e=>{this.addMenuItem(e.text,e.action,!1,!1,1)})),this.addMenuItem("⤝ Chart Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}populateGradientBackgroundMenuInline(e,t){this.div.innerHTML="",this.addColorPickerMenuItem(I("Top Color"),t.topColor,"layout.background.topColor",this.handler.chart),this.addColorPickerMenuItem(I("Bottom Color"),t.bottomColor,"layout.background.bottomColor",this.handler.chart),this.addMenuItem("⤝ Background Type & Colors",(()=>{this.populateBackgroundTypeMenu(e)}),!1),this.showMenu(e)}populateGridMenu(e){this.div.innerHTML="";[{name:"Vertical Line Color",type:"color",valuePath:"grid.vertLines.color",defaultValue:"#D6DCDE"},{name:"Horizontal Line Color",type:"color",valuePath:"grid.horzLines.color",defaultValue:"#D6DCDE"},{name:"Vertical Line Style",type:"select",valuePath:"grid.vertLines.style",options:["Solid","Dashed","Dotted","LargeDashed"],defaultValue:"Solid"},{name:"Horizontal Line Style",type:"select",valuePath:"grid.horzLines.style",options:["Solid","Dashed","Dotted","LargeDashed"],defaultValue:"Solid"},{name:"Show Vertical Lines",type:"boolean",valuePath:"grid.vertLines.visible",defaultValue:!0},{name:"Show Horizontal Lines",type:"boolean",valuePath:"grid.horzLines.visible",defaultValue:!0}].forEach((e=>{const t=this.getCurrentOptionValue(e.valuePath)??e.defaultValue;"color"===e.type?this.addColorPickerMenuItem(I(e.name),t,e.valuePath,this.handler.chart):"select"===e.type?this.addSelectInput(I(e.name),t,e.options,(t=>{const i=e.options.indexOf(t),o=E(e.valuePath,i);this.handler.chart.applyOptions(o),console.log(`Updated ${e.name} to: ${t}`)})):"boolean"===e.type&&this.addCheckbox(I(e.name),t,(t=>{const i=E(e.valuePath,t);this.handler.chart.applyOptions(i),console.log(`Updated ${e.name} to: ${t}`)}))})),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}populateBackgroundMenu(e){this.div.innerHTML="",this.addMenuItem("Type & Colors",(()=>{this.populateBackgroundTypeMenu(e)}),!1,!0),this.addMenuItem("Options",(()=>{this.populateBackgroundOptionsMenu(e)}),!1,!0),this.addMenuItem("⤝ Layout Options",(()=>{this.populateLayoutMenu(e)}),!1),this.showMenu(e)}populateBackgroundOptionsMenu(e){this.div.innerHTML="";[{name:"Background Color",valuePath:"layout.background.color"},{name:"Background Top Color",valuePath:"layout.background.topColor"},{name:"Background Bottom Color",valuePath:"layout.background.bottomColor"}].forEach((e=>{const t=this.getCurrentOptionValue(e.valuePath)||"#FFFFFF";this.addColorPickerMenuItem(I(e.name),t,e.valuePath,this.handler.chart)})),this.addMenuItem("⤝ Background",(()=>{this.populateBackgroundMenu(e)}),!1),this.showMenu(e)}populateSolidBackgroundMenuInline(e,t){this.div.innerHTML="",this.addColorPickerMenuItem(I("Background Color"),t.color,"layout.background.color",this.handler.chart),this.addMenuItem("⤝ Type & Colors",(()=>{this.populateBackgroundTypeMenu(e)}),!1),this.showMenu(e)}populateCrosshairOptionsMenu(e){this.div.innerHTML="";[{name:"Line Color",valuePath:"crosshair.lineColor"},{name:"Vertical Line Color",valuePath:"crosshair.vertLine.color"},{name:"Horizontal Line Color",valuePath:"crosshair.horzLine.color"}].forEach((e=>{const t=this.getCurrentOptionValue(e.valuePath)||"#000000";this.addColorPickerMenuItem(I(e.name),t,e.valuePath,this.handler.chart)})),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}populateTimeScaleMenu(e){this.div.innerHTML="";[{name:"Right Offset",type:"number",valuePath:"timeScale.rightOffset",min:0,max:100},{name:"Bar Spacing",type:"number",valuePath:"timeScale.barSpacing",min:1,max:100},{name:"Min Bar Spacing",type:"number",valuePath:"timeScale.minBarSpacing",min:.1,max:10,step:.1},{name:"Fix Left Edge",type:"boolean",valuePath:"timeScale.fixLeftEdge"},{name:"Fix Right Edge",type:"boolean",valuePath:"timeScale.fixRightEdge"},{name:"Lock Visible Range on Resize",type:"boolean",valuePath:"timeScale.lockVisibleTimeRangeOnResize"},{name:"Visible",type:"boolean",valuePath:"timeScale.visible"},{name:"Border Visible",type:"boolean",valuePath:"timeScale.borderVisible"},{name:"Border Color",type:"color",valuePath:"timeScale.borderColor"}].forEach((e=>{if("number"===e.type){const t=this.getCurrentOptionValue(e.valuePath);this.addNumberInput(I(e.name),t,(t=>{const i=E(e.valuePath,t);this.handler.chart.applyOptions(i),console.log(`Updated TimeScale ${e.name} to: ${t}`)}),e.min,e.max)}else if("boolean"===e.type){const t=this.getCurrentOptionValue(e.valuePath);this.addCheckbox(I(e.name),t,(t=>{const i=E(e.valuePath,t);this.handler.chart.applyOptions(i),console.log(`Updated TimeScale ${e.name} to: ${t}`)}))}else if("color"===e.type){const t=this.getCurrentOptionValue(e.valuePath)||"#000000";this.addColorPickerMenuItem(I(e.name),t,e.valuePath,this.handler.chart)}})),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}populatePriceScaleMenu(e,i="right",o){if(this.div.innerHTML="",o)this.addMenuInput(this.div,{type:"hybrid",label:"Price Scale",value:o.options().priceScaleId||"",onChange:e=>{o.applyOptions({priceScaleId:e}),console.log(`Updated price scale to: ${e}`)},hybridConfig:{defaultAction:()=>{const e="left"===o.options().priceScaleId?"right":"left";o.applyOptions({priceScaleId:e}),console.log(`Series price scale switched to: ${e}`)},options:[{name:"Left",action:()=>o.applyOptions({priceScaleId:"left"})},{name:"Right",action:()=>o.applyOptions({priceScaleId:"right"})},{name:"Volume",action:()=>o.applyOptions({priceScaleId:"volume_scale"})},{name:"Custom",action:()=>{const e=document.createElement("div"),t=document.createElement("input");t.type="text",t.placeholder="Enter custom scale ID",t.value=o.options().priceScaleId||"",t.addEventListener("change",(()=>{o.applyOptions({priceScaleId:t.value}),console.log(`Custom scale ID set to: ${t.value}`)})),e.appendChild(t),this.div.appendChild(e)}}]}});else{const n=this.handler.chart.priceScale(i).options().mode??t.PriceScaleMode.Normal,s=[{label:"Normal",value:t.PriceScaleMode.Normal},{label:"Logarithmic",value:t.PriceScaleMode.Logarithmic},{label:"Percentage",value:t.PriceScaleMode.Percentage},{label:"Indexed To 100",value:t.PriceScaleMode.IndexedTo100}],a=s.map((e=>e.label));this.addSelectInput("Price Scale Mode",s.find((e=>e.value===n))?.label||"Normal",a,(t=>{const n=s.find((e=>e.label===t));n&&(this.applyPriceScaleOptions(i,{mode:n.value}),console.log(`Price scale (${i}) mode set to: ${t}`),this.populatePriceScaleMenu(e,i,o))}));const r=this.handler.chart.priceScale(i).options();[{name:"Auto Scale",value:r.autoScale??!0,action:e=>{this.applyPriceScaleOptions(i,{autoScale:e}),console.log(`Price scale (${i}) autoScale set to: ${e}`)}},{name:"Invert Scale",value:r.invertScale??!1,action:e=>{this.applyPriceScaleOptions(i,{invertScale:e}),console.log(`Price scale (${i}) invertScale set to: ${e}`)}},{name:"Align Labels",value:r.alignLabels??!0,action:e=>{this.applyPriceScaleOptions(i,{alignLabels:e}),console.log(`Price scale (${i}) alignLabels set to: ${e}`)}},{name:"Border Visible",value:r.borderVisible??!0,action:e=>{this.applyPriceScaleOptions(i,{borderVisible:e}),console.log(`Price scale (${i}) borderVisible set to: ${e}`)}},{name:"Ticks Visible",value:r.ticksVisible??!1,action:e=>{this.applyPriceScaleOptions(i,{ticksVisible:e}),console.log(`Price scale (${i}) ticksVisible set to: ${e}`)}}].forEach((t=>{this.addMenuItem(`${t.name}: ${t.value?"On":"Off"}`,(()=>{const n=!t.value;t.action(n),this.populatePriceScaleMenu(e,i,o)}),!1,!1)}))}this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}applyPriceScaleOptions(e,t){const i=this.handler.chart.priceScale(e);i?(i.applyOptions(t),console.log(`Applied options to price scale "${e}":`,t)):console.warn(`Price scale with ID "${e}" not found.`)}getCurrentOptionValue(e){const t=e.split(".");let i=this.handler.chart.options();for(const o of t){if(!i||!(o in i))return console.warn(`Option path "${e}" is invalid.`),null;i=i[o]}return i}setBackgroundType(e,i){const o=this.handler.chart.options().layout?.background;let n;if(i===t.ColorType.Solid)n=c(o)?{type:t.ColorType.Solid,color:o.color}:{type:t.ColorType.Solid,color:"#000000"};else{if(i!==t.ColorType.VerticalGradient)return void console.error(`Unsupported ColorType: ${i}`);n=h(o)?{type:t.ColorType.VerticalGradient,topColor:o.topColor,bottomColor:o.bottomColor}:{type:t.ColorType.VerticalGradient,topColor:"rgba(255,0,0,.2)",bottomColor:"rgba(0,255,0,.2)"}}this.handler.chart.applyOptions({layout:{background:n}}),i===t.ColorType.Solid?this.populateSolidBackgroundMenuInline(e,n):i===t.ColorType.VerticalGradient&&this.populateGradientBackgroundMenuInline(e,n)}startFillAreaBetween(e,t){console.log("Fill Area Between started. Origin series set:",t.options().title),this.populateSeriesListMenu(e,!1,(e=>{e&&e!==t?(console.log("Destination series selected:",e.options().title),t.primitives.FillArea=new y(t,e,{...v}),t.attachPrimitive(t.primitives.FillArea,`Fill Area ⥵ ${e.options().title}`,!1,!0),console.log("Fill Area successfully added between selected series."),alert(`Fill Area added between ${t.options().title} and ${e.options().title}`)):alert("Invalid selection. Please choose a different series as the destination.")}))}getPredefinedOptions(e){return{"Series Type":["Line","Histogram","Area","Bar","Candlestick"],"Line Style":["Solid","Dotted","Dashed","Large Dashed","Sparse Dotted"],"Line Type":["Simple","WithSteps","Curved"],seriesType:["Line","Histogram","Area","Bar","Candlestick"],lineStyle:["Solid","Dotted","Dashed","Large Dashed","Sparse Dotted"],"Price Line Style":["Solid","Dotted","Dashed","Large Dashed","Sparse Dotted"],lineType:["Simple","WithSteps","Curved"],Shape:["Rectangle","Rounded","Ellipse","Arrow","3d","Polygon","Bar"],"Candle Shape":["Rectangle","Rounded","Ellipse","Arrow","3d","Polygon","Bar"]}[I(e)]||null}populateSeriesListMenu(e,t,i){this.div.innerHTML="";let o=[...Array.from(this.handler.seriesMap.entries()).map((([e,t])=>({label:e,value:t})))];if(this.handler.volumeSeries){o=[{label:"Volume",value:this.handler.volumeSeries},...o]}console.log(o),o.forEach((o=>{this.addMenuItem(o.label,(()=>{i(o.value),t?this.hideMenu():(this.div.innerHTML="",this.populateSeriesMenu(o.value,e),this.showMenu(e))}),!1,!0)})),this.addMenuItem("Cancel",(()=>{console.log("Operation canceled."),this.hideMenu()})),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}customizeFillAreaOptions(e,t){var i;this.div.innerHTML="",null!==(i=t).options.originColor&&null!==i.options.destinationColor&&(this.addColorPickerMenuItem("Origin > Destination",t.options.originColor,"originColor",t),this.addColorPickerMenuItem("Origin < Destination",t.options.destinationColor,"destinationColor",t)),this.addMenuItem("⤝ Back to Main Menu",(()=>this.populateChartMenu(e)),!1),this.showMenu(e)}addResetViewOption(){const e=this.addMenuInput(this.div,{type:"hybrid",label:"∟ Reset",sublabel:"Axis",hybridConfig:{defaultAction:()=>{this.handler.chart.timeScale().resetTimeScale(),this.handler.chart.timeScale().fitContent()},options:[{name:"⥗ Time Scale",action:()=>this.handler.chart.timeScale().resetTimeScale()},{name:"⥘ Price Scale",action:()=>this.handler.chart.timeScale().fitContent()}]}});this.div.appendChild(e)}_createTrendTrace(e,t){this.populateSeriesListMenu(e,!1,(e=>{let i;if("PitchFork"===t._type&&e&&t.p1&&t.p2){console.log("Series selected:",e.options().title);i=(t._options.length??1)*Math.abs(t.p2.logical-t.p1.logical)}e&&t.p1&&t.p2&&(console.log("Series selected:",e.options().title),e.primitives.TrendTrace=new ne(this.handler,e,t.p1,t.p2,ie,i),e.attachPrimitive(e.primitives.TrendTrace,`${t.p1?.logical} ⥵ ${t.p2?.logical}`,!1,!0),console.log("Trend Trace successfully created for selected series."),t.linkedObjects.push(e.primitives.TrendTrace))}))}_createVolumeProfile(e){const t=this.handler.series??this.handler._seriesList[0];if(t&&e.p1&&e.p2){console.log("Series selected:",t.options().title);const i=new Ke(this.handler,Ye,e.p1,e.p2);t.attachPrimitive(i,"Volume Profile",!1,!0),console.log("Volume Profile successfully created for selected series."),e.linkedObjects.push(i)}}populateTrendTraceMenu(e,t){this.div.innerHTML="",this.addMenuItem("Color Options ▸",(()=>this.populateTrendColorMenu(e,t)),!1,!0),this.addMenuItem("General Options ▸",(()=>this.populateTrendOptionsMenu(e,t)),!1,!0),this.addMenuItem("Export/Import Data ▸",(()=>{this.dataMenu||(this.dataMenu=new Ut({contextMenu:this,handler:this.handler})),this.dataMenu.openMenu(t,e,"Trend Trace")}),!1),this.addMenuItem("⤝ Main Menu",(()=>this.populateChartMenu(e)),!1),this.showMenu(e)}populateTrendColorMenu(e,t){this.div.innerHTML="";const i=t.getOptions(),o=[];t._sequence.data.every((e=>void 0!==e.open&&void 0!==e.high&&void 0!==e.low&&void 0!==e.close))?o.push({name:"Up Color",type:"color",valuePath:"upColor",defaultValue:i.upColor??"rgba(0,255,0,.25)"},{name:"Down Color",type:"color",valuePath:"downColor",defaultValue:i.downColor??"rgba(255,0,0,.25)"},{name:"Border Up Color",type:"color",valuePath:"borderUpColor",defaultValue:i.borderUpColor??"#1c9d1c"},{name:"Border Down Color",type:"color",valuePath:"borderDownColor",defaultValue:i.borderDownColor??"#d5160c"},{name:"Wick Up Color",type:"color",valuePath:"wickUpColor",defaultValue:i.wickUpColor??"#1c9d1c"},{name:"Wick Down Color",type:"color",valuePath:"wickDownColor",defaultValue:i.wickDownColor??"#d5160c"}):o.push({name:"Line Color",type:"color",valuePath:"lineColor",defaultValue:i.lineColor??"#ffffff"}),o.forEach((e=>{this.addColorPickerMenuItem(I(e.name),e.defaultValue,e.valuePath,t)})),this.addMenuItem("⤝ Trend Trace Menu",(()=>this.populateTrendTraceMenu(e,t)),!1),this.showMenu(e)}populateTrendOptionsMenu(e,t){this.div.innerHTML="";const i=t.getOptions(),o=[];t._sequence.data.every((e=>void 0!==e.open&&void 0!==e.high&&void 0!==e.low&&void 0!==e.close))&&o.push({name:"Bar Spacing",type:"number",valuePath:"barSpacing",defaultValue:i.barSpacing??.8,min:.1,max:10,step:.1},{name:"Radius",type:"number",valuePath:"radius",defaultValue:i.radius??.6,min:0,max:1,step:.1},{name:"Shape",type:"select",valuePath:"shape",defaultValue:i.shape??"Rounded",options:[{label:"Rectangle",value:r.Rectangle},{label:"Rounded",value:r.Rounded},{label:"Ellipse",value:r.Ellipse},{label:"Arrow",value:r.Arrow},{label:"Polygon",value:r.Polygon},{label:"Bar",value:r.Bar}]},{name:"Show Wicks",type:"boolean",valuePath:"wickVisible",defaultValue:i.wickVisible??!0},{name:"Show Borders",type:"boolean",valuePath:"borderVisible",defaultValue:i.borderVisible??!0},{name:"Chandelier Size",type:"number",valuePath:"chandelierSize",defaultValue:i.chandelierSize??1,min:1,max:100,step:1},{name:"Auto Aggregate",type:"boolean",valuePath:"autoscale",defaultValue:i.autoScale??!0}),o.push({name:"Line Style",type:"select",valuePath:"lineStyle",defaultValue:i.lineStyle??0,options:[{label:"Solid",value:0},{label:"Dotted",value:1},{label:"Dashed",value:2},{label:"Large Dashed",value:3},{label:"Sparse Dotted",value:4}]}),o.push({name:"Line Width",type:"number",valuePath:"lineWidth",defaultValue:i.lineWidth??1,min:.5,max:10,step:.5}),o.push({name:"Visible",type:"boolean",valuePath:"visible",defaultValue:i.visible??!0}),o.forEach((e=>{if("number"===e.type)this.addNumberInput(I(e.name),e.defaultValue,(i=>{const o=E(e.valuePath,i);t.applyOptions(o),console.log(`Updated ${e.name} to: ${i}`)}),e.min,e.max,e.step);else if("boolean"===e.type)this.addCheckbox(I(e.name),e.defaultValue,(i=>{const o=E(e.valuePath,i);t.applyOptions(o),console.log(`Updated ${e.name} to: ${i}`)}));else if("select"===e.type){const i=Array.isArray(e.options)&&"object"==typeof e.options[0]?e.options.map((e=>e.label)):e.options;this.addSelectInput(I(e.name),e.defaultValue,i,(i=>{const o=e.options.find((e=>e.label===i));if(o){const i=E(e.valuePath,o.value);t.applyOptions(i),console.log(`Updated ${e.name} to: ${o.value}`)}}))}})),this.addMenuItem("⤝ Trend Trace Menu",(()=>this.populateTrendTraceMenu(e,t)),!1),this.showMenu(e)}populateVolumeProfileMenu(e,t){this.div.innerHTML="";const i=t._options,o=[];o.push({name:"Visible",type:"boolean",valuePath:"visible",defaultValue:i.visible??!0},{name:"Sections",type:"number",valuePath:"sections",defaultValue:i.sections??20,min:1,step:1},{name:"Right Side",type:"boolean",valuePath:"rightSide",defaultValue:i.rightSide??!0},{name:"Width",type:"number",valuePath:"width",defaultValue:i.width??30,min:1,step:1},{name:"Line Style",type:"select",valuePath:"lineStyle",defaultValue:i.lineStyle??0,options:[{label:"Solid",value:0},{label:"Dotted",value:1},{label:"Dashed",value:2},{label:"Large Dashed",value:3},{label:"Sparse Dotted",value:4}]},{name:"Draw Grid",type:"boolean",valuePath:"drawGrid",defaultValue:i.drawGrid??!0},{name:"Grid Width",type:"number",valuePath:"gridWidth",defaultValue:i.gridWidth??void 0,min:1,step:1},{name:"Grid Line Style",type:"select",valuePath:"gridLineStyle",defaultValue:i.gridLineStyle??4,options:[{label:"Solid",value:0},{label:"Dotted",value:1},{label:"Dashed",value:2},{label:"Large Dashed",value:3},{label:"Sparse Dotted",value:4}]}),o.push({name:"Up Color",type:"color",valuePath:"upColor",defaultValue:i.upColor??Ye.upColor},{name:"Down Color",type:"color",valuePath:"downColor",defaultValue:i.downColor??Ye.downColor},{name:"Border Up Color",type:"color",valuePath:"borderUpColor",defaultValue:i.borderUpColor??Ye.borderUpColor},{name:"Border Down Color",type:"color",valuePath:"borderDownColor",defaultValue:i.borderDownColor??Ye.borderDownColor},{name:"Grid Color",type:"color",valuePath:"gridColor",defaultValue:i.gridColor??Ye.gridColor}),o.forEach((e=>{if("number"===e.type)this.addNumberInput(I(e.name),e.defaultValue,(i=>{const o=E(e.valuePath,i);t.applyOptions(o),console.log(`Updated ${e.name} to: ${i}`)}),e.min,e.max,e.step);else if("boolean"===e.type)this.addCheckbox(I(e.name),e.defaultValue,(i=>{const o=E(e.valuePath,i);t.applyOptions(o),console.log(`Updated ${e.name} to: ${i}`)}));else if("select"===e.type){const i=Array.isArray(e.options)&&"object"==typeof e.options[0]?e.options.map((e=>e.label)):e.options;this.addSelectInput(I(e.name),e.defaultValue,i,(i=>{const o=e.options.find((e=>e.label===i));if(o){const i=E(e.valuePath,o.value);t.applyOptions(i),console.log(`Updated ${e.name} to: ${o.value}`)}}))}else"color"===e.type&&this.addColorPickerMenuItem(I(e.name),e.defaultValue,e.valuePath,t)})),this.addMenuItem("⤝ Main Menu",(()=>{this.populateChartMenu(e)}),!1),this.showMenu(e)}indicatorSeriesMap=new Map;populateIndicatorMenu(e,t){this.div.innerHTML="",Ft.forEach((i=>{this.addMenuItem(`${i.name} (${i.shortName})`,(()=>{i.paramMap?this.configureIndicatorParams({series:e,indicator:i},t,1,!0):this.applyIndicator(e,i,{},1)}),!1)})),this.addMenuItem("⤝ Back",(()=>{this.hideMenu()}),!1),this.showMenu(t)}configureIndicatorParams(e,t,i,o=!1){let n;this.div.innerHTML="";const s="sourceSeries"in e?e:e.series,a=e.indicator,r="paramMap"in e?e.paramMap:{},l={};let c=!1,h=0;Object.entries(a.paramMap).forEach((([e,t])=>{if("numberArray"===t.type||"selectArray"===t.type||"booleanArray"===t.type||"stringArray"===t.type){c=!0;const e=Array.isArray(t.defaultValue)?t.defaultValue:[t.defaultValue];h=Math.max(h,e.length)}})),c&&o&&(void 0!==i?(n=i,e.figureCount=i):n="figureCount"in e&&void 0!==e.figureCount?e.figureCount:h||1,this.addNumberInput("Number of Figures",n,(i=>{e.figureCount=i,this.configureIndicatorParams(e,t,i,!0)}),1,10,1)),Object.entries(a.paramMap).forEach((([t,o])=>{const n=t,s=void 0!==r[t]?r[t]:o.defaultValue;if("numberArray"===o.type||"selectArray"===o.type||"booleanArray"===o.type||"stringArray"===o.type){const a=i??e.figureCount,r=o.type.replace("Array","");l[t]=[];for(let e=0;e<a;e++){let i;i=Array.isArray(s)?e<s.length?s[e]:s[s.length-1]:s,"number"===r?this.addNumberInput(`${n} ${e+1}`,i,(i=>{l[t]||(l[t]=[]),l[t][e]=i}),o.min,o.max,o.step):"boolean"===r?this.addCheckbox(`${n} ${e+1}`,Boolean(i),(i=>{l[t]||(l[t]=[]),l[t][e]=i})):"select"===r?this.addSelectInput(`${n} ${e+1}`,String(i),o.options||[],(i=>{l[t]||(l[t]=[]),l[t][e]=i})):"string"===r&&this.addMenuInput(this.div,{type:"string",label:`${n} ${e+1}`,value:i,onChange:i=>{l[t]||(l[t]=[]),l[t][e]=i}}),l[t]||(l[t]=[]),l[t][e]=i}}else"number"===o.type?(this.addNumberInput(n,s,(e=>{l[t]=e}),o.min,o.max,o.step),l[t]=s):"boolean"===o.type?(this.addCheckbox(n,Boolean(s),(e=>{l[t]=e})),l[t]=s):"select"===o.type?(this.addSelectInput(n,String(s),o.options||[],(e=>{l[t]=e})),l[t]=s):(this.addMenuInput(this.div,{type:"string",label:n,value:s,onChange:e=>{l[t]=e}}),l[t]=s)})),this.addMenuItem("Apply",(()=>{this.hideMenu(),Object.entries(l).forEach((([e,t])=>{a.paramMap[e]&&(a.paramMap[e].defaultValue=t)})),"recalculate"in e?(e.recalculate(l),e.figures.forEach((e=>{const t=this.handler.legend._lines.find((t=>t.series===e));t&&(this.handler.seriesMap.set(e.options().title,s),t.name=e.options().title)}))):this.applyIndicator(s,a,l,n)}),!1),this.addMenuItem("Cancel",(()=>{this.hideMenu()}),!1),this.showMenu(t)}applyIndicator(e,t,i,o){const n=[...e.data()];if(!n||0===n.length)return void console.warn("No data found on this series.");let s;s=n.every(p)?n:n.map(ee);const a=this.handler.volumeSeries.data(),r=t.calc([...s],i,a??void 0),l=new Map,c=function(e){const t={"#ff0000":["#ff0000","#f20000","#e60000","#d90000","#cc0000","#bf0000","#b30000","#a60000","#990000","#8c0000"],"#ff8700":["#ff8700","#f28000","#e67a00","#d97300","#cc6c00","#bf6500","#b35f00","#a65800","#995100","#8c4a00"],"#ffd300":["#ffd300","#fcca00","#e6c000","#d9b600","#ccb000","#bfaa00","#b3a000","#a69a00","#999000","#8c8600"],"#a1ff0a":["#a1ff0a","#97f207","#8ded04","#83e701","#79db00","#6fd200","#65c900","#5bc000","#51b700","#47ae00"],"#117a03":["#117a03","#107203","#0e6c03","#0c6603","#0a6003","#085a03","#065403","#044e03","#024803","#004203"],"#580aff":["#580aff","#5109f2","#4a08e6","#4307da","#3c06ce","#3505c2","#2e04b6","#2703aa","#2002a0","#190196"],"#be0aff":["#be0aff","#b308f2","#aa07e6","#a005da","#9704ce","#8e03c2","#8502b6","#7c01aa","#7300a0","#6a0096"]},i=Object.keys(t),o=t[i[Math.floor(Math.random()*i.length)]];if(e===o.length)return o;const n=[];for(let t=0;t<e;t++){const i=1===e?0:Math.round(t*(o.length-1)/(e-1));n.push(o[i])}return n}(r.length);r.forEach(((n,s)=>{const a=c[s];let h=null;if("histogram"===n.type){const i=this.handler.createHistogramSeries(n.title,{color:a,base:0,title:n.title,...r.length>1?{group:t.name}:{}});i.series&&(i.series.setData(n.data),h=i.series,e.getPane().paneIndex()!==h.getPane().paneIndex()&&h.moveToPane(e.getPane().paneIndex()))}else{const i=this.handler.createLineSeries(n.title,{color:a,lineWidth:2,title:n.title,...r.length>1?{group:t.name}:{}});i.series&&(i.series.setData(n.data),h=i.series,e.getPane().paneIndex()!==h.getPane().paneIndex()&&h.moveToPane(e.getPane().paneIndex()))}if(h){const s=function(e,t,i,o,n,s,a){const r=Object.assign(e,{sourceSeries:t,indicator:i,figures:o,paramMap:s,figureCount:n,recalculate:function(e){a(this,e)}});return"function"==typeof t.subscribeDataChanged&&t.subscribeDataChanged((()=>{t.data()[t.data().length-1].time>e.data()[e.data().length-1].time&&a(r)})),r}(h,e,t,l,o,i,Q);if(l.set(n.key,s),n.pane&&s.getPane()===e.getPane()){const e=s.getPane().paneIndex();s.moveToPane(e+n.pane)}}})),this.indicatorSeriesMap.set(t.name,l)}populateForkLineMainMenu(e,i){if(this.div.innerHTML="","PitchFork"!==i._type)return;const o=i._options;o.forkLines||(o.forkLines=[]);const n=o.forkLines;n.forEach(((t,o)=>{this.addMenuItem(`Fork Line ${o+1}`,(()=>{this.populateForkLineOptions(e,i,o)}),!1,!0)})),this.addMenuItem("Add Fork Line",(()=>{const o={value:.5,width:1,style:t.LineStyle.Solid,color:"#ffffff",fillColor:void 0};n.push(o),this.saveDrawings&&this.saveDrawings(),this.populateForkLineMainMenu(e,i)}),!1,!0),this.addMenuItem("⤝ Back",(()=>{this.populateDrawingMenu(e,i)}),!1,!1),this.showMenu(e)}populateForkLineOptions(e,i,o){this.div.innerHTML="";const n=i._options;if(!n.forkLines||!n.forkLines[o])return;const s=n.forkLines[o];this.addNumberInput("Value",s.value,(e=>{s.value=e,this.saveDrawings&&this.saveDrawings()}),0,10,.1),this.addNumberInput("Width",s.width,(e=>{s.width=e,this.saveDrawings&&this.saveDrawings()}),1,10,1);const a=[{name:"Solid",var:t.LineStyle.Solid},{name:"Dotted",var:t.LineStyle.Dotted},{name:"Dashed",var:t.LineStyle.Dashed},{name:"Large Dashed",var:t.LineStyle.LargeDashed},{name:"Sparse Dotted",var:t.LineStyle.SparseDotted}];this.addSelectInput("Style",a.find((e=>e.var===s.style))?.name||a[0].name,a.map((e=>e.name)),(e=>{const t=a.find((t=>t.name===e));t&&(s.style=t.var,this.saveDrawings&&this.saveDrawings())})),this.addForkLineColorPickerMenuItem("Color",s.color,s,"color"),this.addForkLineColorPickerMenuItem("Fill Color",s.fillColor||"",s,"fillColor"),this.addMenuItem("Remove Fork Line",(()=>{n.forkLines.splice(o,1),this.saveDrawings&&this.saveDrawings(),this.populateForkLineMainMenu(e,i)}),!1,!0),this.addMenuItem("⤝ Back",(()=>{this.populateForkLineMainMenu(e,i)}),!1,!1),this.showMenu(e)}addForkLineColorPickerMenuItem(e,t,i,o){const n=document.createElement("span");n.classList.add("context-menu-item"),n.innerText=e,this.div.appendChild(n);const s=e=>{i[o]=e,console.log(`Updated fork line ${o} to ${e}`),this.saveDrawings&&this.saveDrawings()};return n.addEventListener("click",(e=>{e.stopPropagation(),this.colorPicker||(this.colorPicker=new Je(t??"#000000",s)),this.colorPicker.openMenu(e,225,s)})),n}}function jt(e){return function(e){return Math.max(1,Math.floor(e))}(e)/e}class qt{_options;constructor(e){this._options=e}staticAggregate(e,t){const i=this._options?.chandelierSize??1,o=[];for(let n=0;n<e.length;n+=i){const s=e.slice(n,n+i),a=s.length<i&&n+s.length===e.length;if(0===s.length){console.warn("Empty bucket encountered during aggregation.");continue}const r=this._chandelier(s,n,n+s.length-1,t,a);o.push(r)}if(this._options?.enableVolumeOpacity){if(o.every((e=>void 0!==e.volume&&"number"==typeof e.volume))){const e=(this._options.volumeOpacityPeriod??20)*i;o.forEach(((t,i,o)=>{if(null==t.volume)return;const s=Math.max(0,i-e+1),a=o.slice(s,i+1).reduce(((e,t)=>void 0!==t.volume&&t.volume>e?t.volume:e),0),r=(a>0?t.volume/a:1)*(this._options?.maxOpacity??.3);t.isUp?t.color=n(this._options?.upColor||"rgba(0,255,0,0.333)",r):t.color=n(this._options?.downColor||"rgba(255,0,0,0.333)",r)}))}else console.warn("Volume opacity enabled but not all aggregated bars have volume data. Skipping volume-based opacity adjustment.")}return o}dynamicAggregate(e,t){if(0===e.length||"function"!=typeof this._options?.dynamicTrigger||!this._options?.dynamicCandles)return[];const i=[];let o=[];for(let n=0;n<e.length;n++){const s=e[n];o.push(s);if(this._options.dynamicTrigger().newBar||e[n].newBar){const s=n-o.length+1,a=n,r=this._chandelier(o,s,a,t,!1);i.push(r),console.log(`Aggregated candle from index ${s} to ${a} (Trigger: ${this._options.dynamicTrigger().newBar??e[n].newBar})`),o=[]}}return i}_chandelier(e,t,i,o,s=!1){if(0===e.length)throw new Error("Bucket cannot be empty in _chandelier method.");const a=e[0].originalData?.open??e[0].open??0,c=e[e.length-1].originalData?.close??e[e.length-1].close??0,h=o(a)??0,d=o(c)??0,p=e.map((e=>e.originalData?.high??e.high)),u=e.map((e=>e.originalData?.low??e.low)),m=p.length>0?Math.max(...p):0,g=u.length>0?Math.min(...u):0,y=o(m)??0,f=o(g)??0,_=e[0].x,v=c>a,b=v?this._options?.upColor||"rgba(0,255,0,0.333)":this._options?.downColor||"rgba(255,0,0,0.333)",w=v?this._options?.borderUpColor||n(b,1):this._options?.borderDownColor||n(b,1),x=v?this._options?.wickUpColor||w:this._options?.wickDownColor||w,C=e.reduce(((e,t)=>t.lineStyle??t.originalData?.lineStyle??e),this._options?.lineStyle??1),M=e.reduce(((e,t)=>t.lineWidth??t.originalData?.lineWidth??e),this._options?.lineWidth??1),S=e.reduce(((e,t)=>(t.shape?l(t.shape):t.originalData?.shape?l(t.originalData.shape):void 0)??e),this._options?.shape??r.Rectangle);return{open:h,high:y,low:f,close:d,volume:e.reduce(((e,t)=>e+(t.originalData?.volume??t.volume??0)),0),x:_,isUp:v,startIndex:t,endIndex:i,isInProgress:s,color:b,borderColor:w,wickColor:x,shape:S||r.Rectangle,lineStyle:C,lineWidth:M}}}class Jt{_data=null;_options=null;_aggregator=null;draw(e,t){e.useBitmapCoordinateSpace((e=>this._drawImpl(e,t)))}update(e,t){this._data=e,this._options=t,this._aggregator=new qt(t)}_drawImpl(e,t){if(!this._data||0===this._data.bars.length||!this._data.visibleRange||!this._options)return;const i=this._data.bars.map(((e,t)=>({open:e.originalData?.open??0,high:e.originalData?.high??0,low:e.originalData?.low??0,close:e.originalData?.close??0,volume:e.originalData?.volume??0,x:e.x,shape:e.originalData?.shape??this._options?.shape??"Rectangle",lineStyle:e.originalData?.lineStyle??this._options?.lineStyle??1,lineWidth:e.originalData?.lineWidth??this._options?.lineWidth??1,isUp:(e.originalData?.close??0)>=(e.originalData?.open??0),color:this._options?.color??"rgba(0,0,0,0)",borderColor:this._options?.borderColor??"rgba(0,0,0,0)",wickColor:this._options?.wickColor??"rgba(0,0,0,0)",startIndex:t,endIndex:t})));let o;o=this._options.dynamicCandles&&"number"==typeof this._options.volumeMALength&&"number"==typeof this._options.volumeMultiplier?this._aggregator?.dynamicAggregate(i,t)??[]:this._aggregator?.staticAggregate(i,t)??[];const n=this._options.radius,{horizontalPixelRatio:s,verticalPixelRatio:a}=e,r=this._data.barSpacing*s;this._drawCandles(e,o,this._data.visibleRange,n,r,s,a),this._drawWicks(e,o,this._data.visibleRange)}_drawWicks(e,t,i){if(null===this._data||null===this._options)return;if("3d"===this._options.shape)return;const{context:o,horizontalPixelRatio:n,verticalPixelRatio:s}=e,a=this._data.barSpacing*n,r=jt(n);for(const e of t){if(e.startIndex<i.from||e.endIndex>i.to)continue;const t=e.low*s,l=e.high*s,c=Math.min(e.open,e.close)*s,h=Math.max(e.open,e.close)*s;let d=e.x*n;const p=e.endIndex-e.startIndex;p&&p>1&&(d+=a*Math.max(1,p)/2);let u=l,m=c,g=h,y=t;"Polygon"===this._options.shape&&(m=(l+c)/2,g=(t+h)/2),o.fillStyle=e.color,o.strokeStyle=e.wickColor??e.color;const f=(e,t,i,n,s)=>{o.roundRect?o.roundRect(e,t,i,n,s):o.rect(e,t,i,n)},_=m-u;_>0&&(o.beginPath(),f(d-Math.floor(r/2),u,r,_,r/2),o.fill(),o.stroke());const v=y-g;v>0&&(o.beginPath(),f(d-Math.floor(r/2),g,r,v,r/2),o.fill(),o.stroke())}}_drawCandles(e,t,i,o,n,s,a){const{context:r}=e,l=this._options?.barSpacing??.8;r.save();for(const e of t){const t=e.endIndex-e.startIndex,c=1!==this._options?.chandelierSize?n*Math.max(1,t+1)-(1-l)*n:n*l,h=e.x*s,d=n*l;if(e.startIndex<i.from||e.endIndex>i.to)continue;const p=Math.min(e.open,e.close)*a,u=Math.max(e.open,e.close)*a,m=p-u,g=(p+u)/2,y=h-d/2,f=y+c,_=y+c/2;switch(r.fillStyle=e.color??this._options?.color??"rgba(255,255,255,1)",r.strokeStyle=e.borderColor??this._options?.borderColor??e.color??"rgba(255,255,255,1)",te(r,e.lineStyle),r.lineWidth=e.lineWidth??1,e.shape){case"Rectangle":default:N(r,y,f,g,m);break;case"Rounded":A(r,y,f,g,m,o);break;case"Ellipse":V(r,y,f,0,g,m);break;case"Arrow":G(r,y,f,_,g,m,e.high*a,e.low*a,e.isUp);break;case"3d":$(r,h,e.high*a,e.low*a,e.open*a,e.close*a,d,c,e.color??this._options?.color??"rgba(255,255,255,1)",e.borderColor??this._options?.borderColor??"rgba(255,255,255,1)",e.isUp,l);break;case"Polygon":R(r,y,f,g,m,e.high*a,e.low*a,e.isUp);break;case"Bar":B(r,y,f,e.high*a,e.low*a,e.open*a,e.close*a)}}r.restore()}}const Xt={...t.customSeriesDefaultOptions,upColor:"#008000",downColor:"#8C0000",wickVisible:!0,borderVisible:!0,borderColor:"#737375",borderUpColor:"#008000",borderDownColor:"#8C0000",wickColor:"#737375",wickUpColor:"#008000",wickDownColor:"#8C0000",radius:.6,shape:"Rounded",chandelierSize:1,barSpacing:.8,lineStyle:0,lineWidth:2,enableVolumeOpacity:!0,volumeOpacityPeriod:21,maxOpacity:.3,dynamicCandles:!1,dynamicTrigger:()=>({newBar:!0})};class Yt{_renderer;constructor(){this._renderer=new Jt}priceValueBuilder(e){return[e.high,e.low,e.close]}renderer(){return this._renderer}isWhitespace(e){return void 0===e.close}update(e,t){this._renderer.update(e,t)}defaultOptions(){return Xt}}class Kt{defaults;constructor(){this.defaults=new Map}set(e,t){let i;if("string"==typeof t)try{i=JSON.parse(t)}catch(o){console.error(`Error parsing JSON string for key "${e}":`,o),i=t}else i=t;this.defaults.set(e,i),console.log(`Default options for key "${e}" set successfully.`),console.log(i)}get(e){return this.defaults.get(e)}getAll(){return this.defaults}}x();class Zt{id;commandFunctions=[];static handlers=new Map;seriesOriginMap=new WeakMap;wrapper;div;chart;scale;precision=2;series;volumeSeries;legend;_topBar;toolBox;spinner;_seriesList=[];seriesMap=new Map;seriesMetadata;ContextMenu;currentMouseEventParams=null;defaultsManager;constructor(e,t,i,o,n){this.reSize=this.reSize.bind(this),this.id=e,this.scale={width:t,height:i},this.defaultsManager=new Kt,Zt.handlers.set(e,this),this.wrapper=document.createElement("div"),this.wrapper.classList.add("handler"),this.wrapper.style.float=o,this.div=document.createElement("div"),this.div.style.position="relative",this.wrapper.appendChild(this.div),window.containerDiv.append(this.wrapper),this.chart=this._createChart(),this.ContextMenu=new zt(this,Zt.handlers,(()=>window.MouseEventParams??null)),this.legend=new P(this),this.series=this.createCandlestickSeries(),this.volumeSeries=this.createVolumeSeries(),this.chart.subscribeCrosshairMove((e=>{this.currentMouseEventParams=e,window.MouseEventParams=e})),document.addEventListener("keydown",(e=>{for(let t=0;t<this.commandFunctions.length&&!this.commandFunctions[t](e);t++);})),window.handlerInFocus=this.id,this.wrapper.addEventListener("mouseover",(()=>{window.handlerInFocus=this.id,window.MouseEventParams=this.currentMouseEventParams||null})),this.seriesMetadata=new WeakMap,this.reSize(),n&&(window.addEventListener("resize",(()=>this.reSize())),this.chart.subscribeCrosshairMove((e=>{this.currentMouseEventParams=e})))}reSize(){let e=0!==this.scale.height&&this._topBar?._div.offsetHeight||0;this.chart.resize(window.innerWidth*this.scale.width,window.innerHeight*this.scale.height-e),this.wrapper.style.width=100*this.scale.width+"%",this.wrapper.style.height=100*this.scale.height+"%",0===this.scale.height||0===this.scale.width?this.toolBox&&(this.toolBox.div.style.display="none"):this.toolBox&&(this.toolBox.div.style.display="flex")}primitives=new Map;_createChart(){return t.createChart(this.div,{width:window.innerWidth*this.scale.width,height:window.innerHeight*this.scale.height,layout:{textColor:window.pane.color,background:{color:"#000000",type:t.ColorType.Solid},fontSize:12},rightPriceScale:{scaleMargins:{top:.3,bottom:.25}},timeScale:{timeVisible:!0,secondsVisible:!1},crosshair:{mode:t.CrosshairMode.Normal,vertLine:{labelBackgroundColor:"rgb(46, 46, 46)"},horzLine:{labelBackgroundColor:"rgb(55, 55, 55)"}},grid:{vertLines:{color:"rgba(29, 30, 38, 5)"},horzLines:{color:"rgba(29, 30, 58, 5)"}},handleScroll:{vertTouchDrag:!0}})}mergeSeriesOptions(e,t){return{...X(e),...this.defaultsManager.defaults.get(e.toLowerCase())||{},...t}}createCandlestickSeries(){const e="Candlestick",i={...X(e),...this.defaultsManager.defaults.get(e.toLowerCase())||{}},o=this.chart.addSeries(t.CandlestickSeries,i);o.priceScale().applyOptions({scaleMargins:{top:.2,bottom:.2}});const n=J(o,this.legend);n.applyOptions({title:"OHLC"}),this._seriesList.push(n),this.seriesMap.set("OHLC",n),i.upColor,i.downColor;const s={name:"OHLC",series:n,colors:[i.upColor,i.downColor],legendSymbol:["⋰","⋱"],seriesType:"Candlestick",group:void 0};return this.legend.addLegendItem(s),n}createVolumeSeries(){const e=this.chart.addSeries(t.HistogramSeries,{color:"#26a69a",priceFormat:{type:"volume"},priceScaleId:"volume_scale"});e.priceScale().applyOptions({scaleMargins:{top:.2,bottom:0}}),e.moveToPane(1);const i=J(e,this.legend);return i.applyOptions({title:"Volume"}),i}createLineSeries(e,i){const o=this.mergeSeriesOptions("Line",i),n=(()=>{switch(o.lineStyle){case 0:return"―";case 1:return":··";case 2:return"--";case 3:return"- -";case 4:return"· ·";default:return"~"}})(),{group:s,legendSymbol:a=n,...r}=o,l=J(this.chart.addSeries(t.LineSeries,r),this.legend);l.applyOptions({title:e}),this._seriesList.push(l),this.seriesMap.set(e,l);const c=l.options().color||"rgba(255,0,0,1)",h={name:e,series:l,colors:[c.startsWith("rgba")?c.replace(/[^,]+(?=\))/,"1"):c],legendSymbol:Array.isArray(a)?a:a?[a]:[],seriesType:"Line",group:s};return this.legend.addLegendItem(h),{name:e,series:l}}createHistogramSeries(e,i){const o=this.mergeSeriesOptions("Histogram",i),{group:n,legendSymbol:s="▨",...a}=o,r=J(this.chart.addSeries(t.HistogramSeries,a),this.legend);r.applyOptions({title:e}),this._seriesList.push(r),this.seriesMap.set(e,r);const l=r.options().color||"rgba(255,0,0,1)",c={name:e,series:r,colors:[l.startsWith("rgba")?l.replace(/[^,]+(?=\))/,"1"):l],legendSymbol:Array.isArray(s)?s:[s],seriesType:"Histogram",group:n};return this.legend.addLegendItem(c),{name:e,series:r}}createAreaSeries(e,i){const o=this.mergeSeriesOptions("Area",i),{group:n,legendSymbol:s="▨",...a}=o,r=J(this.chart.addSeries(t.AreaSeries,a),this.legend);this._seriesList.push(r),this.seriesMap.set(e,r);const l=r.options().lineColor||"rgba(255,0,0,1)",c={name:e,series:r,colors:[l.startsWith("rgba")?l.replace(/[^,]+(?=\))/,"1"):l],legendSymbol:Array.isArray(s)?s:s?[s]:[],seriesType:"Area",group:n};return this.legend.addLegendItem(c),{name:e,series:r}}createBarSeries(e,i){const o=this.mergeSeriesOptions("Bar",i),{group:n,legendSymbol:s=["┌","└"],...a}=o,r=J(this.chart.addSeries(t.BarSeries,a),this.legend);r.applyOptions({title:e}),this._seriesList.push(r),this.seriesMap.set(e,r);const l=r.options().upColor||"rgba(0,255,0,1)",c=r.options().downColor||"rgba(255,0,0,1)",h={name:e,series:r,colors:[l,c],legendSymbol:Array.isArray(s)?s:s?[s]:[],seriesType:"Bar",group:n};return this.legend.addLegendItem(h),{name:e,series:r}}createCustomOHLCSeries(e,t={}){const i={...Xt,...this.defaultsManager.defaults.get("ohlc")||{},...t,seriesType:"Ohlc"},{group:o,legendSymbol:n=["⑃","⑂"],chandelierSize:s=1,...a}=i,r=new Yt,l=this.chart.addCustomSeries(r,{...a,chandelierSize:s,title:e}),c=J(l,this.legend);this._seriesList.push(c),this.seriesMap.set(e,c);const h={name:e,series:c,colors:[i.borderUpColor||i.upColor,i.borderDownColor||i.downColor],legendSymbol:Array.isArray(n)?n:n?[n]:[],seriesType:"Ohlc",group:o};return this.legend.addLegendItem(h),{name:e,series:l}}createTradeSeries(e,t={}){const i={...W,...this.defaultsManager.defaults.get("trade"),...t,seriesType:"Trade"},{group:o,legendSymbol:n=["$"],...s}=i,a=new z,r=this.chart.addCustomSeries(a,s),l=J(r,this.legend);this._seriesList.push(l),this.seriesMap.set(e??"Trade",l);const c={name:e,series:l,colors:[i.backgroundColorStop,i.backgroundColorTarget],legendSymbol:Array.isArray(n)?n:[n],seriesType:"Trade",group:o};return this.legend.addLegendItem(c),{name:e,series:r}}createFillArea(e,t,i,o,n){const s=this._seriesList.find((e=>e.options()?.title===t)),a=this._seriesList.find((e=>e.options()?.title===i));if(!s)return void console.warn(`Origin series with title "${t}" not found.`);if(!a)return void console.warn(`Destination series with title "${i}" not found.`);const r=Z(s,this.legend),l=new y(s,a,{originColor:o||null,destinationColor:n||null,lineWidth:null});return r.attachPrimitive(l,e),l}attachPrimitive(e,t,i,o){let n=i;try{if(o&&!i&&(n=this.seriesMap.get(o)),!n)return void console.warn(`Series with the name "${o}" not found.`);const s=Z(n,this.legend);let a;if("Tooltip"!==t)return void console.warn(`Unknown primitive type: ${t}`);a=new je({lineColor:e}),s.attachPrimitive(a,"Tooltip"),this.primitives.set(n,a)}catch(e){console.error(`Failed to attach ${t}:`,e)}}removeSeries(e){let t;if(g(e)){for(const[i,o]of this.seriesMap.entries())if(o===e){t=i;break}}else t=e,e=this.seriesMap.get(e);if(e&&t){e.primitives&&e.primitives.length>0&&e.primitives.forEach((i=>{e.detachPrimitive(i),console.log(`✅ Detached primitive from series "${t}".`)})),this._seriesList=this._seriesList.filter((t=>t!==e)),this.seriesMap.delete(t),console.log(`✅ Series "${t}" removed from internal maps.`);try{const i=this.legend._items.find((t=>t.series===e));i?(i.primitives&&i.primitives.length>0&&i.primitives.forEach((e=>{this.legend.removeLegendPrimitive(e),console.log(`✅ Removed primitive from legend for series "${t}".`)})),this.legend.deleteLegendEntry(i.name,i.group??void 0),console.log(`✅ Removed series "${t}" from legend.`)):console.warn(`⚠️ Legend item for series "${t}" not found.`)}catch(e){console.error(`⚠️ Error removing legend entry for "${t}":`,e)}this.chart.removeSeries(e),console.log(`✅ Series "${t}" successfully removed.`)}else console.warn(`❌ Series "${e}" does not exist and cannot be removed.`)}createToolBox(){this.toolBox=new Ae(this,this.id,this.chart,this.series,this.commandFunctions),this.div.appendChild(this.toolBox.div)}createTopBar(){return this._topBar=new $e(this),this.wrapper.prepend(this._topBar._div),this._topBar}extractSeriesData(e){const t=e.data();return Array.isArray(t)?t.map((e=>[e.time,e.value||e.close||0])):(console.warn("Failed to extract data: series data is not in array format."),[])}static syncCharts(e,t,i=!1){function o(e,t){t?(e.chart.setCrosshairPosition(t.value||t.close,t.time,e.series),e.legend.legendHandler(t,!0)):e.chart.clearCrosshairPosition()}function n(e,t){return t.time&&t.seriesData.get(e)||null}const s=e.chart.timeScale(),a=t.chart.timeScale(),r=e=>{e&&s.setVisibleLogicalRange(e)},l=e=>{e&&a.setVisibleLogicalRange(e)},c=i=>{o(t,n(e.series,i))},h=i=>{o(e,n(t.series,i))};let d=t;function p(e,t,o,n,s,a){e.wrapper.addEventListener("mouseover",(()=>{d!==e&&(d=e,t.chart.unsubscribeCrosshairMove(o),e.chart.subscribeCrosshairMove(n),i||(t.chart.timeScale().unsubscribeVisibleLogicalRangeChange(s),e.chart.timeScale().subscribeVisibleLogicalRangeChange(a)))}))}p(t,e,c,h,l,r),p(e,t,h,c,r,l),t.chart.subscribeCrosshairMove(h);const u=a.getVisibleLogicalRange();u&&s.setVisibleLogicalRange(u),i||t.chart.timeScale().subscribeVisibleLogicalRangeChange(r)}static makeSearchBox(e){const t=document.createElement("div");t.classList.add("searchbox"),t.style.display="none";const i=document.createElement("div");i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1"><path style="fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke:lightgray;stroke-opacity:1;stroke-miterlimit:4;" d="M 15 15 L 21 21 M 10 17 C 6.132812 17 3 13.867188 3 10 C 3 6.132812 6.132812 3 10 3 C 13.867188 3 17 6.132812 17 10 C 17 13.867188 13.867188 17 10 17 Z M 10 17 "/></svg>';const o=document.createElement("input");return o.type="text",t.appendChild(i),t.appendChild(o),e.div.appendChild(t),e.commandFunctions.push((i=>window.handlerInFocus===e.id&&!window.textBoxFocused&&("none"===t.style.display?!!/^[a-zA-Z0-9]$/.test(i.key)&&(t.style.display="flex",o.focus(),!0):("Enter"===i.key||"Escape"===i.key)&&("Enter"===i.key&&window.callbackFunction(`search${e.id}_~_${o.value}`),t.style.display="none",o.value="",!0)))),o.addEventListener("input",(()=>o.value=o.value.toUpperCase())),{window:t,box:o}}static makeSpinner(e){e.spinner=document.createElement("div"),e.spinner.classList.add("spinner"),e.wrapper.appendChild(e.spinner);let t=0;!function i(){e.spinner&&(t+=10,e.spinner.style.transform=`translate(-50%, -50%) rotate(${t}deg)`,requestAnimationFrame(i))}()}static _styleMap={"--bg-color":"backgroundColor","--hover-bg-color":"hoverBackgroundColor","--click-bg-color":"clickBackgroundColor","--active-bg-color":"activeBackgroundColor","--muted-bg-color":"mutedBackgroundColor","--border-color":"borderColor","--color":"color","--active-color":"activeColor"};static setRootStyles(e){const t=document.documentElement.style;for(const[i,o]of Object.entries(this._styleMap))t.setProperty(i,e[o])}toJSON(){return{id:this.id,options:this.chart.options(),scale:this.scale,precision:this.precision}}fromJSON(e){e?(e.options&&this.chart.applyOptions(e.options),void 0!==e.scale&&(this.scale=e.scale),void 0!==e.precision&&(this.precision=e.precision)):console.warn("No JSON data provided for handler deserialization.")}_type="chart";title="Lightweight-Charts"}return e.Box=we,e.FillArea=y,e.Handler=Zt,e.HorizontalLine=Se,e.Legend=P,e.RayLine=ke,e.Table=class{_div;callbackName;borderColor;borderWidth;table;rows={};headings;widths;alignments;footer;header;constructor(e,t,i,o,n,s,a=!1,r,l,c,h,d){this._div=document.createElement("div"),this.callbackName=null,this.borderColor=l,this.borderWidth=c,a?(this._div.style.position="absolute",this._div.style.cursor="move"):(this._div.style.position="relative",this._div.style.float=s),this._div.style.zIndex="2000",this.reSize(e,t),this._div.style.display="flex",this._div.style.flexDirection="column",this._div.style.borderRadius="5px",this._div.style.color="white",this._div.style.fontSize="12px",this._div.style.fontVariantNumeric="tabular-nums",this.table=document.createElement("table"),this.table.style.width="100%",this.table.style.borderCollapse="collapse",this._div.style.overflow="hidden",this.headings=i,this.widths=o.map((e=>100*e+"%")),this.alignments=n;let p=this.table.createTHead().insertRow();for(let e=0;e<this.headings.length;e++){let t=document.createElement("th");t.textContent=this.headings[e],t.style.width=this.widths[e],t.style.letterSpacing="0.03rem",t.style.padding="0.2rem 0px",t.style.fontWeight="500",t.style.textAlign="center",0!==e&&(t.style.borderLeft=c+"px solid "+l),t.style.position="sticky",t.style.top="0",t.style.backgroundColor=d.length>0?d[e]:r,t.style.color=h[e],p.appendChild(t)}let u,m,g=document.createElement("div");if(g.style.overflowY="auto",g.style.overflowX="hidden",g.style.backgroundColor=r,g.appendChild(this.table),this._div.appendChild(g),window.containerDiv.appendChild(this._div),!a)return;let y=e=>{this._div.style.left=e.clientX-u+"px",this._div.style.top=e.clientY-m+"px"},f=()=>{document.removeEventListener("mousemove",y),document.removeEventListener("mouseup",f)};this._div.addEventListener("mousedown",(e=>{u=e.clientX-this._div.offsetLeft,m=e.clientY-this._div.offsetTop,document.addEventListener("mousemove",y),document.addEventListener("mouseup",f)}))}divToButton(e,t){e.addEventListener("mouseover",(()=>e.style.backgroundColor="rgba(60, 60, 60, 0.6)")),e.addEventListener("mouseout",(()=>e.style.backgroundColor="transparent")),e.addEventListener("mousedown",(()=>e.style.backgroundColor="rgba(60, 60, 60)")),e.addEventListener("click",(()=>window.callbackFunction(t))),e.addEventListener("mouseup",(()=>e.style.backgroundColor="rgba(60, 60, 60, 0.6)"))}newRow(e,t=!1){let i=this.table.insertRow();i.style.cursor="default";for(let o=0;o<this.headings.length;o++){let n=i.insertCell();n.style.width=this.widths[o],n.style.textAlign=this.alignments[o],n.style.border=this.borderWidth+"px solid "+this.borderColor,t&&this.divToButton(n,`${this.callbackName}_~_${e};;;${this.headings[o]}`)}t||this.divToButton(i,`${this.callbackName}_~_${e}`),this.rows[e]=i}deleteRow(e){this.table.deleteRow(this.rows[e].rowIndex),delete this.rows[e]}clearRows(){let e=Object.keys(this.rows).length;for(let t=0;t<e;t++)this.table.deleteRow(-1);this.rows={}}_getCell(e,t){return this.rows[e].cells[this.headings.indexOf(t)]}updateCell(e,t,i){this._getCell(e,t).textContent=i}styleCell(e,t,i,o){this._getCell(e,t).style[i]=o}makeSection(e,t,i,o=!1){let n=document.createElement("div");n.style.display="flex",n.style.width="100%",n.style.padding="3px 0px",n.style.backgroundColor="rgb(30, 30, 30)","footer"===t?this._div.appendChild(n):this._div.prepend(n);const s=[];for(let t=0;t<i;t++){let i=document.createElement("div");n.appendChild(i),i.style.flex="1",i.style.textAlign="center",o&&(this.divToButton(i,`${e}_~_${t}`),i.style.borderRadius="2px"),s.push(i)}"footer"===t?this.footer=s:this.header=s}reSize(e,t){this._div.style.width=e<=1?100*e+"%":e+"px",this._div.style.height=t<=1?100*t+"%":t+"px"}},e.ToolBox=Ae,e.TooltipPrimitive=je,e.TopBar=$e,e.TrendLine=fe,e.VerticalLine=Le,e.closedEye=M,e.defaultFillAreaOptions=v,e.globalParamInit=x,e.ohlcSeries=Yt,e.ohlcdefaultOptions=Xt,e.openEye=C,e.paneStyleDefault=w,e.setCursor=e=>{e&&(window.cursor=e),document.body.style.cursor=window.cursor},e}({},LightweightCharts);
